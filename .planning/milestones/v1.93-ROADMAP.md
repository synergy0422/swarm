# Milestone v1.93: 主脑自然语言派发闭环

**Status:** Planned  
**Defined:** 2026-02-06  
**Execution:** 由其他 Agent 实施  
**Final Review:** Codex

---

## Phase 1: 根因定位与证据化（Debug First）

**Goal:** 在不盲修的前提下，定位“只主脑回复、worker不执行”的确定性根因。  
**Method:** 遵循 `systematic-debugging`，先证据后改动。

### Tasks
- [ ] P1-01 建立最小复现脚本（启动 session -> 启动 bridge -> 注入 1 条 TASK -> 抓取 3 类日志）。
- [ ] P1-02 分层证据采集：
  - 输入层：master pane 捕获是否包含目标行。
  - 解析层：Bridge parser 是否命中。
  - 派发层：send-keys 到目标 pane 是否成功。
  - 执行层：worker 是否 ACK、是否输出响应。
- [ ] P1-03 输出《根因报告》：单一主因 + 次要诱因 + 排除项。

### Exit Criteria
- [ ] 有一份可复现实验记录，不依赖“人工看起来像”判断。

---

## Phase 2: 协议补全（ACK + 重试 + 超时）

**Goal:** 建立 direct dispatch 的可靠闭环。

### Tasks
- [ ] P2-01 引入 `bridge_task_id` 并贯穿日志。
- [ ] P2-02 规范 worker 注入文本格式（单行）。
- [ ] P2-03 增加 ACK 检测逻辑（capture-pane 匹配）。
- [ ] P2-04 实现超时与重试策略（同 worker 重试 N 次 -> 换 worker）。
- [ ] P2-05 最终失败落库（FAILED + reason）。

### Exit Criteria
- [ ] 在“一个 worker 不响应”场景下仍能完成任务派发或给出可解释失败。

---

## Phase 3: 可观测性与运维命令

**Goal:** 让问题可见、可排障、可审核。

### Tasks
- [ ] P3-01 `bridge.log` 增加阶段事件（CAPTURED/PARSED/DISPATCHED/ACKED/RETRY/FAILED）。
- [ ] P3-02 `status.log` 标准化字段：
  - `meta.type=BRIDGE`
  - `meta.bridge_task_id`
  - `meta.target_worker`
  - `meta.attempt`
- [ ] P3-03 增加快速诊断命令（脚本或现有命令增强）：
  - 查看最近 N 条桥接任务全链路状态。

### Exit Criteria
- [ ] 运维人员可在 2 分钟内定位“卡在哪一层”。

---

## Phase 4: E2E 验收与文档收敛

**Goal:** 交付稳定版本并可由他人接手运维。

### Tasks
- [ ] P4-01 新增/更新自动化测试：
  - parser 前缀兼容测试（含 `❯ TASK:`）
  - direct dispatch + ACK 流程测试
  - retry/failover 测试
- [ ] P4-02 手工 E2E 记录（3 条任务 + 1 条故障注入）。
- [ ] P4-03 文档更新：README、docs/SCRIPTS、CHANGELOG。

### Exit Criteria
- [ ] 验收场景 A/B/C 全通过（见 v1.93 requirements）。

---

## 执行交付物（给执行 Agent）

- 代码变更
- 测试结果（命令+输出摘要）
- 根因报告（1 页）
- 运维说明（启动、排查、回滚）

---

## Codex 审核流程（你交给我复核时用）

1. **先看证据**：是否有分层实验记录与根因结论。  
2. **再看实现**：协议是否闭环，是否过度设计。  
3. **再跑验收**：A/B/C 三场景必须实测。  
4. **最后看文档**：是否与实际行为一致。  

若以上任一项不通过，退回执行 Agent 修正，不进入发布。

