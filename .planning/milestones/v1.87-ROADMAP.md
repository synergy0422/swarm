# Milestone v1.87: 强化指挥官可感知能力

**Status:** ✅ SHIPPED 2026-02-04
**Phases:** 27-29
**Total Plans:** 4

## Overview

v1.87 专注于增强 Master（指挥官）的可感知能力，通过三个方面的改进：
1. 状态汇总表增强 — 新增时间戳字段显示状态持续时间
2. 自动救援策略可配置化 — 支持环境变量控制救援行为
3. 任务指派回执闭环 — 形成清晰状态链 ASSIGNED → START → DONE/ERROR

## Phases

### Phase 27: 状态汇总表增强

**Goal:** 增强状态汇总表，新增 last_update / wait_for / error_streak 字段，提升指挥官感知能力

**Plans:**

- [x] 27-01: 状态汇总表增强实现

**Details:**

**验收标准:**
- 状态汇总表包含新增 3 个字段（last_update, wait_for, error_streak）
- WAIT 时长准确累计
- ERROR 连续次数正确计数

**技术路径:**
- 复用 PaneSummary 增加字段：last_update_ts, wait_since_ts, error_streak
- 状态变化时维护时间戳
- 进入 WAIT 时记录 wait_since_ts
- 进入 ERROR 时 error_streak += 1，其他状态重置为 0
- 汇总表格式化时显示：last_update 为 YYYY-MM-DD HH:MM:SS 或 ago
- wait_for 显示持续等待时长（秒或分钟）

---

### Phase 28: 自动救援策略可配置化

**Goal:** 通过环境变量配置自动救援行为，支持启用开关、白名单、黑名单

**Plans:**

- [x] 28-01: 自动救援策略配置实现
- [x] 28-02: Master 状态联动修复

**Details:**

#### 28-01: 自动救援策略配置实现

**验收标准:**
- AI_SWARM_AUTO_RESCUE_ENABLED=false 关闭后不会 send-keys
- ALLOW/BLOCK 正则生效且优先级正确
- 默认行为不变（不设置时仍用内置模式）

**技术路径:**
- 复用 AutoRescuer 读取环境变量
- AI_SWARM_AUTO_RESCUE_ENABLED=false → 返回 (False,'disabled','')
- BLOCK 命中 → blocked_by_config
- ALLOW 设置且未命中 → allowlist_missed
- 环境变量读取集中在 AutoRescuer.__init__

#### 28-02: Master 状态联动修复

**验收标准:**
- blocked_by_config action 在 summary 中显示 WAIT 状态 + note
- allowlist_missed action 在 summary 中显示 WAIT 状态 + note
- disabled action 在 summary 中显示 IDLE 状态 + [AUTO-RESCUE DISABLED] note

**技术路径:**
- 复用 _handle_pane_wait_states() 增加对 blocked_by_config/allowlist_missed/disabled 的处理

---

### Phase 29: 任务指派回执闭环

**Goal:** Master 分配任务时写 ASSIGNED，形成状态链 ASSIGNED → START → DONE/ERROR

**Plans:**

- [x] 29-01: 任务指派状态广播

**Details:**

**验收标准:**
- dispatch_one() 广播 ASSIGNED 状态（而非 START）
- status.log 显示纯 ASSIGNED 状态（无 meta.event）
- 状态链：ASSIGNED (master) → START (worker) → DONE/ERROR (worker)
- ASSIGNED 在状态优先级中位于 START 和 DONE 之间

**技术路径:**
- 修改 master_dispatcher.py dispatch_one() 使用 BroadcastState.ASSIGNED
- 在 master.py STATE_PRIORITY 添加 ASSIGNED: 4
- 添加测试验证 ASSIGNED 状态广播

---

## Milestone Summary

### Key Decisions

- Decision: Pure ASSIGNED state without meta.event (Simpler state semantics)
- Decision: Config priority ENABLED > BLOCK > ALLOW > existing patterns (Clear precedence)
- Decision: ASSIGNED priority 4 (between START and DONE) for proper summary ordering

### Issues Resolved

- Fixed test isolation issue for AI_SWARM_DIR in dispatcher tests
- Fixed UTC vs local timezone in timestamp formatting
- Fixed test sleep timing for stable CI execution

### Technical Debt Incurred

- None — all work completed as planned

---

_For current project status, see .planning/ROADMAP.md_

---

_Last updated: 2026-02-04 after v1.87 milestone_
