# Milestone v1.5: 状态广播闭环 + 自动救援 + 维护性改进

**Status:** ✅ SHIPPED 2026-02-02
**Phases:** 15-17
**Total Plans:** 3

## Overview

v1.5 milestone delivers script-level enhancements for the AI Swarm system:
- Unified configuration (`_common.sh`) for all scripts
- Auto-rescue capabilities (`claude_auto_rescue.sh`) for prompt handling
- Status broadcasting (`swarm_broadcast.sh`) for worker lifecycle tracking
- Documentation (`CONTRIBUTING.md`) for script conventions

## Phases

### Phase 15: _common.sh ✓ COMPLETE

**Goal:** Create unified configuration script with shared variables and output formatting

**Dependencies:** None (foundational phase)

**Requirements:** DOCS-01

**Plans:**
- [x] 15-01: Create scripts/_common.sh and update all existing scripts

**Details:**

Created `scripts/_common.sh` (19 lines) providing:
- Source guard to prevent direct execution
- `SWARM_STATE_DIR` export (default: `/tmp/ai_swarm`)
- `SESSION_NAME` export (with CLAUDE_SESSION fallback)
- `log_info()`, `log_warn()`, `log_error()` to stderr

Updated 6 existing scripts to source `_common.sh`:
- claude_comm.sh, claude_poll.sh, claude_status.sh
- swarm_status_log.sh, swarm_lock.sh, swarm_e2e_test.sh

---

### Phase 16: Auto-Rescue ✓ COMPLETE

**Goal:** Implement automatic confirmation for [y/n] and Press Enter patterns

**Dependencies:** Phase 15 (_common.sh for shared config)

**Requirements:** RESC-01, RESC-02, RESC-03, RESC-04

**Plans:**
- [x] 16-01: Create claude_auto_rescue.sh with check/run/status commands

**Details:**

Created `scripts/claude_auto_rescue.sh` (300+ lines) with:

1. **Pattern Detection (3 priority levels):**
   - Priority 1 (Dangerous - BLOCK): rm -rf, DROP, DELETE, sudo, password
   - Priority 2 (Prompts - AUTO-CONFIRM): [y/n], press enter, 回车继续
   - Priority 3 (Confirmations - AUTO-CONFIRM): confirm, continue, proceed, yes

2. **Worker-Only Restriction:**
   - Only affects worker-0/1/2 windows
   - Master window explicitly excluded

3. **30-Second Cooldown:**
   - Per-window cooldown tracking
   - Files: `${SWARM_STATE_DIR}/.auto_rescue_last_action_${window}`

4. **Commands:**
   - `check` - One-time scan and auto-confirm
   - `run` - Continuous monitoring loop (2s poll)
   - `status` - Display last action timestamps

---

### Phase 17: Status Broadcast ✓ COMPLETE

**Goal:** Worker automatically writes status entries at key lifecycle points

**Dependencies:** Phase 15 (_common.sh for shared config)

**Requirements:** AUTO-01, AUTO-02, AUTO-03, DOCS-02

**Plans:**
- [x] 17-01: Create swarm_broadcast.sh and CONTRIBUTING.md

**Details:**

Created `scripts/swarm_broadcast.sh` (178 lines) with:
- Commands: `start`, `done`, `error`, `wait` for status broadcasting
- Auto-detects worker window from TMUX using `tmux display-message`
- Validates worker-0/1/2 only
- Delegates to `swarm_status_log.sh append` internally (no timestamp duplication)
- Sources `_common.sh` for logging

Created `CONTRIBUTING.md` (332 lines) documenting:
- Script conventions (_common.sh, logging, error handling)
- Status broadcasting usage (swarm_broadcast.sh, swarm_status_log.sh)
- Testing requirements for new scripts
- Development workflow and tmux setup

---

## Milestone Summary

**Decimal Phases:** None

**Key Decisions:**
- Phase 15: _common.sh before other phases — Foundational configuration needed by all scripts
- Phase 16: Auto-Rescue after _common.sh — Uses shared config for output formatting
- Phase 17: Status Broadcast after _common.sh — Uses shared config for consistent logging
- Phase 16-01: Removed done/ready/ok patterns — Too broad, caused false positives
- Phase 16-01: Case-insensitive matching — Handles varied capitalization
- Phase 16-01: Dangerous patterns checked first — Safety over convenience

**Issues Resolved:**
- All v1.5 requirements delivered (9/9 complete)
- Code review passed for all 4 components
- No deviations from plan during execution

**Technical Debt Incurred:**
- None identified

---

_For current project status, see .planning/ROADMAP.md_

---

*Archived: 2026-02-02 as part of v1.5 milestone completion*
