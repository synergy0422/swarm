# Requirements: AI Swarm v1.93 主脑自然语言派发闭环

**Defined:** 2026-02-06  
**Owner:** 执行由其他 Agent 完成；最终审核由 Codex 负责  
**Reference:** `/home/user/projects/group/AI蜂群协作-tmux多Agent协作系统.md`

---

## 1. 背景与问题

V1.92 目标是：
- tmux 第 1 页：`codex + master(Claude Code)`
- tmux 第 2 页：`worker-0/1/2(Claude Code)`
- 任务入口：在 `master` 聊天框输入自然语言（如 `TASK: ...`）后，自动派发给 workers。

当前症状：
- `master` 会响应 `TASK: ...`，但 worker 未稳定进入执行闭环（看起来“只有主脑在回复”）。

已确认事实（作为 V1.93 输入）：
- Bridge 可启动，且可记录 `dispatched_direct`。
- Bridge 解析曾受提示符前缀影响（如 `❯ TASK: ...`），已修正。
- 当前仍缺少“可观测、可验证、可重试”的派发闭环保障。

---

## 2. 目标（Must Have）

- [ ] **V193-01 输入捕获稳定**：`master` 输入 `TASK: ...` 必须被 Bridge 稳定识别（含 `❯` 等提示符前缀）。
- [ ] **V193-02 派发可达验证**：Bridge 向 worker 发送后，必须拿到 worker 侧 ACK（超时则重试/换 worker）。
- [ ] **V193-03 执行可见性**：每次任务的 `captured -> dispatched -> ack -> started -> done/error` 全链路可追踪。
- [ ] **V193-04 失败可恢复**：若 worker 无响应，支持有限重试、切换 worker，并记录失败原因。
- [ ] **V193-05 会话/窗格安全性**：默认配置必须匹配 V1.92 的 session/window，避免“桥接到了错误 pane”。

---

## 3. 非目标（Out of Scope）

- 不改为分布式多机架构。
- 不引入 Web 控制台。
- 不重写 Claude Code 本体行为（仅基于 tmux `capture-pane/send-keys`）。

---

## 4. 技术路径（严格对齐参考文档）

参考文档核心三件套：
1. `capture-pane` 感知
2. `send-keys` 控制
3. 共享状态日志协调

V1.93 必须沿此路径落地，不引入偏离主路径的新通讯栈。

---

## 5. 需求细化

### 5.1 Bridge 协议与行为

- [ ] **B-01** 支持 `TASK:` 语法（允许前导提示符，如 `❯`）。
- [ ] **B-02** 任务 ID 化：Bridge 为每条任务生成 `bridge-task-id`（可复现追踪）。
- [ ] **B-03** `dispatch_mode` 明确：
  - `fifo`（有 Python master reader 时）
  - `direct`（无 FIFO reader 时，直接派发 worker pane）
- [ ] **B-04** direct 模式下采用 Round-Robin 选 worker。
- [ ] **B-05** 派发后等待 ACK（例如 worker 回显 `[ACK] <bridge-task-id>`），超时则重试。

### 5.2 Worker 接收协议

- [ ] **W-01** 定义 worker 注入格式（单行，避免多行误解析）。
- [ ] **W-02** worker 收到后需快速回显 ACK 标记。
- [ ] **W-03** 若 worker 不可用（未就绪/卡住），Bridge 记录并切换下一个 worker。

### 5.3 可观测性

- [ ] **O-01** `bridge.log` 增加结构化阶段日志：`CAPTURED / PARSED / DISPATCHED / ACKED / RETRY / FAILED`。
- [ ] **O-02** `status.log` 保留 JSONL，`meta.type=BRIDGE`，附 `bridge_task_id`、`target_worker`、`attempt`。
- [ ] **O-03** 提供一条命令快速看闭环：最近 N 条任务阶段摘要。

### 5.4 安全与兼容

- [ ] **S-01** 默认 session 为 `swarm-claude-default`。
- [ ] **S-02** 若多 pane 且未显式配置 `AI_SWARM_BRIDGE_PANE`，启动即失败并给出纠错提示。
- [ ] **S-03** 保留旧脚本入口兼容（不破坏已有命令习惯）。

---

## 6. 验收标准（必须全部通过）

### 验收场景 A：单任务闭环

1. 在 master 输入：`TASK: 请只回复"received"`  
2. 60 秒内可观察到：
   - Bridge 识别并派发
   - 某个 worker ACK
   - 同一 worker 出现实际回复（非仅显示注入文本）

### 验收场景 B：连续三任务

输入 3 条不同任务后，worker 分配符合 Round-Robin（或配置策略），且每条都有独立 task-id 轨迹。

### 验收场景 C：异常恢复

人为让一个 worker 无响应，系统可在超时后重试/切换并完成派发，日志可解释。

---

## 7. 审核门禁（Codex Review Gate）

执行 Agent 提交后，必须提供：
- 代码 diff
- 端到端日志证据（含 bridge/status/worker pane 截取）
- 失败场景复现实验记录
- 回滚方案

Codex 按以下门禁审核：
- [ ] 协议一致性（输入、ACK、状态字段一致）
- [ ] 可观测性完整（能回答“任务去了谁、何时失败、为何重试”）
- [ ] 回归风险（不破坏 `run_claude_swarm.sh` 与 `swarm_layout_2windows.sh`）
- [ ] 文档一致性（README/docs/SCRIPTS/CHANGELOG）

