---
phase: 10-4窗口-claude-cli-启动
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can run run_claude_swarm.sh and see 4 tmux windows created"
    - "All 4 windows (master, worker-0, worker-1, worker-2) have Claude CLI running"
    - "Script respects --attach/--no-attach flags with correct default"
    - "Working directory is configurable via environment or CLI argument"
  artifacts:
    - path: "/home/user/projects/AAA/swarm/run_claude_swarm.sh"
      provides: "tmux session creator with 4 Claude CLI windows"
      min_lines: 80
  key_links:
    - from: "/home/user/projects/AAA/swarm/run_claude_swarm.sh"
      to: "tmux"
      via: "new-session, new-window, send-keys commands"
      pattern: "tmux (new-session|new-window|send-keys|attach)"
---

<objective>
Create `run_claude_swarm.sh` script that launches 4 tmux windows (master, worker-0, worker-1, worker-2) each running Claude CLI.

Purpose: Enable multi-window Claude Code CLI sessions for parallel agent coordination
Output: Executable bash script at `/home/user/projects/AAA/swarm/run_claude_swarm.sh`
</objective>

<execution_context>
@/home/user/.claude/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/10-4窗口-claude-cli-启动/10-CONTEXT.md

**Key decisions from CONTEXT.md:**
- Session name: `swarm-claude-default`
- Working directory: configurable, default `/home/user/projects/AAA/swarm`
- Attach: `--attach`/`--no-attach` flags, default attach
- Dependency check: only verify `claude` CLI is available
- Focus: master window after startup
</context>

<tasks>

<task type="auto">
  <name>Create run_claude_swarm.sh script</name>
  <files>/home/user/projects/AAA/swarm/run_claude_swarm.sh</files>
  <action>
Create bash script with the following features:

1. **Header and help:**
   - Shebang: `#!/usr/bin/env bash`
   - `set -euo pipefail` for error handling
   - Help text explaining usage and flags

2. **Configuration variables:**
   - `SESSION_NAME="swarm-claude-default"`
   - `WORKDIR="${SWARM_WORKDIR:-/home/user/projects/AAA/swarm}"` (configurable via env var or --workdir flag)
   - Parse `--workdir` / `-d` CLI argument to override

3. **Dependency check:**
   - `command -v claude >/dev/null || exit 1` with error message
   - Only check claude CLI availability

4. **Attach flag parsing:**
   - `--attach` (default): attach to tmux session after creation
   - `--no-attach`: create session but don't attach

5. **Tmux session creation:**
   - Create detached session: `tmux new-session -d -s "$SESSION_NAME" -n master`
   - Create worker windows: `tmux new-window -n "worker-N" -t "$SESSION_NAME"` for N=0,1,2
   - Launch claude in each window: `cd $WORKDIR && claude` using `tmux send-keys -t "$SESSION_NAME:window" "cd $WORKDIR && claude" Enter`

6. **Attach behavior:**
   - If `--attach` (default): `tmux attach-session -t "$SESSION_NAME"`
   - If `--no-attach`: print session info and exit 0

7. **Cleanup/safety:**
   - Check if session already exists before creating
   - Provide clear output about what was created

Script style reference: Follow patterns from `run_swarm_local_proxy.sh` for output format.
  </action>
  <verify>
chmod +x /home/user/projects/AAA/swarm/run_claude_swarm.sh && /home/user/projects/AAA/swarm/run_claude_swarm.sh --help
  </verify>
  <done>
Script exists at /home/user/projects/AAA/swarm/run_claude_swarm.sh, is executable, and --help displays usage information
  </done>
</task>

<task type="checkpoint:human-verify">
  <name>Verify 4 windows created with Claude CLI</name>
  <what-built>
Script that creates tmux session `swarm-claude-default` with 4 windows:
- master (focused)
- worker-0
- worker-1
- worker-2
Each window runs Claude CLI.
  </what-built>
  <how-to-verify>
Execute the following verification steps:

1. **Run the script:**
   ```bash
   cd /home/user/projects/AAA/swarm
   ./run_claude_swarm.sh --no-attach
   ```

2. **Check windows created:**
   ```bash
   tmux list-windows -t swarm-claude-default
   ```
   Expected output shows 4 windows with names: master, worker-0, worker-1, worker-2

3. **Check Claude is running in each window:**
   ```bash
   # Option A: Check pane command (may show bash if claude is child process)
   tmux list-panes -t swarm-claude-default -F '#{window_name}: #{pane_current_command}'

   # Option B: Check pane content (more reliable - looks for claude output)
   for win in master worker-0 worker-1 worker-2; do
     output=$(tmux capture-pane -t "swarm-claude-default:$win" -p)
     if echo "$output" | grep -q "Claude"; then
       echo "$win: Claude detected ✓"
     else
       echo "$win: Claude not detected (checking again...)"
     fi
   done
   ```

4. **Test attach mode:**
   ```bash
   ./run_claude_swarm.sh
   ```
   Should attach to tmux session. Press Ctrl+b d to detach.

5. **Cleanup:**
   ```bash
   tmux kill-session -t swarm-claude-default
   ```
  </how-to-verify>
  <resume-signal>Type "approved" to confirm 4 Claude CLI windows are visible, or describe any issues
  </resume-signal>
</task>

</tasks>

<verification>
**Script-level verification:**
- Script is executable: `test -x /home/user/projects/AAA/swarm/run_claude_swarm.sh`
- Script passes shellcheck (optional): `shellcheck /home/user/projects/AAA/swarm/run_claude_swarm.sh`
- Help output displays: `./run_claude_swarm.sh --help`

**Functional verification (via checkpoint):**
- `tmux list-windows -t swarm-claude-default` shows 4 windows
- `tmux list-panes -t swarm-claude-default` shows claude running in each
- Script respects --attach/--no-attach flags
- Script respects --workdir / -d override
</verification>

<success_criteria>
- [ ] `/home/user/projects/AAA/swarm/run_claude_swarm.sh` exists and is executable
- [ ] Running script creates tmux session `swarm-claude-default`
- [ ] Session has 4 windows: master, worker-0, worker-1, worker-2
- [ ] Each window runs Claude CLI
- [ ] `--attach`/`--no-attach` flags work correctly
- [ ] Working directory configurable via `--workdir` / `-d` flag
- [ ] Phase 10 complete marker in STATE.md
</success_criteria>

<output>
After completion, create `.planning/phases/10-4窗口-claude-cli-启动/10-01-SUMMARY.md`
</output>
