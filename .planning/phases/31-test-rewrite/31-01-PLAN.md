---
wave: 1
depends_on: []
files_modified:
  - tests/test_auto_rescuer.py
  - tests/test_auto_rescuer_patterns.py
  - tests/test_e2e_auto_rescue.py
autonomous: true
---

## 重写 AutoRescuer 测试以适配新 API

### 目标

修复 ImportError：重写测试文件，使用新的 AutoRescuer API

### 验收标准 (must_haves)

- [ ] `pytest -q tests/test_auto_rescuer.py` 收集成功
- [ ] `pytest -q tests/test_auto_rescuer_patterns.py` 收集成功
- [ ] `pytest -q tests/test_e2e_auto_rescue.py` 收集成功
- [ ] 所有测试通过

### 执行步骤

#### Step 1: 重写 test_auto_rescuer.py

重写为测试 AutoRescuer 主类：

```python
from swarm.auto_rescuer import AutoRescuer

class TestAutoRescuer(unittest.TestCase):
    def setUp(self):
        self.rescuer = AutoRescuer(tmux_manager=None, dry_run=True)

    def test_auto_enter_patterns(self):
        """测试 Press Enter 模式检测"""
        test_cases = [
            ("Press ENTER to continue...", True, 'auto_enter'),
            ("按回车继续", True, 'auto_enter'),
            ("hit enter to proceed", True, 'auto_enter'),
        ]
        for output, should_rescue, expected_action in test_cases:
            rescue, action, pattern = self.rescuer.check_and_rescue(output, 'test', 'session')
            self.assertEqual(action, expected_action)

    def test_manual_confirm_patterns(self):
        """测试 y/n, confirm 模式"""
        test_cases = [
            "Do you want to continue? [y/n]",
            "Please confirm your choice",
        ]
        for output in test_cases:
            rescue, action, pattern = self.rescuer.check_and_rescue(output, 'test', 'session')
            self.assertEqual(action, 'manual_confirm_needed')

    def test_dangerous_patterns(self):
        """测试危险命令黑名单"""
        test_cases = [
            "rm -rf /tmp/data",
            "DROP DATABASE production",
        ]
        for output in test_cases:
            rescue, action, pattern = self.rescuer.check_and_rescue(output, 'test', 'session')
            self.assertEqual(action, 'dangerous_blocked')

    def test_no_pattern_returns_none(self):
        """无模式匹配返回 none"""
        output = "Normal output without prompts"
        rescue, action, pattern = self.rescuer.check_and_rescue(output, 'test', 'session')
        self.assertEqual(action, 'none')

    def test_cooldown_mechanism(self):
        """测试冷却机制"""
        rescuer = AutoRescuer(tmux_manager=None, cooling_time=1.0, dry_run=True)
        # 第一次触发
        rescue, action, pattern = rescuer.check_and_rescue("Press ENTER", 'win1', 'session')
        self.assertTrue(rescue)
        # 冷却中再次触发
        rescue2, action2, _ = rescuer.check_and_rescue("Press ENTER", 'win1', 'session')
        self.assertEqual(action2, 'cooldown')
        # 冷却结束后
        time.sleep(1.1)
        rescue3, action3, _ = rescuer.check_and_rescue("Press ENTER", 'win1', 'session')
        self.assertTrue(rescue3)

    def test_disabled_via_env(self):
        """测试环境变量禁用"""
        import os
        os.environ['AI_SWARM_AUTO_RESCUE_ENABLED'] = 'false'
        try:
            rescuer = AutoRescuer(dry_run=True)
            rescue, action, _ = rescuer.check_and_rescue("Press ENTER", 'test', 'session')
            self.assertEqual(action, 'disabled')
        finally:
            del os.environ['AI_SWARM_AUTO_RESCUE_ENABLED']

    def test_blocklist_config(self):
        """测试 AI_SWARM_AUTO_RESCUE_BLOCK 配置"""
        import os
        os.environ['AI_SWARM_AUTO_RESCUE_BLOCK'] = 'special'
        try:
            rescuer = AutoRescuer(dry_run=True)
            rescue, action, _ = rescuer.check_and_rescue("special content here", 'test', 'session')
            self.assertEqual(action, 'blocked_by_config')
        finally:
            del os.environ['AI_SWARM_AUTO_RESCUE_BLOCK']

    def test_allowlist_config(self):
        """测试 AI_SWARM_AUTO_RESCUE_ALLOW 配置"""
        import os
        os.environ['AI_SWARM_AUTO_RESCUE_ALLOW'] = 'special.*pattern'
        try:
            rescuer = AutoRescuer(dry_run=True)
            # 匹配
            rescue, action, _ = rescuer.check_and_rescue("special content pattern", 'test', 'session')
            self.assertEqual(action, 'auto_enter')
            # 不匹配
            rescue2, action2, _ = rescuher.check_and_rescue("other content", 'test', 'session')
            self.assertEqual(action2, 'allowlist_missed')
        finally:
            del os.environ['AI_SWARM_AUTO_RESCUE_ALLOW']

    def test_stats_tracking(self):
        """测试统计跟踪"""
        rescuer = AutoRescuer(dry_run=True)
        rescuer.check_and_rescue("Press ENTER", 'w1', 's')
        rescuer.check_and_rescue("[y/n]", 'w2', 's')
        stats = rescuer.get_stats()
        self.assertEqual(stats['total_checks'], 2)
        self.assertEqual(stats['total_rescues'], 1)
        self.assertEqual(stats['manual_confirms'], 1)
```

#### Step 2: 重写 test_auto_rescuer_patterns.py

测试模块级模式常量：

```python
from swarm.auto_rescuer import (
    AutoRescuer,
    AUTO_ENTER_PATTERNS,
    MANUAL_CONFIRM_PATTERNS,
    DANGEROUS_PATTERNS
)

class TestAutoEnterPatterns(unittest.TestCase):
    """测试 AUTO_ENTER_PATTERNS 检测"""
    def test_press_enter_variants(self):
        rescuer = AutoRescuer(dry_run=True)
        test_cases = [
            "Press ENTER to continue",
            "Press Return",
            "Hit Enter to proceed",
            "按回车继续",
        ]
        for output in test_cases:
            rescue, action, _ = rescuer.check_and_rescue(output, 'test', 'session')
            self.assertEqual(action, 'auto_enter', f"Failed on: {output}")

class TestManualConfirmPatterns(unittest.TestCase):
    """测试 MANUAL_CONFIRM_PATTERNS 检测"""
    def test_yn_patterns(self):
        rescuer = AutoRescuer(dry_run=True)
        test_cases = [
            "[y/n]",
            "[Y/n]",
            "(y/n)",
            "y or n",
        ]
        for output in test_cases:
            rescue, action, _ = rescuer.check_and_rescue(output, 'test', 'session')
            self.assertEqual(action, 'manual_confirm_needed', f"Failed on: {output}")

    def test_confirm_prompts(self):
        rescuer = AutoRescuer(dry_run=True)
        test_cases = [
            "Please confirm",
            "Are you sure",
            "确认",
            "确定吗",
        ]
        for output in test_cases:
            rescue, action, _ = rescuer.check_and_rescue(output, 'test', 'session')
            self.assertEqual(action, 'manual_confirm_needed', f"Failed on: {output}")

    def test_continue_proceed(self):
        rescuer = AutoRescuer(dry_run=True)
        test_cases = [
            "Continue? [Enter]",
            "Proceed with operation?",
        ]
        for output in test_cases:
            rescue, action, _ = rescuer.check_and_rescue(output, 'test', 'session')
            self.assertEqual(action, 'manual_confirm_needed', f"Failed on: {output}")

class TestDangerousPatterns(unittest.TestCase):
    """测试 DANGEROUS_PATTERNS 检测"""
    def test_rm_commands(self):
        rescuer = AutoRescuer(dry_run=True)
        test_cases = [
            "rm -rf /data",
            "rm -r /tmp/files",
            "rm -fr /var/log",
        ]
        for output in test_cases:
            rescue, action, _ = rescuer.check_and_rescue(output, 'test', 'session')
            self.assertEqual(action, 'dangerous_blocked', f"Failed on: {output}")

    def test_database_operations(self):
        rescuer = AutoRescuer(dry_run=True)
        test_cases = [
            "DROP DATABASE production",
            "DROP TABLE users",
            "TRUNCATE orders",
            "DELETE FROM transactions",
        ]
        for output in test_cases:
            rescue, action, _ = rescuer.check_and_rescue(output, 'test', 'session')
            self.assertEqual(action, 'dangerous_blocked', f"Failed on: {output}")
```

#### Step 3: 重写 test_e2e_auto_rescue.py

使用 mock tmux_manager 的 E2E 测试：

```python
from unittest.mock import Mock
from swarm.auto_rescuer import AutoRescuer

class TestAutoRescuerE2E(unittest.TestCase):
    """端到端测试：完整工作流"""
    def setUp(self):
        self.mock_tmux = Mock()
        self.rescuer = AutoRescuer(tmux_manager=self.mock_tmux, dry_run=False)

    def test_full_rescue_workflow(self):
        """完整救援工作流"""
        # 触发自动 Enter
        self.mock_tmux.list_windows.return_value = [{'name': 'worker-0', 'index': 0}]
        self.rescuer.check_and_rescue("Press ENTER", 'worker-0', 'session')
        self.mock_tmux.send_keys_to_window.assert_called()
```

#### Step 4: 运行验证

```bash
# 收集测试
python -m pytest tests/test_auto_rescuer.py tests/test_auto_rescuer_patterns.py tests/test_e2e_auto_rescue.py --collect-only

# 运行测试
python -m pytest tests/test_auto_rescuer.py tests/test_auto_rescuer_patterns.py tests/test_e2e_auto_rescue.py -v
```

---
