---
phase: 32-cli-task-subcommand-implementation
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - /home/user/projects/AAA/swarm/swarm/cli.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "swarm task --help displays task subcommand help"
    - "swarm task claim calls scripts/swarm_tasks_bridge.sh and propagates exit codes"
    - "swarm task done calls scripts/swarm_tasks_bridge.sh and propagates exit codes"
    - "swarm task fail calls scripts/swarm_tasks_bridge.sh and propagates exit codes"
    - "swarm task run calls scripts/swarm_task_wrap.sh and propagates exit codes"
  artifacts:
    - path: /home/user/projects/AAA/swarm/swarm/cli.py
      provides: "task subparser and cmd_task handler function"
      min_lines: 50
  key_links:
    - from: /home/user/projects/AAA/swarm/swarm/cli.py
      to: /home/user/projects/AAA/swarm/scripts/swarm_tasks_bridge.sh
      via: "subprocess.run in cmd_task_claim/done/fail"
      pattern: "subprocess\\.run.*swarm_tasks_bridge\\.sh"
    - from: /home/user/projects/AAA/swarm/swarm/cli.py
      to: /home/user/projects/AAA/swarm/scripts/swarm_task_wrap.sh
      via: "subprocess.run in cmd_task_run"
      pattern: "subprocess\\.run.*swarm_task_wrap\\.sh"
---

<objective>
Add `swarm task` subcommand to CLI with claim, done, fail, and run subcommands that call shell scripts and propagate exit codes.

Purpose: Unified task management CLI entry point for agents
Output: Modified cli.py with task subparser and handlers
</objective>

<execution_context>
@/home/user/projects/AAA/swarm/.planning/PROJECT.md
@/home/user/projects/AAA/swarm/.planning/ROADMAP.md
</execution_context>

<context>
The existing cli.py uses argparse with subparsers pattern:
- Parent parser for --cluster-id
- Subparsers for init, up, master, worker, status, down
- Each command has a cmd_* function handler

This phase adds a new 'task' subparser with 4 subcommands.

Shell scripts to call:
- scripts/swarm_tasks_bridge.sh claim/done/fail
- scripts/swarm_task_wrap.sh run

Exit code requirements:
- claim: 0=success, 2=lock occupied, 1=other error
- done: 0=success, 1=failure
- fail: 0=success, 1=failure
- run: command exit code
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add task subparser and subcommands to main()</name>
  <files>/home/user/projects/AAA/swarm/swarm/cli.py</files>
  <action>
Add the 'task' subparser after the 'down' command parser (around line 580):

```python
# task command
task_parser = subparsers.add_parser('task', parents=[parent_parser], help='Task management commands')
task_subparsers = task_parser.add_subparsers(dest='task_command', help='Task subcommands')

# claim subcommand: swarm task claim <task_id> <worker> [lock_key]
claim_parser = task_subparsers.add_parser('claim', help='Claim a task')
claim_parser.add_argument('task_id', help='Task ID to claim')
claim_parser.add_argument('worker', help='Worker name claiming the task')
claim_parser.add_argument('lock_key', nargs='?', default=None, help='Optional lock key')

# done subcommand: swarm task done <task_id> <worker> [lock_key]
done_parser = task_subparsers.add_parser('done', help='Mark task as done')
done_parser.add_argument('task_id', help='Task ID to complete')
done_parser.add_argument('worker', help='Worker completing the task')
done_parser.add_argument('lock_key', nargs='?', default=None, help='Optional lock key')

# fail subcommand: swarm task fail <task_id> <worker> <reason> [lock_key]
fail_parser = task_subparsers.add_parser('fail', help='Mark task as failed')
fail_parser.add_argument('task_id', help='Task ID that failed')
fail_parser.add_argument('worker', help='Worker reporting failure')
fail_parser.add_argument('reason', help='Failure reason')
fail_parser.add_argument('lock_key', nargs='?', default=None, help='Optional lock key')

# run subcommand: swarm task run <task_id> <worker> <command...>
run_parser = task_subparsers.add_parser('run', help='Run task command wrapper')
run_parser.add_argument('task_id', help='Task ID')
run_parser.add_argument('worker', help='Worker name')
run_parser.add_argument('command', nargs='...', help='Command to execute')
```

Then update the command routing (line 586+) to handle task commands:
```python
elif args.command == 'task':
    return cmd_task(args)
```

Add import for subprocess at top of file (if not present):
```python
import subprocess
```
</action>
  <verify>Run `python3 -m swarm.cli task --help` and verify help output shows task subcommands</verify>
  <done>task subparser added with --help working and showing claim, done, fail, run subcommands</done>
</task>

<task type="auto">
  <name>Task 2: Implement cmd_task and subcommand handlers</name>
  <files>/home/user/projects/AAA/swarm/swarm/cli.py</files>
  <action>
Add cmd_task function after cmd_down function (around line 504):

```python
def cmd_task(args):
    """
    Dispatch to task subcommand handlers.
    """
    import subprocess

    if args.task_command == 'claim':
        return cmd_task_claim(args)
    elif args.task_command == 'done':
        return cmd_task_done(args)
    elif args.task_command == 'fail':
        return cmd_task_fail(args)
    elif args.task_command == 'run':
        return cmd_task_run(args)
    else:
        print("[ERROR] Unknown task command", file=sys.stderr)
        return 1


def cmd_task_claim(args):
    """
    Call swarm_tasks_bridge.sh claim with task_id, worker, [lock_key].
    Exit codes: 0=success, 2=lock occupied, 1=other error
    """
    import subprocess

    cmd = ['scripts/swarm_tasks_bridge.sh', 'claim', args.task_id, args.worker]
    if args.lock_key:
        cmd.append(args.lock_key)

    result = subprocess.run(cmd, capture_output=True, text=True)
    if result.stdout:
        print(result.stdout.strip())
    if result.stderr:
        print(result.stderr.strip(), file=sys.stderr)

    return result.returncode


def cmd_task_done(args):
    """
    Call swarm_tasks_bridge.sh done with task_id, worker, [lock_key].
    Exit codes: 0=success, 1=failure
    """
    import subprocess

    cmd = ['scripts/swarm_tasks_bridge.sh', 'done', args.task_id, args.worker]
    if args.lock_key:
        cmd.append(args.lock_key)

    result = subprocess.run(cmd, capture_output=True, text=True)
    if result.stdout:
        print(result.stdout.strip())
    if result.stderr:
        print(result.stderr.strip(), file=sys.stderr)

    return result.returncode


def cmd_task_fail(args):
    """
    Call swarm_tasks_bridge.sh fail with task_id, worker, reason, [lock_key].
    Exit codes: 0=success, 1=failure
    """
    import subprocess

    cmd = ['scripts/swarm_tasks_bridge.sh', 'fail', args.task_id, args.worker, args.reason]
    if args.lock_key:
        cmd.append(args.lock_key)

    result = subprocess.run(cmd, capture_output=True, text=True)
    if result.stdout:
        print(result.stdout.strip())
    if result.stderr:
        print(result.stderr.strip(), file=sys.stderr)

    return result.returncode


def cmd_task_run(args):
    """
    Call swarm_task_wrap.sh run with task_id, worker, command....
    Exit codes: command exit code
    """
    import subprocess

    # args.command is a list; join to pass through shell
    cmd = ['scripts/swarm_task_wrap.sh', 'run', args.task_id, args.worker] + args.command

    result = subprocess.run(' '.join(cmd), shell=True, capture_output=True, text=True)
    if result.stdout:
        print(result.stdout.strip())
    if result.stderr:
        print(result.stderr.strip(), file=sys.stderr)

    return result.returncode
```

Note: Move `import subprocess` to top of file if not already present to avoid duplication in each function.
</action>
  <verify>
Run the following tests:
1. `python3 -m swarm.cli task claim --help` - shows claim usage
2. `python3 -m swarm.cli task done --help` - shows done usage
3. `python3 -m swarm.cli task fail --help` - shows fail usage
4. `python3 -m swarm.cli task run --help` - shows run usage
</verify>
  <done>All subcommand handlers implemented and help works for each</done>
</task>

<task type="auto">
  <name>Task 3: Verify exit code propagation with test</name>
  <files>/home/user/projects/AAA/swarm/swarm/cli.py</files>
  <action>
Create a simple test to verify exit codes are propagated. Create or check test file:

1. Check if scripts exist:
   - `scripts/swarm_tasks_bridge.sh`
   - `scripts/swarm_task_wrap.sh`

2. Run manual verification tests:

```bash
# Test help (should return 0)
python3 -m swarm.cli task --help
echo "Help exit code: $?"

# Test missing subcommand (should return 1)
python3 -m swarm.cli task 2>/dev/null
echo "Missing subcommand exit code: $?"
```

Note: Full integration testing with scripts requires the scripts to exist and be executable. The CLI implementation itself is complete when help works.
</action>
  <verify>
Run all verification tests:
1. `python3 -m swarm.cli task --help` exits 0
2. `python3 -m swarm.cli task claim --help` exits 0
3. `python3 -m swarm.cli task done --help` exits 0
4. `python3 -m swarm.cli task fail --help` exits 0
5. `python3 -m swarm.cli task run --help` exits 0
6. `python3 -m swarm.cli task` (no subcommand) exits 1 with error
</verify>
  <done>All CLI commands work correctly with expected exit codes</done>
</task>

</tasks>

<verification>
## CLI Verification Tests

Run these commands to verify implementation:

```bash
# From /home/user/projects/AAA/swarm directory
cd /home/user/projects/AAA/swarm

# 1. Task subcommand help
python3 -m swarm.cli task --help

# 2. Each subcommand help
python3 -m swarm.cli task claim --help
python3 -m swarm.cli task done --help
python3 -m swarm.cli task fail --help
python3 -m swarm.cli task run --help

# 3. Main help should show task command
python3 -m swarm.cli --help

# 4. Exit code tests
python3 -m swarm.cli task --help; echo "Exit: $?"
python3 -m swarm.cli task 2>/dev/null; echo "Exit: $?"
```

## Expected Output

1. `task --help` should show: claim, done, fail, run subcommands
2. `claim --help` should show: task_id, worker, [lock_key] arguments
3. `done --help` should show: task_id, worker, [lock_key] arguments
4. `fail --help` should show: task_id, worker, reason, [lock_key] arguments
5. `run --help` should show: task_id, worker, command arguments
6. Missing subcommand should exit with code 1
</verification>

<success_criteria>
- [ ] `swarm task --help` displays task subcommand help
- [ ] `swarm task claim <task_id> <worker>` calls script and propagates exit codes
- [ ] `swarm task done <task_id> <worker>` calls script and propagates exit codes
- [ ] `swarm task fail <task_id> <worker> <reason>` calls script and propagates exit codes
- [ ] `swarm task run <task_id> <worker> <command>` calls script and propagates exit codes
</success_criteria>

<output>
After completion, create `.planning/phases/32-cli-task-subcommand-implementation/32-01-SUMMARY.md`
</output>
