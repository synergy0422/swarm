---
phase: 28-master-integration
plan: "02"
type: execute
wave: 1
depends_on: []
files_modified: ["swarm/master.py"]
autonomous: true
user_setup: []
gap_closure: true

must_haves:
  truths:
    - "blocked_by_config action shows WAIT state with [BLOCKED BY CONFIG] note in summary"
    - "allowlist_missed action shows WAIT state with [ALLOWLIST MISSED] note in summary"
    - "disabled action shows IDLE state with [AUTO-RESCUE DISABLED] note in summary"
  artifacts:
    - path: "swarm/master.py"
      provides: "Master._handle_pane_wait_states with new action handling"
      contains: "blocked_by_config|allowlist_missed|disabled"
      min_lines: 30
  key_links:
    - from: AutoRescuer.check_and_rescue()
      to: Master._handle_pane_wait_states()
      via: action returned from check_and_rescue()
---

<objective>
Fix Master integration to handle new AutoRescuer actions: blocked_by_config, allowlist_missed, and disabled.

Currently these actions are returned but not displayed in the status summary, causing incomplete situational awareness.
</objective>

<execution_context>
@/home/user/projects/AAA/swarm/swarm/master.py
@/home/user/projects/AAA/swarm/swarm/auto_rescuer.py (reference for action definitions)
</execution_context>

<context>
## Problem Statement

Phase 28-01 added three new actions:
- `'disabled'` - returned when AI_SWARM_AUTO_RESCUE_ENABLED=false
- `'blocked_by_config'` - returned when BLOCK pattern matches
- `'allowlist_missed'` - returned when ALLOW is set but no match

But Master._handle_pane_wait_states() only handles:
- 'auto_enter'
- 'manual_confirm_needed'
- 'dangerous_blocked'
- 'cooldown'
- 'rescue_failed'
- 'none'

## Required Fixes

Update _handle_pane_wait_states() to handle new actions:

1. **blocked_by_config** → set state to WAIT, note="[BLOCKED BY CONFIG]"
2. **allowlist_missed** → set state to WAIT, note="[ALLOWLIST MISSED]"
3. **disabled** → set state to IDLE, note="[AUTO-RESCUE DISABLED]"

This ensures the status summary shows meaningful information when these actions occur.
</context>

<tasks>

<task type="auto">
  <name>Add new action handling to _handle_pane_wait_states</name>
  <files>swarm/master.py</files>
  <action>
Read swarm/master.py and locate _handle_pane_wait_states() method.

Find the section where action results are handled (around line where auto_enter/manual_confirm_needed are processed).

Add new action handling BEFORE the existing action handling (or integrate with the existing if/elif chain):

```python
# Handle new AutoRescuer actions (Phase 28)
if action == 'blocked_by_config':
    # Config blocks auto-rescue - show as WAIT with config block note
    summary.update_state('WAIT', timestamp)
    summary.note = '[BLOCKED BY CONFIG]'
elif action == 'allowlist_missed':
    # Content doesn't match allowlist - requires manual confirm
    summary.update_state('WAIT', timestamp)
    summary.note = '[ALLOWLIST MISSED]'
elif action == 'disabled':
    # Auto-rescue is disabled - show as IDLE with disabled note
    summary.update_state('IDLE', timestamp)
    summary.note = '[AUTO-RESCUE DISABLED]'

# Continue with existing action handling for auto_enter, manual_confirm_needed, etc.
```

Ensure the new action handling is placed appropriately in the existing if/elif chain.
</action>
  <verify>Run `python3 -c "
import sys
sys.path.insert(0, 'swarm')
from master import Master
import inspect

# Check if _handle_pane_wait_states contains new action handling
source = inspect.getsource(Master._handle_pane_wait_states)
assert 'blocked_by_config' in source, 'Missing blocked_by_config handling'
assert 'allowlist_missed' in source, 'Missing allowlist_missed handling'
assert 'disabled' in source, 'Missing disabled handling'
assert '[BLOCKED BY CONFIG]' in source, 'Missing BLOCKED BY CONFIG note'
assert '[ALLOWLIST MISSED]' in source, 'Missing ALLOWLIST MISSED note'
assert '[AUTO-RESCUE DISABLED]' in source, 'Missing AUTO-RESCUE DISABLED note'
print('Action handling verified: OK')
"`</verify>
  <done>_handle_pane_wait_states handles blocked_by_config, allowlist_missed, and disabled actions with proper state and note assignment</done>
</task>

</tasks>

<verification>
Test the new action handling:

1. Verify source code contains new action handling:
```bash
grep -n "blocked_by_config\|allowlist_missed\|disabled" swarm/master.py
```

2. Verify state transitions:
- blocked_by_config → WAIT + [BLOCKED BY CONFIG]
- allowlist_missed → WAIT + [ALLOWLIST MISSED]
- disabled → IDLE + [AUTO-RESCUE DISABLED]

3. Verify the summary table shows these actions when they occur.
</verification>

<success_criteria>
- [ ] _handle_pane_wait_states handles blocked_by_config action
- [ ] _handle_pane_wait_states handles allowlist_missed action
- [ ] _handle_pane_wait_states handles disabled action
- [ ] blocked_by_config shows WAIT state with [BLOCKED BY CONFIG] note
- [ ] allowlist_missed shows WAIT state with [ALLOWLIST MISSED] note
- [ ] disabled shows IDLE state with [AUTO-RESCUE DISABLED] note
- [ ] No regression in existing action handling
</success_criteria>

<output>
After completion, create `.planning/phases/28-master-integration/28-02-SUMMARY.md`
</output>
