---
phase: 28-auto-rescue-config
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified: ["swarm/auto_rescuer.py"]
autonomous: true
user_setup: []

must_haves:
  truths:
    - "AI_SWARM_AUTO_RESCUE_ENABLED=false completely disables auto-rescue (no send-keys)"
    - "AI_SWARM_AUTO_RESCUE_BLOCK regex patterns block matching content (returns 'blocked_by_config')"
    - "AI_SWARM_AUTO_RESCUE_ALLOW regex patterns whitelist matching content (returns 'allowlist_missed' if no match)"
    - "Priority: ENABLED=false > BLOCK > ALLOW > default behavior"
    - "Default behavior unchanged when env vars not set"
    - "Invalid regex patterns trigger warning logging (not silently ignored)"
  actions:
    - "'disabled' - returned when ENABLED=false"
    - "'blocked_by_config' - returned when BLOCK pattern matches"
    - "'allowlist_missed' - returned when ALLOW set but no match"
  artifacts:
    - path: "swarm/auto_rescuer.py"
      provides: "AutoRescuer class with env var support"
      contains: "ENV_AUTO_RESCUE_ENABLED, ENV_AUTO_RESCUE_ALLOW, ENV_AUTO_RESCUE_BLOCK"
  key_links:
    - from: "swarm/auto_rescuer.py"
      to: "os.environ"
      via: "Environment variable reading in __init__"
---

<objective>
Add environment variable configuration support to AutoRescuer for enable/disable, whitelist, and blacklist patterns.

Purpose: Allow operators to configure auto-rescue behavior without code changes. Supports disabling auto-rescue entirely, or restricting it to specific patterns via allow/block lists.

Output: Modified `swarm/auto_rescuer.py` with three new environment variables and priority-based evaluation logic.
</objective>

<execution_context>
@/home/user/projects/AAA/swarm/.planning/PROJECT.md
@/home/user/projects/AAA/swarm/.planning/phases/27-status-summary-enhancement/27-01-SUMMARY.md
@/home/user/projects/AAA/swarm/swarm/auto_rescuer.py (reference existing pattern for env var reading)
</execution_context>

<context>
## Phase Goal

Configure auto-rescue behavior via environment variables:
- `AI_SWARM_AUTO_RESCUE_ENABLED=false` - Disable auto-rescue completely
- `AI_SWARM_AUTO_RESCUE_ALLOW=<regex>` - Whitelist pattern (only rescue matching)
- `AI_SWARM_AUTO_RESCUE_BLOCK=<regex>` - Blacklist pattern (never rescue matching)

## Existing Pattern

`swarm/auto_rescuer.py` already reads env vars in `__init__`:
```python
ENV_AUTO_RESCUE_COOLING = 'AI_SWARM_AUTO_RESCUE_COOLING'
ENV_AUTO_RESCUE_DRY_RUN = 'AI_SWARM_AUTO_RESCUE_DRY_RUN'
```

## Priority Logic (highest to lowest)

1. If `ENABLED=false` → return `(False, 'disabled', '')` immediately
2. If `BLOCK` pattern matches → return `(False, 'blocked_by_config', 'BLOCK pattern matched: ...')`
3. If `ALLOW` is set and no match → return `(False, 'allowlist_missed', '')`
4. Continue with existing `DANGEROUS/AUTO_ENTER/MANUAL_CONFIRM` logic

## Default Behavior

When env vars not set:
- `ENABLED` defaults to `True`
- `ALLOW` defaults to `None` (no whitelist restriction)
- `BLOCK` defaults to `None` (no blacklist restriction)
</context>

<tasks>

<task type="auto">
  <name>Add environment variable constants and init parsing</name>
  <files>swarm/auto_rescuer.py</files>
  <action>
Add three new environment variable constants at module level:
```python
ENV_AUTO_RESCUE_ENABLED = 'AI_SWARM_AUTO_RESCUE_ENABLED'
ENV_AUTO_RESCUE_ALLOW = 'AI_SWARM_AUTO_RESCUE_ALLOW'
ENV_AUTO_RESCUE_BLOCK = 'AI_SWARM_AUTO_RESCUE_BLOCK'
```

In `AutoRescuer.__init__`, after existing env var parsing (around line 157), add:
```python
import logging
logger = logging.getLogger(__name__)

# Auto-rescue enable/disable (default: enabled)
self.enabled = True
enabled_str = os.environ.get(ENV_AUTO_RESCUE_ENABLED)
if enabled_str is not None:
    self.enabled = enabled_str.lower() not in ('0', 'false', 'no', '')

# Allowlist pattern (optional - if set, only rescue matching patterns)
self.allow_pattern = None
allow_str = os.environ.get(ENV_AUTO_RESCUE_ALLOW)
if allow_str:
    try:
        re.compile(allow_str)
        self.allow_pattern = allow_str
    except re.error:
        logger.warning(f"Invalid regex pattern in AI_SWARM_AUTO_RESCUE_ALLOW: {allow_str}")

# Blocklist pattern (optional - if set, never rescue matching patterns)
self.block_pattern = None
block_str = os.environ.get(ENV_AUTO_RESCUE_BLOCK)
if block_str:
    try:
        re.compile(block_str)
        self.block_pattern = block_str
    except re.error:
        logger.warning(f"Invalid regex pattern in AI_SWARM_AUTO_RESCUE_BLOCK: {block_str}")
```

Store these as instance attributes: `self.enabled`, `self.allow_pattern`, `self.block_pattern`.
</action>
  <verify>Run `python -c "from swarm.auto_rescuer import AutoRescuer; a = AutoRescuer(); print(f'enabled={a.enabled}, allow={a.allow_pattern}, block={a.block_pattern}')"` - should show enabled=True, allow=None, block=None</verify>
  <done>AutoRescuer reads ENABLED/ALLOW/BLOCK from environment with None defaults</done>
</task>

<task type="auto">
  <name>Implement priority evaluation logic in check_and_rescue</name>
  <files>swarm/auto_rescuer.py</files>
  <action>
Modify `check_and_rescue()` to evaluate config before existing pattern detection.

Add at the START of `check_and_rescue()` method (after line 213 empty content check), BEFORE the existing Step 1 (dangerous pattern detection):

```python
# Step 0.5: Config-based evaluation (highest priority)
if not self.enabled:
    self._stats['disabled_skipped'] += 1
    return False, 'disabled', 'auto-rescue disabled by AI_SWARM_AUTO_RESCUE_ENABLED'

if self.block_pattern and pane_output:
    block_match = re.search(self.block_pattern, pane_output, re.IGNORECASE)
    if block_match:
        self._stats['blocklist_blocked'] += 1
        self.broadcaster.broadcast_error(
            task_id='',
            message=f'Content blocked by AI_SWARM_AUTO_RESCUE_BLOCK pattern in {window_name}',
            meta={'window_name': window_name, 'action': 'blocked', 'pattern': block_match.group(0)}
        )
        return False, 'blocked_by_config', f'BLOCK pattern matched: {block_match.group(0)}'

if self.allow_pattern and pane_output:
    allow_match = re.search(self.allow_pattern, pane_output, re.IGNORECASE)
    if not allow_match:
        self._stats['allowlist_missed'] += 1
        self.broadcaster.broadcast_wait(
            task_id='',
            message=f'Content not matching ALLOW pattern in {window_name}, manual confirm needed'
        )
        return False, 'allowlist_missed', ''
```

Also add new stat counters to `self._stats` in `__init__`:
```python
'disabled_skipped': 0,
'blocklist_blocked': 0,
'allowlist_missed': 0,
```

Update `get_stats()` and `reset_stats()` to include these new counters.
</action>
  <verify>Run `python -c "import os; os.environ['AI_SWARM_AUTO_RESCUE_ENABLED']='false'; from swarm.auto_rescuer import AutoRescuer; a=AutoRescuer(); r=a.check_and_rescue('test content', 'win', 'sess'); print(r)"` - should return (False, 'disabled', ...)</verify>
  <done>check_and_rescue returns (False, 'disabled', '') when AI_SWARM_AUTO_RESCUE_ENABLED=false</done>
</task>

<task type="auto">
  <name>Update stats tracking and documentation</name>
  <files>swarm/auto_rescuer.py</files>
  <action>
1. Update `get_stats()` and `reset_stats()` to include the new counters:
```python
def get_stats(self) -> Dict[str, int]:
    return self._stats.copy()

def reset_stats(self) -> None:
    self._stats = {
        'total_checks': 0,
        'total_rescues': 0,
        'manual_confirms': 0,
        'dangerous_blocked': 0,
        'cooldown_skipped': 0,
        'disabled_skipped': 0,
        'blocklist_blocked': 0,
        'allowlist_missed': 0,
    }
```

2. Update the module docstring to document the new environment variables:
```python
"""
Auto Rescuer Module for AI Swarm System

Features:
- Pattern classification: AUTO_ENTER, MANUAL_CONFIRM, DANGEROUS
- Per-window cooldown mechanism (30 seconds default)
- Dangerous operation blocking (rm -rf, DROP, TRUNCATE, etc.)
- Environment variable configuration:
  - AI_SWARM_AUTO_RESCUE_ENABLED=false - Disable auto-rescue
  - AI_SWARM_AUTO_RESCUE_ALLOW=<regex> - Only rescue matching content
  - AI_SWARM_AUTO_RESCUE_BLOCK=<regex> - Never rescue matching content
- Dry-run mode for testing
"""
```

3. Update `check_and_rescue` return value documentation to include 'disabled' action.
</action>
  <verify>Run `python -c "from swarm.auto_rescuer import AutoRescuer; a=AutoRescuer(); print(a.get_stats().keys())"` - should show all 8 stat keys</verify>
  <done>Stats tracking includes disabled_skipped, blocklist_blocked, allowlist_missed</done>
</task>

</tasks>

<verification>
1. Test with no env vars set (default behavior):
   - `python -c "from swarm.auto_rescuer import AutoRescuer; a=AutoRescuer(); print(f'default: enabled={a.enabled}, allow={a.allow_pattern}, block={a.block_pattern}')"`
   - Should show: `default: enabled=True, allow=None, block=None`

2. Test with ENABLED=false:
   - Set `AI_SWARM_AUTO_RESCUE_ENABLED=false` and call `check_and_rescue('test', 'win', 'sess')`
   - Should return `(False, 'disabled', 'auto-rescue disabled by AI_SWARM_AUTO_RESCUE_ENABLED')`

3. Test with BLOCK pattern:
   - Set `AI_SWARM_AUTO_RESCUE_BLOCK='test.*content'` and call `check_and_rescue('test content', 'win', 'sess')`
   - Should return `(False, 'blocked_by_config', 'BLOCK pattern matched: test content')`

4. Test with ALLOW pattern (no match):
   - Set `AI_SWARM_AUTO_RESCUE_ALLOW='allowed.*pattern'` and call `check_and_rescue('test content', 'win', 'sess')`
   - Should return `(False, 'allowlist_missed', '')`

5. Test with ALLOW pattern (match):
   - Set `AI_SWARM_AUTO_RESCUE_ALLOW='test.*'` and call `check_and_rescue('test content', 'win', 'sess')`
   - Should continue to existing pattern detection (not blocked by ALLOW)

6. Verify existing patterns still work:
   - Test `[y/n]` detection still returns `manual_confirm_needed`
   - Test `Press Enter` detection still triggers `auto_enter`
   - Test `rm -rf` still returns `dangerous_blocked`
</verification>

<success_criteria>
- [ ] `AI_SWARM_AUTO_RESCUE_ENABLED=false` disables auto-rescue (returns 'disabled')
- [ ] `AI_SWARM_AUTO_RESCUE_BLOCK` regex blocks matching content (returns 'blocked_by_config')
- [ ] `AI_SWARM_AUTO_RESCUE_ALLOW` regex whitelists content (returns 'allowlist_missed' if no match)
- [ ] Priority order: ENABLED > BLOCK > ALLOW > existing patterns
- [ ] Default behavior unchanged when env vars not set
- [ ] Stats tracking includes new counters
- [ ] Module docstring documents new environment variables
- [ ] Invalid regex patterns trigger warning logging
</success_criteria>

<output>
After completion, create `.planning/phases/28-auto-rescue-config/28-01-SUMMARY.md`
</output>
