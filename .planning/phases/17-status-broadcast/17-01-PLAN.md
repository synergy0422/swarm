---
wave: 1
depends_on: []
files_modified:
  - scripts/swarm_broadcast.sh
  - CONTRIBUTING.md
autonomous: true
---

# Phase 17: Status Broadcast - Plan

## Overview

Create a worker script (`swarm_broadcast.sh`) for broadcasting status entries at key lifecycle points (START/DONE/ERROR/WAIT) and document script conventions in CONTRIBUTING.md.

## Background

This phase implements a convenient wrapper around `swarm_status_log.sh append` that:
- Auto-detects the current worker window (worker-0/1/2) using `tmux display-message`
- Provides simple commands: `start`, `done`, `error`, `wait`
- Internally calls `swarm_status_log.sh append` (which handles timestamp generation)
- Handles errors with stderr output and non-zero exit code

## Tasks

### Task 1: Create scripts/swarm_broadcast.sh

Create a new script that wraps `swarm_status_log.sh append` with simplified commands.

**File:** `scripts/swarm_broadcast.sh`

**Requirements:**
- Source `_common.sh` for config and logging functions
- Set `set -euo pipefail` for error handling
- Auto-detect worker window from TMUX window name using `tmux display-message -p -t "$TMUX_PANE" '#{window_name}'`
- Commands: `start`, `done`, `error`, `wait` (each accepts task_id and optional reason)
- Call `swarm_status_log.sh append` with format: `<type> <worker> <task_id> [reason]` (no timestamp arg)
- Error handling: log_error to stderr + exit 1 on write failure
- Support optional `--session` flag for consistency with other scripts

**Usage:**
```bash
# Broadcast START status (auto-detects worker from TMUX)
./scripts/swarm_broadcast.sh start task-001

# Broadcast DONE status with reason
./scripts/swarm_broadcast.sh done task-001 "Completed successfully"

# Broadcast ERROR status with reason
./scripts/swarm_broadcast.sh error task-002 "File not found"

# Broadcast WAIT status with reason
./scripts/swarm_broadcast.sh wait task-003 "Waiting for dependency"

# With custom session
./scripts/swarm_broadcast.sh --session custom-session start task-004
```

**Implementation details:**
- Use `tmux display-message -p -t "$TMUX_PANE" '#{window_name}'` to detect worker
- Derive worker name from TMUX_PANE if tmux display-message unavailable
- Fallback: error if worker cannot be detected
- Use `log_info` for successful broadcasts
- Use `log_error` for failures, exit 1

**Validation criteria:**
- [ ] Script is executable (`chmod +x scripts/swarm_broadcast.sh`)
- [ ] Sources `_common.sh`
- [ ] Commands: start, done, error, wait
- [ ] Auto-detects worker from TMUX using `tmux display-message`
- [ ] Calls `swarm_status_log.sh append` internally (no timestamp arg)
- [ ] Returns non-zero exit code on write failure

---

### Task 2: Create CONTRIBUTING.md

Create documentation for script conventions and testing requirements.

**File:** `CONTRIBUTING.md` (repo root)

**Requirements:**
- Document `_common.sh` usage (sourcing, logging functions, environment variables)
- Document script conventions (set -euo pipefail, error handling, logging)
- Document testing requirements for new scripts
- Follow existing pattern from v1.3/v1.4 scripts

**Sections to include:**

1. **Script Conventions**
   - Required boilerplate: `#!/usr/bin/env bash`, `set -euo pipefail`
   - `_common.sh` sourcing pattern
   - Logging functions: `log_info`, `log_warn`, `log_error` (output to stderr)
   - Environment variables: `SWARM_STATE_DIR`, `SESSION_NAME`
   - Error handling: fail fast, non-zero exit on failure

2. **Status Broadcasting**
   - `swarm_broadcast.sh` usage and commands
   - `swarm_status_log.sh` commands (append, tail, query)
   - Status types: START, DONE, ERROR, WAIT, HELP, SKIP
   - Format specification: JSON Lines with required/optional fields

3. **Testing Requirements**
   - All scripts must be executable
   - Error paths must be tested (invalid inputs, missing dependencies)
   - Scripts must handle missing environment variables gracefully
   - Integration tests for swarm scripts (swarm_status_log.sh, swarm_broadcast.sh)
   - Test with custom SWARM_STATE_DIR for isolation

4. **Adding New Scripts**
   - Follow naming convention: `swarm_*.sh` for swarm-related scripts
   - Use `_common.sh` for shared functionality
   - Document usage in this file
   - Add tests if applicable

**Validation criteria:**
- [ ] CONTRIBUTING.md exists in repo root
- [ ] Documents `_common.sh` usage and logging
- [ ] Documents script conventions
- [ ] Documents status broadcasting (swarm_broadcast.sh, swarm_status_log.sh)
- [ ] Documents testing requirements for new scripts
- [ ] Follows existing documentation style from v1.3/v1.4

---

## must_haves

- [ ] `scripts/swarm_broadcast.sh` exists and is executable
- [ ] Sources `_common.sh` for config and logging
- [ ] `start` command: broadcasts START status
- [ ] `done` command: broadcasts DONE status
- [ ] `error` command: broadcasts ERROR status
- [ ] `wait` command: broadcasts WAIT status
- [ ] Auto-detects worker window using `tmux display-message` (worker-0/1/2)
- [ ] Internally calls `swarm_status_log.sh append` (no timestamp arg)
- [ ] Error: stderr error + non-zero exit on write failure
- [ ] CONTRIBUTING.md exists in repo root
- [ ] CONTRIBUTING.md documents script conventions
- [ ] CONTRIBUTING.md documents testing requirements

## Verification

### Script Verification
```bash
# Test script exists and is executable
test -x scripts/swarm_broadcast.sh

# Test help output
./scripts/swarm_broadcast.sh help

# Test each command (creates entries in status.log)
./scripts/swarm_broadcast.sh start task-test-001
./scripts/swarm_broadcast.sh done task-test-001 "Test completion"
./scripts/swarm_broadcast.sh error task-test-002 "Test error"
./scripts/swarm_broadcast.sh wait task-test-003 "Test wait"

# Verify entries were appended
./scripts/swarm_status_log.sh tail 10
./scripts/swarm_status_log.sh query task-test-001
```

### Error Handling Verification
```bash
# Test invalid command
./scripts/swarm_broadcast.sh invalid 2>/dev/null || echo "Exit code: $?"

# Test missing task_id
./scripts/swarm_broadcast.sh start 2>/dev/null || echo "Exit code: $?"
```

### Documentation Verification
```bash
# Test CONTRIBUTING.md exists
test -f CONTRIBUTING.md

# Verify sections exist
grep -q "_common.sh" CONTRIBUTING.md
grep -q "swarm_broadcast.sh" CONTRIBUTING.md
grep -q "Testing" CONTRIBUTING.md
```

## Notes

- Worker auto-detection uses `tmux display-message -p -t "$TMUX_PANE" '#{window_name}'`
- If TMUX is not available, script should error with clear message
- Timestamp is generated by `swarm_status_log.sh append`, not by `swarm_broadcast.sh`
- All scripts follow the same pattern as existing swarm scripts (claude_status.sh, etc.)
- Status entries use the same format as `swarm_status_log.sh append` for consistency

## PLANNING COMPLETE

Plan: 17-01
Tasks: 2
Location: .planning/phases/17-status-broadcast/17-01-PLAN.md
