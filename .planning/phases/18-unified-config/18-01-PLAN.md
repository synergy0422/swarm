---
phase: 18-unified-config
plan: 18-01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/_config.sh
  - scripts/_common.sh
autonomous: true
user_setup: []

must_haves:
  truths:
    - "scripts/_config.sh exists and is readable"
    - "Configuration includes: SESSION_NAME, SWARM_STATE_DIR, WORKERS, LOG_LEVEL"
    - "scripts/_common.sh sources _config.sh for centralized configuration"
    - "Graceful degradation if _config.sh missing (uses SWARM_NO_CONFIG=1 to test)"
    - "Environment variables override defaults (SWARM_STATE_DIR=value)"
    - "log_debug function available when LOG_LEVEL=DEBUG"
    - "SWARM_NO_CONFIG=1 switch controls _config.sh loading"
  artifacts:
    - path: "scripts/_config.sh"
      provides: "Centralized configuration with defaults for SESSION_NAME, SWARM_STATE_DIR, WORKERS, LOG_LEVEL"
      min_lines: 30
    - path: "scripts/_common.sh"
      provides: "Sources _config.sh, exports vars, provides log functions including log_debug"
      min_lines: 35
  key_links:
    - from: "scripts/_common.sh"
      to: "scripts/_config.sh"
      via: "source statement at top of _common.sh"
      pattern: "^source.*_config\\.sh"
    - from: "scripts/_common.sh"
      to: "log_debug function"
      via: "conditional definition based on LOG_LEVEL"
      pattern: "log_debug\\(\\)"
    - from: "scripts/*.sh"
      to: "scripts/_common.sh"
      via: "source statement in each script"
      pattern: "source.*_common\\.sh"
---

<objective>
Create unified configuration entry point (`scripts/_config.sh`) that centralizes all configuration variables (SESSION_NAME, SWARM_STATE_DIR, WORKERS, LOG_LEVEL) with environment variable override support. Update `_common.sh` to source this config and provide graceful degradation.

Purpose: This foundational change enables all scripts to read configuration from a single source, making the system more maintainable and configurable. Future phases (19-20) will depend on this unified configuration.

Output: Two files created/modified: `scripts/_config.sh` (new), `scripts/_common.sh` (updated)
</objective>

<execution_context>
@/home/user/.claude/get-shit-done/workflows/execute-plan.md
@/home/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/user/projects/AAA/swarm/.planning/STATE.md
@/home/user/projects/AAA/swarm/.planning/ROADMAP.md
@/home/user/projects/AAA/swarm/.planning/REQUIREMENTS.md

# Existing _common.sh patterns (from Phase 15)
@/home/user/projects/AAA/swarm/scripts/_common.sh

# Key decisions from STATE.md
- Phase 15 established _common.sh with source guard pattern
- log_info/log_warn/log_error output to stderr (not stdout)
- CLAUDE_SESSION backward compatibility for existing scripts
- SWARM_STATE_DIR defaults to /tmp/ai_swarm
- SESSION_NAME priority: explicit > CLAUDE_SESSION > SESSION_NAME > swarm-claude-default

# Configuration variables already in use
- SWARM_STATE_DIR: State directory for locks, status logs
- SESSION_NAME: tmux session name
- WORKERS: (NEW) list of worker names for dispatch
- LOG_LEVEL: (NEW) DEBUG/INFO/WARN/ERROR for logging verbosity
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create scripts/_config.sh with centralized configuration</name>
  <files>scripts/_config.sh</files>
  <action>
Create `scripts/_config.sh` as a shell script meant to be sourced (no source guard, no execution logic):

1. Define default configuration values with environment variable override:
   - SWARM_STATE_DIR: defaults to /tmp/ai_swarm
   - SESSION_NAME: defaults to swarm-claude-default
   - WORKERS: defaults to "worker-0 worker-1 worker-2" (space-separated)
   - LOG_LEVEL: defaults to INFO

2. Environment variable override pattern:
   ```bash
   SWARM_STATE_DIR="${SWARM_STATE_DIR:-/tmp/ai_swarm}"
   ```

3. Export all variables so they are available to sourced scripts:
   ```bash
   export SWARM_STATE_DIR SESSION_NAME WORKERS LOG_LEVEL
   ```

4. Add comments explaining each variable and override priority

DO NOT add source guard (this file is meant to be sourced)
DO NOT add execution logic (no main block, no set -euo pipefail)
</action>
  <verify>test -f scripts/_config.sh && grep -q "SWARM_STATE_DIR" scripts/_config.sh && grep -q "export" scripts/_config.sh</verify>
  <done>scripts/_config.sh exists with all four configuration variables (SESSION_NAME, SWARM_STATE_DIR, WORKERS, LOG_LEVEL) and exports them</done>
</task>

<task type="auto">
  <name>Task 2: Update scripts/_common.sh to source _config.sh and add log_debug</name>
  <files>scripts/_common.sh</files>
  <action>
Modify `scripts/_common.sh` to:

1. Source _config.sh at the top (after source guard), with SWARM_NO_CONFIG override:
   ```bash
   # Source centralized configuration (with graceful degradation)
   _CONFIG_SCRIPT="$(dirname "${BASH_SOURCE[0]}")/_config.sh"
   if [[ "${SWARM_NO_CONFIG:-0}" != "1" ]] && [[ -f "$_CONFIG_SCRIPT" ]]; then
       source "$_CONFIG_SCRIPT"
   fi
   unset _CONFIG_SCRIPT
   ```

2. Remove duplicate variable definitions (SWARM_STATE_DIR, SESSION_NAME) since they now come from _config.sh - keep only the fallback logic in case _config.sh is missing:
   ```bash
   # Fallback defaults if _config.sh is missing
   SWARM_STATE_DIR="${SWARM_STATE_DIR:-/tmp/ai_swarm}"
   SESSION_NAME="${CLAUDE_SESSION:-${SESSION_NAME:-swarm-claude-default}}"
   WORKERS="${WORKERS:-worker-0 worker-1 worker-2}"
   LOG_LEVEL="${LOG_LEVEL:-INFO}"
   export SWARM_STATE_DIR SESSION_NAME WORKERS LOG_LEVEL
   ```

3. Add log_debug function that only outputs when LOG_LEVEL=DEBUG:
   ```bash
   log_debug() {
       if [[ "${LOG_LEVEL:-INFO}" == "DEBUG" ]]; then
           echo "[$(date +%H:%M:%S)][DEBUG] $*" >&2
       fi
   }
   ```

4. Keep existing log_info, log_warn, log_error functions unchanged

DO NOT remove the source guard
DO NOT change existing log function behavior
DO NOT modify the SWARM_STATE_DIR or SESSION_NAME variable priority (CLAUDE_SESSION backward compat)
</action>
  <verify>grep -q "source.*_config\\.sh" scripts/_common.sh && grep -q "log_debug" scripts/_common.sh && grep -q "SWARM_STATE_DIR.*-.*/" scripts/_common.sh</verify>
  <done>scripts/_common.sh sources _config.sh, has graceful degradation fallback, and includes log_debug function</done>
</task>

<task type="auto">
  <name>Task 3: Verify all scripts work with centralized configuration</name>
  <files>scripts/_config.sh, scripts/_common.sh</files>
  <action>
Verify the unified configuration works correctly:

1. Test _config.sh exists and is readable:
   ```bash
   test -f scripts/_config.sh && echo "_config.sh exists"
   ```

2. Test _common.sh sources _config.sh:
   ```bash
   grep "_config.sh" scripts/_common.sh && echo "_config.sh referenced in _common.sh"
   ```

3. Test graceful degradation (without _config.sh):
   ```bash
   # Use SWARM_NO_CONFIG=1 to skip _config.sh loading
   SWARM_NO_CONFIG=1 source /home/user/projects/AAA/swarm/scripts/_common.sh
   test "$SWARM_STATE_DIR" = "/tmp/ai_swarm" && echo "SWARM_STATE_DIR default works"
   test "$SESSION_NAME" = "swarm-claude-default" && echo "SESSION_NAME default works"
   test "$WORKERS" = "worker-0 worker-1 worker-2" && echo "WORKERS default works"
   test "$LOG_LEVEL" = "INFO" && echo "LOG_LEVEL default works"
   ```

4. Test environment variable override:
   ```bash
   unset SWARM_NO_CONFIG  # Clean state from previous test
   SWARM_STATE_DIR=/custom/path source /home/user/projects/AAA/swarm/scripts/_common.sh
   test "$SWARM_STATE_DIR" = "/custom/path" && echo "Override works"
   ```

5. Test log_debug (DEBUG level):
   ```bash
   unset SWARM_NO_CONFIG  # Clean state from previous test
   LOG_LEVEL=DEBUG source /home/user/projects/AAA/swarm/scripts/_common.sh
   log_debug "test message" 2>&1 | grep -q "DEBUG" && echo "log_debug works"
   ```

6. Test log_debug is silent at INFO level:
   ```bash
   unset SWARM_NO_CONFIG  # Clean state from previous test
   LOG_LEVEL=INFO source /home/user/projects/AAA/swarm/scripts/_common.sh
   output=$(log_debug "test message" 2>&1)
   test -z "$output" && echo "log_debug correctly silent at INFO"
   ```

7. Test WORKERS variable is exported:
   ```bash
   unset SWARM_NO_CONFIG  # Clean state from previous test
   source /home/user/projects/AAA/swarm/scripts/_common.sh
   echo "$WORKERS" | grep -q "worker-" && echo "WORKERS exported correctly"
   ```

All tests should pass. If any fail, fix the implementation.
</action>
  <verify>
# Run all verification tests with proper state cleanup
cd /home/user/projects/AAA/swarm

# 1. Basic file checks
test -f scripts/_config.sh && echo "PASS: _config.sh exists"
grep "_config.sh" scripts/_common.sh >/dev/null && echo "PASS: _config.sh referenced in _common.sh"
grep "log_debug" scripts/_common.sh >/dev/null && echo "PASS: log_debug function exists"

# 2. Graceful degradation test (SWARM_NO_CONFIG=1)
unset SWARM_STATE_DIR SESSION_NAME WORKERS LOG_LEVEL
SWARM_NO_CONFIG=1 source scripts/_common.sh
test "$SWARM_STATE_DIR" = "/tmp/ai_swarm" && echo "PASS: SWARM_STATE_DIR default"
test "$SESSION_NAME" = "swarm-claude-default" && echo "PASS: SESSION_NAME default"

# 3. Environment override test (clean state)
unset SWARM_NO_CONFIG
SWARM_STATE_DIR=/custom/path source scripts/_common.sh
test "$SWARM_STATE_DIR" = "/custom/path" && echo "PASS: Override works"

# 4. LOG_LEVEL DEBUG test (clean state)
unset SWARM_NO_CONFIG SWARM_STATE_DIR
LOG_LEVEL=DEBUG source scripts/_common.sh >/dev/null 2>&1
log_debug "test" 2>&1 | grep -q "DEBUG" && echo "PASS: log_debug at DEBUG"

# 5. LOG_LEVEL INFO test (clean state)
unset SWARM_NO_CONFIG
LOG_LEVEL=INFO source scripts/_common.sh >/dev/null 2>&1
output=$(log_debug "test" 2>&1)
test -z "$output" && echo "PASS: log_debug silent at INFO"

echo "All verification tests passed"
</verify>
  <done>All 7 verification tests pass: _config.sh exists, _common.sh sources it, defaults work, env override works, log_debug works at DEBUG level and is silent at INFO, WORKERS exported</done>
</task>

</tasks>

<verification>
## Script Verification Tests

```bash
# 1. _config.sh exists and is readable
test -f scripts/_config.sh && echo "PASS: _config.sh exists"

# 2. _common.sh sources _config.sh
grep "_config.sh" scripts/_common.sh && echo "PASS: _config.sh referenced"

# 3. Graceful degradation (defaults work without _config.sh)
SWARM_NO_CONFIG=1 source scripts/_common.sh
test "$SWARM_STATE_DIR" = "/tmp/ai_swarm" && echo "PASS: SWARM_STATE_DIR default"
test "$SESSION_NAME" = "swarm-claude-default" && echo "PASS: SESSION_NAME default"
test "$WORKERS" = "worker-0 worker-1 worker-2" && echo "PASS: WORKERS default"
test "$LOG_LEVEL" = "INFO" && echo "PASS: LOG_LEVEL default"

# 4. Environment variable override
SWARM_STATE_DIR=/custom/path source scripts/_common.sh
test "$SWARM_STATE_DIR" = "/custom/path" && echo "PASS: Override works"

# 5. log_debug at DEBUG level
LOG_LEVEL=DEBUG source scripts/_common.sh
log_debug "test" 2>&1 | grep -q "DEBUG" && echo "PASS: log_debug at DEBUG"

# 6. log_debug silent at INFO level
LOG_LEVEL=INFO source scripts/_common.sh
output=$(log_debug "test" 2>&1)
test -z "$output" && echo "PASS: log_debug silent at INFO"

# 7. WORKERS exported
source scripts/_common.sh
echo "$WORKERS" | grep -q "worker-" && echo "PASS: WORKERS exported"
```

## Integration Verification

All existing scripts should continue to work:
```bash
./scripts/swarm_status_log.sh help
./scripts/swarm_lock.sh help
./scripts/swarm_broadcast.sh help
```
</verification>

<success_criteria>
1. `scripts/_config.sh` exists and contains all four configuration variables
2. `scripts/_common.sh` sources `_config.sh` with graceful degradation fallback
3. All configuration variables (SESSION_NAME, SWARM_STATE_DIR, WORKERS, LOG_LEVEL) are exported
4. Environment variables override defaults correctly
5. `log_debug` function works at DEBUG level and is silent at INFO level
6. Backward compatibility maintained (existing scripts that set their own vars still work)
7. All scripts pass integration verification
</success_criteria>

<output>
After completion, create `.planning/phases/18-unified-config/18-01-SUMMARY.md`
</output>
