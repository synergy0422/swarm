---
phase: 12-状态记录脚本
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: true
---

# Plan: 状态记录脚本

## Goal

创建 `swarm_status_log.sh` 脚本，支持 append/tail/query 操作，实现外部脚本对 status.log 的读写

**Purpose:** 为多 Agent 并行协作提供状态记录能力，使外部脚本和 Claude CLI Worker 可以记录和查询任务状态变更

**Output:** 1 个可执行的 bash 脚本，实现状态追加、查看和查询功能

## Tasks

<task type="auto">
  <name>Create scripts directory and swarm_status_log.sh</name>
  <files>/home/user/projects/AAA/swarm/scripts/swarm_status_log.sh</files>
  <action>
    Create `/home/user/projects/AAA/swarm/scripts/` directory (if not exists).

    Create `/home/user/projects/AAA/swarm/scripts/swarm_status_log.sh` with:
    - Shebang: `#!/usr/bin/env bash` with `set -euo pipefail`
    - STATE_DIR variable: `STATE_DIR="${SWARM_STATE_DIR:-/tmp/ai_swarm}"`
    - LOG_FILE: `STATUS_LOG="$STATE_DIR/status.log"`
    - Usage function: Display commands and examples

    Implement `append` subcommand:
    - Usage: `append <type> <worker> <task_id> [reason]`
    - Valid types: START, DONE, ERROR, WAIT, HELP, SKIP
    - Generate ISO 8601 timestamp: `TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")`
    - Build JSON object with: timestamp, type, worker, task_id, optional reason
    - Ensure STATE_DIR exists: `mkdir -p "$STATE_DIR"`
    - Append to log file (no overwrite)
    - Print success message with the appended record

    Implement `tail` subcommand:
    - Usage: `tail <n>`
    - If file exists and has content, output last N lines
    - Handle edge cases: empty file, file not exists, N > line count
    - If N is non-numeric or <= 0, default to 10

    Implement `query` subcommand:
    - Usage: `query <task_id>`
    - If file exists, grep for lines containing the task_id
    - Output all matching lines (one per line)
    - Handle no matches gracefully

    Main entry point:
    - Parse subcommand (append/tail/query)
    - Validate arguments based on subcommand
    - Route to appropriate function
    - Show usage for invalid commands

    Example usage in comments:
    ```bash
    # SWARM_STATE_DIR=/custom/path ./scripts/swarm_status_log.sh append START worker-0 task-001
    # ./scripts/swarm_status_log.sh append DONE worker-0 task-001
    # ./scripts/swarm_status_log.sh append ERROR worker-1 task-002 "File not found"
    # ./scripts/swarm_status_log.sh tail 10
    # ./scripts/swarm_status_log.sh query task-001
    ```
  </action>
  <verify>
    `ls -la /home/user/projects/AAA/swarm/scripts/swarm_status_log.sh` exists
    `head -30 /home/user/projects/AAA/swarm/scripts/swarm_status_log.sh` shows proper structure
  </verify>
  <done>
    scripts/swarm_status_log.sh created with append/tail/query functions
  </done>
</task>

<task type="auto">
  <name>Make script executable and test basic structure</name>
  <files>/home/user/projects/AAA/swarm/scripts/swarm_status_log.sh</files>
  <action>
    Make the script executable:
    ```bash
    chmod +x /home/user/projects/AAA/swarm/scripts/swarm_status_log.sh
    ```

    Verify the script structure:
    ```bash
    ./scripts/swarm_status_log.sh
    ```
    Should output usage information

    Test append command creates proper JSON:
    ```bash
    SWARM_STATE_DIR=$(mktemp -d)
    ./scripts/swarm_status_log.sh append START worker-0 task-001
    cat "$SWARM_STATE_DIR/status.log"
    # Should output: {"timestamp": "...", "type": "START", "worker": "worker-0", "task_id": "task-001"}
    ```

    Test tail command:
    ```bash
    ./scripts/swarm_status_log.sh tail 10
    # Should output last 10 lines or all lines if less than 10

    Test query command:
    ```bash
    ./scripts/swarm_status_log.sh query task-001
    # Should output lines containing "task-001"
    ```

    Cleanup test directory:
    ```bash
    rm -rf "$SWARM_STATE_DIR"
    ```
  </action>
  <verify>
    `ls -la /home/user/projects/AAA/swarm/scripts/swarm_status_log.sh` shows executable permissions (x)
    `./scripts/swarm_status_log.sh` returns usage (not command not found)
  </verify>
  <done>
    Script is executable and basic structure verified
  </done>
</task>

<task type="checkpoint:human-verify">
  <what-built>
    Status logging script:
    - swarm_status_log.sh (append/tail/query commands)
    - SWARM_STATE_DIR environment variable support (default: /tmp/ai_swarm)
    - JSON Lines format for status.log
  </what-built>
  <how-to-verify>
    **Step 1 - Append status record:**
    ```bash
    SWARM_STATE_DIR=/tmp/ai_swarm_test
    mkdir -p "$SWARM_STATE_DIR"
    ./scripts/swarm_status_log.sh append START worker-0 task-001
    cat "$SWARM_STATE_DIR/status.log"
    ```
    Expected: Valid JSON line with timestamp, type, worker, task_id

    **Step 2 - Append more records:**
    ```bash
    SWARM_STATE_DIR=/tmp/ai_swarm_test
    ./scripts/swarm_status_log.sh append DONE worker-0 task-001
    ./scripts/swarm_status_log.sh append WAIT worker-1 task-002 "需要人工确认"
    ./scripts/swarm_status_log.sh append ERROR worker-2 task-003 "Resource exhausted"
    ```

    **Step 3 - Test tail:**
    ```bash
    SWARM_STATE_DIR=/tmp/ai_swarm_test
    ./scripts/swarm_status_log.sh tail 2
    ```
    Expected: Last 2 records from status.log

    **Step 4 - Test query:**
    ```bash
    SWARM_STATE_DIR=/tmp/ai_swarm_test
    ./scripts/swarm_status_log.sh query task-001
    ```
    Expected: START and DONE records for task-001

    **Step 5 - Verify JSON format:**
    ```bash
    SWARM_STATE_DIR=/tmp/ai_swarm_test
    python3 - <<'PY'
    import json, sys
    count = 0
    with open(f"{SWARM_STATE_DIR}/status.log") as f:
        for i, line in enumerate(f, 1):
            json.loads(line)
            count += 1
    print(f"OK: {count} valid JSON lines")
    PY
    ```
    Expected: Each line is valid JSON

    **Step 6 - Verify no Python changes:**
    ```bash
    git diff --name-only swarm/
    ```
    Expected: Empty (no modifications)

    **Cleanup:**
    ```bash
    rm -rf /tmp/ai_swarm_test
    ```
  </how-to-verify>
  <resume-signal>
    Type "approved" when all tests pass, or describe any failures with:
    - Which test failed
    - Expected vs actual behavior
    - Any error messages observed
  </resume-signal>
</task>

## Verification Criteria

- [ ] `swarm_status_log.sh append START worker-0 task-001` appends valid JSON to status.log
- [ ] `swarm_status_log.sh append ERROR worker-1 task-002 "reason"` appends with reason field
- [ ] `swarm_status_log.sh tail 10` returns last 10 status records
- [ ] `swarm_status_log.sh query task-001` returns all status changes for task
- [ ] `SWARM_STATE_DIR` environment variable works correctly
- [ ] JSON Lines format is valid (parseable with jq/json.tool)
- [ ] `git diff --name-only swarm/` shows no modified files

## must_haves

  truths:
    - "Script can append JSON status records to status.log"
    - "Script can tail recent status records from status.log"
    - "Script can query status records by task_id"
    - "SWARM_STATE_DIR env var overrides default /tmp/ai_swarm"
    - "No swarm/*.py files were modified"

  artifacts:
    - path: "/home/user/projects/AAA/swarm/scripts/swarm_status_log.sh"
      provides: "Status logging (append/tail/query commands)"
      exports: ["append", "tail", "query"]

  key_links:
    - from: "swarm_status_log.sh append"
      to: "/tmp/ai_swarm/status.log"
      via: "Appends JSON Lines to status.log file"
    - from: "swarm_status_log.sh tail"
      to: "/tmp/ai_swarm/status.log"
      via: "Reads last N lines from status.log"
    - from: "swarm_status_log.sh query"
      to: "/tmp/ai_swarm/status.log"
      via: "Greps for task_id in status.log"
