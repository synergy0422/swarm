---
phase: 22-5窗格布局脚本
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - /home/user/projects/AAA/swarm/scripts/swarm_layout_5.sh
autonomous: true
user_setup: []

must_haves:
  truths:
    - "scripts/swarm_layout_5.sh is executable"
    - "Single tmux window with 5 panes created"
    - "Left pane: master (top) + codex (bottom) 50/50 split"
    - "Right pane: worker-0/1/2 equal horizontal split"
    - "Codex pane runs `codex --yolo` command"
    - "Parameters --session, --workdir, --left-ratio, --codex-cmd, --attach work correctly"
    - "Environment variables CLAUDE_SESSION, SWARM_WORKDIR, CODEX_CMD override defaults"
  artifacts:
    - path: "/home/user/projects/AAA/swarm/scripts/swarm_layout_5.sh"
      provides: "5-pane tmux layout script with master/codex/workers"
      min_lines: 100
    - path: "/home/user/projects/AAA/swarm/README.md"
      provides: "5-pane layout documentation"
      contains: "5 窗格布局"
    - path: "/home/user/projects/AAA/swarm/docs/SCRIPTS.md"
      provides: "swarm_layout_5.sh complete documentation"
      contains: "swarm_layout_5.sh"
  key_links:
    - from: "scripts/swarm_layout_5.sh"
      to: "scripts/_config.sh"
      via: "source for configuration variables"
      pattern: "source.*_config\\.sh"
    - from: "scripts/swarm_layout_5.sh"
      to: "scripts/_common.sh"
      via: "source for logging functions"
      pattern: "source.*_common\\.sh"
    - from: "scripts/swarm_layout_5.sh"
      to: "tmux"
      via: "split-window and send-keys commands"
      pattern: "tmux (split-window|send-keys)"
---

<objective>
Create `scripts/swarm_layout_5.sh` with 5-pane tmux layout and update documentation.

**Purpose:** Enable 5-pane layout in single tmux window with dedicated codex pane for v1.7.
**Output:** Executable script + updated README.md and docs/SCRIPTS.md
</objective>

<execution_context>
@/home/user/projects/AAA/swarm/run_claude_swarm.sh - Reference for existing 4-window tmux script pattern
@/home/user/projects/AAA/swarm/scripts/_config.sh - Configuration variables (SESSION_NAME, SWARM_STATE_DIR)
@/home/user/projects/AAA/swarm/scripts/_common.sh - Logging functions and shared utilities
@/home/user/projects/AAA/swarm/docs/SCRIPTS.md - Documentation format reference
</execution_context>

<context>
@/home/user/projects/AAA/swarm/.planning/PROJECT.md - v1.7 requirements (LAYOUT-01, LAYOUT-02)
@/home/user/projects/AAA/swarm/.planning/requirements/22-5窗格布局脚本.md - Detailed requirements
</context>

<tasks>

<task type="auto">
  <name>Create swarm_layout_5.sh with 5-pane layout</name>
  <files>/home/user/projects/AAA/swarm/scripts/swarm_layout_5.sh</files>
  <action>
    Create the script with the following structure:

    1. Add shebang and error handling: `#!/usr/bin/env bash` + `set -euo pipefail`
    2. Source configuration files:
       - `source "$(dirname "$0")/_config.sh"` for SWARM_STATE_DIR, SESSION_NAME, WORKERS
       - `source "$(dirname "$0")/_common.sh"` for log_info, log_warn, log_error
    3. Define defaults:
       - SESSION: from CLAUDE_SESSION env var, fallback to $SESSION_NAME from _config.sh
       - WORKDIR: from SWARM_WORKDIR env var, fallback to current directory ($PWD)
         (使用 `WORKDIR="${SWARM_WORKDIR:-$PWD}"`)
       - LEFT_RATIO: from --left-ratio param or 50 default
       - CODEX_CMD: from CODEX_CMD env var or "codex --yolo" default
    4. Implement getopts argument parsing:
       - `--session|-s` - tmux session name
       - `--workdir|-d` - working directory
       - `--left-ratio|-l` - left pane vertical split ratio (50-80)
       - `--codex-cmd|-c` - codex command to run
       - `--attach|-a` - attach to tmux session after creation
       - `--help|-h` - show help
    5. Add dependency checks for tmux and codex
    6. Implement help function that includes:
       - "默认工作目录为当前目录，可用 --workdir 或 SWARM_WORKDIR 覆盖"
    7. Implement 5-pane layout using tmux commands:
       - Create new detached session with window name "layout"
       - Create right pane: `split-window -h` (creates pane 1)
       - Split right pane twice for 3 workers: `split-window -v` (creates panes 2, 3)
       - Create left pane master: `split-window -v` (creates pane 4)
       - Split left pane for codex: `split-window -v` (creates pane 5)
       - OR use simpler approach: create all panes, then use select-layout even-horizontal
    8. Send startup commands to each pane (MUST include cd "$WORKDIR"):
       - master pane: `cd "$WORKDIR" && claude`
       - codex pane: `cd "$WORKDIR" && $CODEX_CMD`
       - worker panes: `cd "$WORKDIR" && claude`
    8. Verify layout: `tmux list-panes -t "$SESSION:0"` should show 5 panes
    9. Include help function and usage examples
  </action>
  <verify>
    bash -n /home/user/projects/AAA/swarm/scripts/swarm_layout_5.sh && echo "Syntax OK"
    test -x /home/user/projects/AAA/swarm/scripts/swarm_layout_5.sh && echo "Executable OK"
    grep -q "source.*_config\.sh" /home/user/projects/AAA/swarm/scripts/swarm_layout_5.sh && echo "Config sourced"
    grep -q "source.*_common\.sh" /home/user/projects/AAA/swarm/scripts/swarm_layout_5.sh && echo "Common sourced"
    grep -q 'cd "\$WORKDIR"' /home/user/projects/AAA/swarm/scripts/swarm_layout_5.sh && echo "WORKDIR cd verified"
  </verify>
  <done>
    scripts/swarm_layout_5.sh exists and is executable with:
    - Config sourcing from _config.sh and _common.sh
    - Parameter parsing for --session, --workdir, --left-ratio, --codex-cmd, --attach
    - Environment variable support (CLAUDE_SESSION, SWARM_WORKDIR, CODEX_CMD)
    - 5-pane tmux layout creation
    - Default codex command "codex --yolo"
    - Help text explains default workdir behavior
    - All panes use cd "$WORKDIR" before running commands
  </done>
</task>

<task type="auto">
  <name>Update README.md with 5-pane layout section</name>
  <files>/home/user/projects/AAA/swarm/README.md</files>
  <action>
    Add "5 窗格布局" section to README.md after the existing Architecture section:

    1. Add a new H2 section "5 窗格布局"
    2. Include layout diagram showing:
       - Left: master (top 50%) + codex (bottom 50%)
       - Right: worker-0 + worker-1 + worker-2 (equal split)
    3. Document the new script usage with examples:
       - Basic: `scripts/swarm_layout_5.sh`
       - With attach: `scripts/swarm_layout_5.sh --attach`
       - Custom session: `scripts/swarm_layout_5.sh --session my-session`
       - Custom workdir: `scripts/swarm_layout_5.sh --workdir /path/to/project`
       - Custom codex command: `scripts/swarm_layout_5.sh --codex-cmd "codex --yolo --model o1"`
    4. Add tmux attach command after creation
  </action>
  <verify>
    grep -q "5 窗格布局" /home/user/projects/AAA/swarm/README.md && echo "Section exists"
    grep -q "swarm_layout_5.sh" /home/user/projects/AAA/swarm/README.md && echo "Script documented"
  </verify>
  <done>
    README.md has new "5 窗格布局" section with:
    - Layout diagram
    - Usage examples
    - Script reference
  </done>
</task>

<task type="auto">
  <name>Update docs/SCRIPTS.md with complete documentation</name>
  <files>/home/user/projects/AAA/swarm/docs/SCRIPTS.md</files>
  <action>
    Add swarm_layout_5.sh documentation to docs/SCRIPTS.md in the "配置脚本" section:

    1. Create new section "布局脚本" (Layout Scripts) before "配置脚本"
    2. Add swarm_layout_5.sh entry with:
       - Description: 5-pane tmux layout script
       - Parameters table:
         | Option | Description |
         |--------|-------------|
         | `--session, -s` | tmux session name |
         | `--workdir, -d` | working directory |
         | `--left-ratio, -l` | left pane split ratio (50-80) |
         | `--codex-cmd, -c` | codex command |
         | `--attach, -a` | attach after creation |
         | `--help, -h` | show help |
       - Environment variables table:
         | Variable | Description |
         |----------|-------------|
         | CLAUDE_SESSION | session name override |
         | SWARM_WORKDIR | workdir override |
         | CODEX_CMD | codex command override |
       - Usage examples (basic and advanced)
       - Layout diagram showing pane arrangement
       - How to customize layout ratio and codex command
    3. Update script dependency graph to include new script
  </action>
  <verify>
    grep -q "swarm_layout_5.sh" /home/user/projects/AAA/swarm/docs/SCRIPTS.md && echo "Script documented"
    grep -q "布局脚本" /home/user/projects/AAA/swarm/docs/SCRIPTS.md && echo "Section added"
  </verify>
  <done>
    docs/SCRIPTS.md has complete swarm_layout_5.sh documentation including:
    - Parameter table
    - Environment variables table
    - Usage examples
    - Layout diagram
    - Customization guide
  </done>
</task>

</tasks>

<verification>
Run the following verification commands:

```bash
# Verify script syntax and structure
bash -n scripts/swarm_layout_5.sh
test -x scripts/swarm_layout_5.sh

# Verify configuration sourcing
grep -E "source.*_config|source.*_common" scripts/swarm_layout_5.sh

# Verify parameter parsing (including --attach)
grep -E "getopts|--session|--workdir|--left-ratio|--codex-cmd|--attach" scripts/swarm_layout_5.sh

# Verify tmux commands
grep -E "split-window|send-keys|list-panes" scripts/swarm_layout_5.sh

# Verify WORKDIR cd in all pane commands
grep -E 'cd "\$WORKDIR"' scripts/swarm_layout_5.sh

# Verify documentation
grep -E "5 窗格布局|swarm_layout_5.sh" README.md
grep -E "swarm_layout_5.sh|布局脚本" docs/SCRIPTS.md
```

All commands should produce output indicating the features exist.
</verification>

<success_criteria>
- [ ] scripts/swarm_layout_5.sh exists and is executable
- [ ] Script sources _config.sh and _common.sh correctly
- [ ] Supports --session, --workdir, --left-ratio, --codex-cmd, --attach parameters
- [ ] Supports CLAUDE_SESSION, SWARM_WORKDIR, CODEX_CMD environment variables
- [ ] Creates single tmux window with 5 panes
- [ ] Left: master (top) + codex (bottom) 50/50 split
- [ ] Right: worker-0/1/2 equal horizontal split
- [ ] README.md has "5 窗格布局" section with examples
- [ ] docs/SCRIPTS.md has complete swarm_layout_5.sh documentation
- [ ] `tmux list-panes -t <session>:0` shows 5 panes
- [ ] All pane startup commands include `cd "$WORKDIR"`
</success_criteria>

<output>
After completion, create `.planning/phases/22-5窗格布局脚本/22-01-SUMMARY.md`
</output>
