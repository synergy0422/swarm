---
phase: 05-cli-startup
plan: "02"
type: execute
wave: 1
depends_on: []
files_modified:
  - swarm/cli.py
autonomous: true
user_setup: []
gap_closure: true
---

<objective>
Fix --cluster-id flag to work after subcommands (e.g., `swarm status --cluster-id default`).

The issue: argparse global flags are only parsed before subcommand routing. Currently `swarm status --cluster-id default` fails with "unrecognized arguments".

Purpose: Enable user-expected CLI usage pattern where flags can follow subcommands.
Output: Fixed argparse structure with --cluster-id available on all applicable subcommands.
</objective>

<execution_context>
@/home/user/.claude/get-shit-done/workflows/execute-plan.md
@/home/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/user/AAA/swarm/.planning/phases/05-cli-startup/05-01-SUMMARY.md
@/home/user/AAA/swarm/.planning/phases/05-cli-startup/05-cli-startup-UAT.md
@/home/user/AAA/swarm/swarm/cli.py
</context>

<tasks>

<task name="Task 1: Add --cluster-id to subparsers using argparse parents pattern">
  <files>swarm/cli.py</files>
  <action>
  Replace the current single-parser structure with the parents pattern:

  1. Create a parent parser containing only the --cluster-id argument:
     ```python
     parent_parser = argparse.ArgumentParser(add_help=False)
     parent_parser.add_argument(
         '--cluster-id',
         default=DEFAULT_CLUSTER_ID,
         help=f'Cluster identifier (default: {DEFAULT_CLUSTER_ID})'
     )
     ```

  2. Remove --cluster-id from the main parser (lines 411-415)

  3. Add `parents=[parent_parser]` to each subparser that needs --cluster-id:
     - 'up' subparser (line 424)
     - 'master' subparser (line 433)
     - 'worker' subparser (line 436)
     - 'status' subparser (line 445)
     - 'down' subparser (line 448)

  4. Keep 'init' without --cluster-id (it creates the environment, cluster not yet relevant)

  The result: `swarm status --cluster-id default` and `swarm status --cluster-id=default` both work.
  </action>
  <verify>
  Test the following commands all work without "unrecognized arguments":
  - python3 -m swarm.cli status --cluster-id default
  - python3 -m swarm.cli status --cluster-id=default
  - python3 -m swarm.cli down --cluster-id prod
  - python3 -m swarm.cli up --cluster-id prod --workers 2
  </verify>
  <done>
  `swarm status --cluster-id default` executes without argparse error
  </done>
</task>

</tasks>

<verification>
Run the following verification script:
```bash
cd /home/user/AAA/swarm
python3 -m swarm.cli status --cluster-id default
echo "Exit code: $?"
python3 -m swarm.cli down --cluster-id test
echo "Exit code: $?"
python3 -m swarm.cli --help | grep -A2 "cluster-id"
```
Expected: All commands execute without "unrecognized arguments", help shows cluster-id options.
</verification>

<success_criteria>
- `swarm status --cluster-id default` works
- `swarm down --cluster-id prod` works
- `swarm up --cluster-id prod` works
- `swarm master --cluster-id prod` works
- `swarm worker --id 1 --cluster-id prod` works
- Help text shows --cluster-id options for relevant commands
</success_criteria>

<output>
After completion, create `.planning/phases/05-cli-startup/05-02-SUMMARY.md`
</output>
