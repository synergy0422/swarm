---
phase: 09-cli-status-enhancement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - /home/user/projects/AAA/swarm/swarm/cli.py
  - /home/user/projects/AAA/swarm/tests/test_cli_status_panes.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "swarm status outputs existing task status"
    - "swarm status --panes outputs task status + 4 window pane snapshots"
    - "Each window shows [ERROR], [DONE], or [ ] status icon"
    - "Windows appear in order: master, worker-0, worker-1, worker-2"
    - "Missing windows show (missing) placeholder"
    - "tmux unavailable prints warning and returns 0"
  artifacts:
    - path: /home/user/projects/AAA/swarm/swarm/cli.py
      provides: "Modified cmd_status() with --panes support"
      exports: "cmd_status() handles --panes flag"
    - path: /home/user/projects/AAA/swarm/tests/test_cli_status_panes.py
      provides: "Unit and integration tests for --panes flag"
      exports: "test_status_panes_flag, test_pane_output_format, test_missing_window_display"
  key_links:
    - from: /home/user/projects/AAA/swarm/swarm/cli.py
      to: /home/user/projects/AAA/swarm/swarm/tmux_collaboration.py
      via: "TmuxCollaboration.capture_all_windows()"
      pattern: "capture_all_windows"
---

<objective>
Add `--panes` parameter to `swarm status` command to display 4 tmux window content snapshots.

Purpose: Enable real-time visibility into master and worker terminal outputs during swarm operations
Output: Enhanced `swarm status` command with optional pane snapshot display
</objective>

<execution_context>
@/home/user/projects/AAA/swarm/.planning/phases/09-cli-status-enhancement/09-CONTEXT.md
@/home/user/projects/AAA/swarm/.planning/phases/06-integration-testing/06-04-SUMMARY.md
</execution_context>

<context>
@/home/user/projects/AAA/swarm/swarm/cli.py
@/home/user/projects/AAA/swarm/swarm/tmux_collaboration.py
@/home/user/projects/AAA/swarm/tests/test_e2e_happy_path.py
</context>

<tasks>

<task type="auto">
  <name>Add --panes argument to status subparser</name>
  <files>/home/user/projects/AAA/swarm/swarm/cli.py</files>
  <action>
    Add `--panes` flag to the status subparser (around line 512). The flag should:
    - Be a boolean flag (store_true)
    - Default to False
    - Appear in help: "Display tmux window pane snapshots"
  </action>
  <verify>
    grep -n "panes" /home/user/projects/AAA/swarm/swarm/cli.py | grep -q "add_argument.*--panes"
  </verify>
  <done>
    Status subparser accepts --panes flag, args.panes is True when specified
  </done>
</task>

<task type="auto">
  <name>Create pane display formatter function</name>
  <files>/home/user/projects/AAA/swarm/swarm/cli.py</files>
  <action>
    Add `format_pane_output()` function before `cmd_status()` that:
    1. Takes Dict[str, str] from capture_all_windows()
    2. Filters to required windows: ["master", "worker-0", "worker-1", "worker-2"]
    3. For each window:
       - Extract last 20 lines from content
       - Determine status icon:
         - `[ERROR]` if content contains "Error" or "Failed" (case-insensitive)
         - `[DONE]` if content contains "DONE" or "Complete" (case-insensitive)
         - `[ ]` otherwise
       - Format output: `=== {window_name} [{status}] ===\n{content}\n`
    4. For missing windows, show: `=== {window_name} [ ] ===\n(missing)\n`
    5. Returns formatted string
  </action>
  <verify>
    grep -n "def format_pane_output" /home/user/projects/AAA/swarm/swarm/cli.py
  </verify>
  <done>
    format_pane_output() exists and returns correctly formatted pane snapshots
  </done>
</task>

<task type="auto">
  <name>Modify cmd_status() to handle --panes flag</name>
  <files>/home/user/projects/AAA/swarm/swarm/cli.py</files>
  <action>
    Update `cmd_status()` function to:
    1. Check if `args.panes` is True
    2. If panes enabled:
       - Check if tmux is installed using `check_tmux_installed()`
       - If not installed: print "[WARNING] tmux not available, skipping pane display"
       - If installed: try to use TmuxCollaboration.capture_all_windows()
         - If session exists: format and append pane output
         - If session doesn't exist: skip panes silently (existing status message unchanged)
    3. Preserve all existing behavior when --panes is not specified
  </action>
  <verify>
    grep -n "args.panes" /home/user/projects/AAA/swarm/swarm/cli.py
  </verify>
  <done>
    cmd_status() appends pane snapshots when --panes is specified
  </done>
</task>

<task type="auto">
  <name>Create unit tests for pane display formatter</name>
  <files>/home/user/projects/AAA/swarm/tests/test_cli_status_panes.py</files>
  <action>
    Create test file with tests for format_pane_output():
    - Test status icon detection: Error, Done, Neutral cases
    - Test 20-line limit on content
    - Test missing window display
    - Test window order: master, worker-0, worker-1, worker-2
    - Test filtering of extra windows
  </action>
  <verify>
    pytest tests/test_cli_status_panes.py -v --tb=short 2>&1 | head -50
  </verify>
  <done>
    All unit tests pass for pane display formatting
  </done>
</task>

<task type="auto">
  <name>Create integration test for --panes flag</name>
  <files>/home/user/projects/AAA/swarm/tests/test_cli_status_panes.py</files>
  <action>
    Add integration test function `test_status_panes_flag` that:
    1. Uses existing `run_swarm_command()` from test_e2e_happy_path
    2. Creates tmux session with swarm up
    3. Runs `swarm status --panes`
    4. Verifies output contains pane sections
    5. Runs `swarm status` (without --panes) and verifies no pane sections
    6. Cleans up with swarm down
  </action>
  <verify>
    pytest tests/test_cli_status_panes.py::test_status_panes_flag -v --tb=short
  </verify>
  <done>
    Integration test verifies --panes flag works end-to-end
  </done>
</task>

<task type="auto">
  <name>Run full test suite</name>
  <files>/home/user/projects/AAA/swarm/tests/test_cli_status_panes.py</files>
  <action>
    Run the full test suite to verify no regressions:
    - pytest tests/test_cli_status_panes.py -v
    - pytest tests/test_e2e_happy_path.py -v (verify existing functionality)
  </action>
  <verify>
    pytest tests/test_cli_status_panes.py tests/test_e2e_happy_path.py -v --tb=short 2>&1 | tail -30
  </verify>
  <done>
    All tests pass, no regressions introduced
  </done>
</task>

</tasks>

<verification>
1. Manual verification:
   - `swarm status --help` shows --panes flag
   - `swarm status` (no session) shows existing message
   - `swarm status --panes` (no session) shows warning and returns 0

2. Automated verification:
   - pytest tests/test_cli_status_panes.py -v passes
   - pytest tests/test_e2e_happy_path.py -v passes
</verification>

<success_criteria>
1. `swarm status` outputs existing task status unchanged
2. `swarm status --panes` outputs existing status + 4 window pane snapshots
3. Each pane shows status icon: [ERROR], [DONE], or [ ]
4. Window order: master, worker-0, worker-1, worker-2
5. Missing windows show (missing) placeholder
6. tmux unavailable: prints warning, skips panes, returns 0
7. All tests pass (unit + integration)
</success_criteria>

<output>
After completion, create `.planning/phases/09-cli-status-enhancement/09-01-SUMMARY.md`
</output>
