---
wave: 1
depends_on: []
files_modified:
  - scripts/_common.sh
  - scripts/claude_comm.sh
  - scripts/claude_poll.sh
  - scripts/claude_status.sh
  - scripts/swarm_status_log.sh
  - scripts/swarm_lock.sh
  - scripts/swarm_e2e_test.sh
autonomous: true
---

## Goal
Create scripts/_common.sh with source guard, unified logging functions, and environment variable compatibility, then update all 6 existing scripts to source it.

## Analysis of Current Scripts

| Script | Current Variable Pattern | Raw echo Locations |
|--------|-------------------------|-------------------|
| claude_comm.sh | `SESSION="${CLAUDE_SESSION:-swarm-claude-default}"` | Lines 56, 71, 94, 102, 127-140, 149-175 |
| claude_poll.sh | `SESSION="${CLAUDE_SESSION:-swarm-claude-default}"` | Lines 40-45, 51, 67-71, 75 |
| claude_status.sh | `SESSION="${CLAUDE_SESSION:-swarm-claude-default}"` | Lines 37-38, 43-45 |
| swarm_status_log.sh | `STATE_DIR="${SWARM_STATE_DIR:-/tmp/ai_swarm}"` | Lines 102, 116, 121, 141, 146, 158 |
| swarm_lock.sh | `SWARM_STATE_DIR="${SWARM_STATE_DIR:-/tmp/ai_swarm}"` | Error messages use >&2 echo |
| swarm_e2e_test.sh | Creates temp STATE_DIR for isolation | Lines 55-60, 67, 95-105 |

## Tasks

### 1. Create scripts/_common.sh
```bash
#!/usr/bin/env bash
# NOTE: No set -euo pipefail here - this file is sourced, not executed directly
# Each calling script should set its own error handling

# Guard: only allow sourcing, not direct execution
[[ "${BASH_SOURCE[0]}" != "${0}" ]] || exit 1

# Environment variables with fallbacks
# Priority: explicit value > CLAUDE_SESSION (v1.3 compat) > SESSION_NAME > swarm-claude-default
SWARM_STATE_DIR="${SWARM_STATE_DIR:-/tmp/ai_swarm}"
SESSION_NAME="${CLAUDE_SESSION:-${SESSION_NAME:-swarm-claude-default}}"
export SWARM_STATE_DIR SESSION_NAME

# Unified logging functions (output to stderr, NOT stdout)
# IMPORTANT: Use these for status/debug messages only, NOT for actual data output
log_info() { echo "[$(date +%H:%M:%S)][INFO] $*" >&2; }
log_warn() { echo "[$(date +%H:%M:%S)][WARN] $*" >&2; }
log_error() { echo "[$(date +%H:%M:%S)][ERROR] $*" >&2; }
```

### 2. Update claude_comm.sh
- Add after line 2: `SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"` and `source "$SCRIPT_DIR/_common.sh"`
- Replace line 21: `SESSION="${CLAUDE_SESSION:-swarm-claude-default}"` with `SESSION="${SESSION_NAME}"`
  - **Compatibility note:** `SESSION` variable is kept for backward compatibility with callers that may expect it
  - `SESSION_NAME` from _common.sh is the source of truth
- Replace raw echo statements with log_info/log_error:
  - Line 56: `echo "Sent task $task_id to window $window"` -> `log_info "Sent task $task_id to window $window"`
  - Line 71: `echo "Sent raw message to window $window"` -> `log_info "Sent raw message to window $window"`
  - Line 110: `echo "Timeout: No marker found..."` -> `log_warn "Timeout: No marker found..."`
- **IMPORTANT:** Keep raw `echo` for data output (poll results returned to caller are stdout)
- Note: Usage/help messages can remain as raw echo (user-facing output)

### 3. Update claude_poll.sh
- Add after line 2: `SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"` and `source "$SCRIPT_DIR/_common.sh"`
- Remove lines 15-16: `SESSION` variable declaration (now uses SESSION_NAME from _common.sh)
- Replace raw echo statements with log_info:
  - Lines 40-45: Startup banner -> `log_info` calls
  - Line 51: Timestamp line -> `log_info "=== $(date '+%Y-%m-%d %H:%M:%S') ==="`
  - Lines 67-71: Window status lines -> `log_info` calls
- Keep Ctrl+C message (line 48) as-is for user feedback

### 4. Update claude_status.sh
- Add after line 2: `SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"` and `source "$SCRIPT_DIR/_common.sh"`
- Remove line 15: `SESSION` variable declaration
- Replace raw echo statements with log_info:
  - Line 37: `echo "=== Claude Swarm Status ==="` -> `log_info "=== Claude Swarm Status ==="`
  - Line 43: `echo "--- $window ---"` -> `log_info "--- $window ---"`

### 5. Update swarm_status_log.sh
- Add after line 2: `SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"` and `source "$SCRIPT_DIR/_common.sh"`
- Remove line 5: `STATE_DIR` variable declaration (now uses SWARM_STATE_DIR from _common.sh)
- Replace `STATE_DIR` with `SWARM_STATE_DIR` on line 6
- Replace error echo statements with log_error:
  - Line 56: `echo "Error: Invalid type..."` -> `log_error "Invalid type '$type'. Valid types: ${VALID_TYPES[*]}"`
- Note: Output messages (lines 102, 116, 121, 141, 146, 158) can stay as raw echo for data output

### 6. Update swarm_lock.sh
- Add after line 5: `SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"` and `source "$SCRIPT_DIR/_common.sh"`
- Remove line 8: `SWARM_STATE_DIR` variable declaration (now from _common.sh)
- Error messages already use `>&2`, can optionally use `log_error` instead

### 7. Update swarm_e2e_test.sh
- Add after line 5: `SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"` and `source "$SCRIPT_DIR/_common.sh"`
- **IMPORTANT:** Keep local STATE_DIR logic (line 8: `STATE_DIR=$(mktemp -d)`) for test isolation
  - This LOCAL variable takes precedence over SWARM_STATE_DIR from _common.sh
  - e2e tests use isolated temp directory intentionally
- Replace raw echo statements with log_info:
  - Lines 55-60: Test header and info -> `log_info` calls
  - Line 67: `echo "Dependencies verified"` -> `log_info "Dependencies verified"`
- Note: assert_pass function already has its own output format, keep as-is

## must_haves
- [ ] scripts/_common.sh exists with source guard, exports, and logging functions
- [ ] All 6 scripts source _common.sh at startup
- [ ] All scripts use log_info/log_warn/log_error for status messages (NOT data output)
- [ ] Backward compatibility: CLAUDE_SESSION and SESSION variables still work for v1.3 scripts
- [ ] All scripts run without errors: `bash scripts/claude_comm.sh help` (and others)

## must_not_haves
- [ ] No scripts execute _common.sh directly (source guard prevents this)
- [ ] No duplicate variable declarations after sourcing _common.sh
- [ ] No removal of actual data output (poll results, status content, etc.)
- [ ] **No use of log_* functions for actual data output** - log_* goes to stderr

## Verification
```bash
# Test _common.sh source guard
bash scripts/_common.sh  # Should exit with code 1
echo "Exit code: $?"  # Should be 1

# Verify all scripts still work
bash scripts/claude_comm.sh help
bash scripts/claude_poll.sh --help 2>&1 | head -5
bash scripts/claude_status.sh --help 2>&1 | head -5
bash scripts/swarm_status_log.sh help
bash scripts/swarm_lock.sh help
bash scripts/swarm_e2e_test.sh help

# Verify SESSION_NAME is exported
source scripts/_common.sh && echo "SESSION_NAME=$SESSION_NAME"

# Verify SWARM_STATE_DIR is exported
source scripts/_common.sh && echo "SWARM_STATE_DIR=$SWARM_STATE_DIR"

# Test CLAUDE_SESSION backward compatibility
CLAUDE_SESSION=test-session source scripts/_common.sh && echo "SESSION_NAME=$SESSION_NAME"
```

## Notes
- **Order:** Create _common.sh first (executable), then update scripts one by one
- **set -euo pipefail:** NOT included in _common.sh because it's sourced - each script sets its own
- **log_* functions:** Output to stderr (`>&2`), use ONLY for status/debug messages, NOT for data output
  - Poll results, query output, status content are data â†’ use raw echo to stdout
- **Variable compatibility:**
  - `SESSION_NAME` from _common.sh is the source of truth
  - `SESSION="${SESSION_NAME}"` in scripts maintains backward compatibility
- **e2e test isolation:** `STATE_DIR=$(mktemp -d)` is LOCAL variable, takes precedence over SWARM_STATE_DIR from _common.sh
- claude_comm.sh has complex --session flag parsing, keep that logic but use SESSION_NAME from _common.sh
