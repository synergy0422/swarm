---
phase: 11-communication-script-implementation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: true
---

# Plan: 通信脚本实现

## Goal
实现外部脚本通过 tmux send-keys/capture-pane 与 Claude CLI 窗口通信

**Purpose:** 为多 Agent 并行协作提供外部控制能力，使外部脚本可以向 Worker 窗口发送任务并接收状态反馈

**Output:** 3 个可执行的 bash 脚本，实现任务发送、状态轮询和窗口监控功能

## Tasks

<task type="auto">
  <name>Create scripts directory and claude_comm.sh</name>
  <files>/home/user/projects/AAA/swarm/scripts/claude_comm.sh</files>
  <action>
    Create `/home/user/projects/AAA/swarm/scripts/` directory.

    Create `/home/user/projects/AAA/swarm/scripts/claude_comm.sh` with:
    - Shebang: `#!/usr/bin/env bash` with `set -euo pipefail`
    - SESSION variable: `SESSION="swarm-claude-default"`
    - `send` function: accepts `<window> <task_id> "<description>"`, sends `[TASK] {task_id}` then description via tmux send-keys
    - `poll` function: accepts `<window> [timeout] [task_id]`, captures pane output, parses `[ACK|DONE|ERROR|WAIT|HELP]` markers, returns matching lines
    - `status` function: accepts `<window>`, captures last 20 lines of pane output
    - Main entry point: parse subcommand (send/poll/status) and route to function

    Markers to support: `[TASK]`, `[ACK]`, `[DONE]`, `[ERROR]`, `[WAIT]`, `[HELP]`

    Example usage in comments:
    ```bash
    # claude_comm.sh send worker-0 task-001 "创建文件 hello.py"
    # claude_comm.sh poll worker-0 30 task-001
    # claude_comm.sh status worker-0
    ```
  </action>
  <verify>
    `ls -la /home/user/projects/AAA/swarm/scripts/claude_comm.sh` exists
    `head -30 /home/user/projects/AAA/swarm/scripts/claude_comm.sh` shows proper structure
  </verify>
  <done>
    scripts/claude_comm.sh created with send/poll/status functions
  </done>
</task>

<task type="auto">
  <name>Create claude_poll.sh monitoring script</name>
  <files>/home/user/projects/AAA/swarm/scripts/claude_poll.sh</files>
  <action>
    Create `/home/user/projects/AAA/swarm/scripts/claude_poll.sh` with:
    - Shebang: `#!/usr/bin/env bash`
    - SESSION variable: `SESSION="swarm-claude-default"`
    - WINDOWS variable: `WINDOWS="worker-0 worker-1 worker-2"`
    - POLL_INTERVAL variable: default 5 seconds
    - Infinite loop that:
      - For each worker window, captures last 200 lines
      - Filters for `[DONE]` or `[ERROR]` markers
      - Outputs timestamped status lines when status changes
      - Sleeps POLL_INTERVAL between cycles

    Include Ctrl+C handling hint in comments.
  </action>
  <verify>
    `ls -la /home/user/projects/AAA/swarm/scripts/claude_poll.sh` exists
    `head -20 /home/user/projects/AAA/swarm/scripts/claude_poll.sh` shows polling logic
  </verify>
  <done>
    scripts/claude_poll.sh created with continuous monitoring capability
  </done>
</task>

<task type="auto">
  <name>Create claude_status.sh and make scripts executable</name>
  <files>/home/user/projects/AAA/swarm/scripts/claude_status.sh</files>
  <action>
    Create `/home/user/projects/AAA/swarm/scripts/claude_status.sh` with:
    - Shebang: `#!/usr/bin/env bash`
    - SESSION variable: `SESSION="swarm-claude-default"`
    - Header: `=== Claude Swarm Status ===`
    - Loop through all windows: `master worker-0 worker-1 worker-2`
    - For each window, capture last 10 lines and display with window separator

    Then make all scripts executable:
    ```bash
    chmod +x /home/user/projects/AAA/swarm/scripts/claude_comm.sh /home/user/projects/AAA/swarm/scripts/claude_poll.sh /home/user/projects/AAA/swarm/scripts/claude_status.sh
    ```
  </action>
  <verify>
    `ls -la /home/user/projects/AAA/swarm/scripts/*.sh` shows executable permissions (x)
  </verify>
  <done>
    All 3 scripts created and executable
  </done>
</task>

<task type="checkpoint:human-verify">
  <what-built>
    Complete communication script suite:
    - claude_comm.sh (send/poll/status commands)
    - claude_poll.sh (continuous monitoring)
    - claude_status.sh (quick status check)
  </what-built>
  <how-to-verify>
    Prerequisites:
    1. Start 4-window swarm: `./run_claude_swarm.sh`
    2. Wait for all windows to show Claude CLI prompt

    Test 1 - Send task:
    ```bash
    ./scripts/claude_comm.sh send worker-0 task-001 "创建文件 hello.py，内容是 'hello world'"
    ```
    Check worker-0 pane shows `[TASK] task-001` and description

    Test 2 - Poll ACK:
    ```bash
    ./scripts/claude_comm.sh poll worker-0 10 task-001
    ```
    Should return line containing `[ACK] task-001` (may need to wait a few seconds)

    Test 3 - Poll DONE:
    ```bash
    ./scripts/claude_comm.sh poll worker-0 120 task-001
    ```
    Should return line containing `[DONE] task-001` when Claude finishes

    Test 4 - Status check:
    ```bash
    ./scripts/claude_status.sh
    ```
    Should display last 10 lines from each of the 4 windows

    Test 5 - Verify no Python changes:
    ```bash
    git diff --name-only swarm/
    ```
    Should return empty (no modifications)
  </how-to-verify>
  <resume-signal>
    Type "approved" or describe any failures with:
    - Which test failed
    - Expected vs actual behavior
    - Any error messages observed
  </resume-signal>
</task>

## Verification Criteria

- [ ] `/home/user/projects/AAA/swarm/scripts/claude_comm.sh send` sends `[TASK] {task_id}` to specified window
- [ ] `/home/user/projects/AAA/swarm/scripts/claude_comm.sh poll` returns `[ACK|DONE|ERROR|WAIT|HELP]` markers
- [ ] `/home/user/projects/AAA/swarm/scripts/claude_poll.sh` continuously monitors worker windows
- [ ] `/home/user/projects/AAA/swarm/scripts/claude_status.sh` displays status from all 4 windows
- [ ] `git diff --name-only swarm/` shows no modified files
- [ ] Manual验收: send → ACK → DONE flow works

## must_haves

  truths:
    - "External scripts can send tasks to Claude CLI windows via tmux send-keys"
    - "Scripts can poll and parse [ACK]/[DONE]/[ERROR] markers from window output"
    - "Continuous monitoring script works for all worker windows"
    - "Quick status check shows all 4 window states"
    - "No swarm/*.py files were modified"

  artifacts:
    - path: "/home/user/projects/AAA/swarm/scripts/claude_comm.sh"
      provides: "Core communication (send/poll/status commands)"
      exports: ["send", "poll", "status"]
    - path: "/home/user/projects/AAA/swarm/scripts/claude_poll.sh"
      provides: "Continuous monitoring of worker windows"
    - path: "/home/user/projects/AAA/swarm/scripts/claude_status.sh"
      provides: "Quick status overview of all windows"

  key_links:
    - from: "claude_comm.sh send"
      to: "tmux session: swarm-claude-default"
      via: "tmux send-keys -t $SESSION:$window"
    - from: "claude_comm.sh poll"
      to: "tmux session: swarm-claude-default"
      via: "tmux capture-pane -t $SESSION:$window -p"
    - from: "claude_poll.sh"
      to: "worker-0, worker-1, worker-2 windows"
      via: "tmux capture-pane for each window in loop"
