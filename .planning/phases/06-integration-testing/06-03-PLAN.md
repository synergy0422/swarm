---
phase: 06-integration-testing
plan: 03
type: execute
wave: 2
depends_on: []
files_modified:
  - tests/test_e2e_auto_rescue.py (new)
autonomous: true

must_haves:
  truths:
    - "Unit test: AutoRescuer with mock tmux manager"
    - "Test verifies Press ENTER pattern detection and send_enter call"
    - "Test is marked @pytest.mark.unit (mock-based, no real tmux)"
    - "Test does NOT require real tmux panes or Master integration"
    - "Uses mock TmuxSwarmManager for controlled testing"
  artifacts:
    - path: "tests/test_e2e_auto_rescue.py"
      provides: "Semi-black-box test for AutoRescuer with mock tmux"
      min_lines: 100
      contains: ["test_press_enter_auto_rescue_mock"]
      marks: ["@pytest.mark.unit"]
  key_links:
    - from: "tests/test_e2e_auto_rescue.py"
      to: "swarm/auto_rescuer.py"
      via: "AutoRescuer.send_enter() and pattern detection"
      pattern: "AutoRescuer|send_enter"
    - from: "tests/test_e2e_auto_rescue.py"
      to: "swarm/tmux_manager.py"
      via: "Mock TmuxSwarmManager for testing"
      pattern: "Mock|TmuxSwarmManager"
---

<objective>
Create semi-black-box test for AutoRescuer with mock tmux manager

Purpose: Test AutoRescuer pattern detection and send_enter without real tmux
Output: tests/test_e2e_auto_rescue.py with mock-based integration test
</objective>

<execution_context>
@/home/user/.claude/get-shit-done/workflows/execute-plan.md
@/home/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-integration-testing/06-CONTEXT.md
@swarm/auto_rescuer.py (AutoRescuer, WaitPatternDetector, PatternCategory)
@swarm/tmux_manager.py (TmuxSwarmManager)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create test_e2e_auto_rescue.py with mock tmux manager</name>
  <files>tests/test_e2e_auto_rescue.py</files>
  <action>
Create `tests/test_e2e_auto_rescue.py` with:

1. **Imports:**
   ```python
   import pytest
   from unittest.mock import Mock, patch, MagicMock
   from datetime import datetime, timedelta
   ```

2. **Module marker:**
   ```python
   pytestmark = pytest.mark.unit  # Mock-based, not real tmux integration
   ```

3. **Mock TmuxSwarmManager fixture:**
   ```python
   @pytest.fixture
   def mock_tmux_manager():
       """Create a mock TmuxSwarmManager for testing AutoRescuer."""
       manager = Mock()
       agent = Mock()
       agent.send_keys = Mock()
       agent.pane = Mock()
       agent.pane.send_keys = Mock()
       manager._agents = {'worker-0': agent}
       return manager
   ```

4. **Test helper: capture_pane_output_mock:**
   ```python
   def capture_pane_output_mock(manager, worker_id='worker-0'):
       """Mock capture pane - returns output set in test."""
       agent = manager._agents.get(worker_id)
       if agent:
           return getattr(agent, '_captured_output', '')
       return ''
   ```

5. **Test helper: set_pane_output_mock:**
   ```python
   def set_pane_output_mock(manager, worker_id, output):
       """Set mock pane output for testing."""
       agent = manager._agents.get(worker_id)
       if agent:
           agent._captured_output = output
   ```
  </action>
  <verify>
Run: `pytest tests/test_e2e_auto_rescue.py -v --collect-only`
Expected: Shows 1 test function collected
  </verify>
  <done>
Test file created with mock fixtures
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement test_press_enter_auto_rescue_mock</name>
  <files>tests/test_e2e_auto_rescue.py</files>
  <action>
Add the semi-black-box test:

```python
def test_press_enter_auto_rescue_mock(mock_tmux_manager):
    """
    Semi-black-box test: Verify AutoRescuer sends Enter for Press ENTER patterns.

    This test:
    1. Creates AutoRescuer with mock tmux manager
    2. Enables auto-rescue
    3. Injects "Press ENTER to continue" pattern
    4. Verifies send_enter was called on the mock agent

    Note: This is a semi-black-box test - we mock tmux manager but test
    the real AutoRescuer logic. It does NOT require real tmux panes
    or Master integration (which is not yet implemented).
    """
    from swarm.auto_rescuer import AutoRescuer

    # Create rescuer with mock manager
    rescuer = AutoRescuer(mock_tmux_manager)
    rescuer.enable()

    # Set mock pane output with Press ENTER pattern
    set_pane_output_mock(mock_tmux_manager, 'worker-0',
                         'Processing...\nPress ENTER to continue...\nDone.')

    # Capture pane output for pattern detection
    output = capture_pane_output_mock(mock_tmux_manager, 'worker-0')
    recent_threshold = datetime.now() - timedelta(seconds=30)

    # Check and rescue - should detect Press ENTER and send Enter
    pattern = rescuer.check_and_rescue('worker-0', output, recent_threshold)

    # Verify pattern was detected
    assert pattern is not None, "Press ENTER pattern should be detected"
    assert pattern.should_auto_confirm is True, "Press ENTER should auto-confirm"

    # Verify send_enter was called on the mock agent
    mock_tmux_manager._agents['worker-0'].pane.send_keys.assert_called_once_with('', enter=True)

    # Cleanup
    rescuer.disable()
```

Key points:
- Semi-black-box: real AutoRescuer + mock tmux manager
- Tests Press ENTER pattern detection (not [y/n] or blacklist)
- Verifies send_enter is called with correct arguments
- No real tmux or Master integration required
- Fast and deterministic (no timing issues)
  </action>
  <verify>
Run: `pytest tests/test_e2e_auto_rescue.py -v -s`
Expected: Test passes, send_keys called with ('', enter=True)
  </verify>
  <done>
Semi-black-box AutoRescuer test implemented
  </done>
</task>

</tasks>

<verification>
After all tasks complete, verify:

1. **Test collection:** `pytest tests/test_e2e_auto_rescue.py -v --collect-only` shows 1 test
2. **Test runs:** `pytest tests/test_e2e_auto_rescue.py -v` runs the test (unit marker)
3. **Mock verification:** send_keys.assert_called_once_with('', enter=True)
4. **No tmux dependency:** Test uses mock manager, not real tmux
5. **No API dependency:** Test does not require LLM API keys
</verification>

<success_criteria>
Phase 6 Plan 03 complete when:
- tests/test_e2e_auto_rescue.py exists with 100+ lines
- 1 semi-black-box test for AutoRescuer
- Test marked @pytest.mark.unit
- Uses mock TmuxSwarmManager
- Test passes with mock verification
- No real tmux or Master integration required
</success_criteria>

<output>
After completion, create `.planning/phases/06-integration-testing/06-03-SUMMARY.md`
</output>
