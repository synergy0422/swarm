---
phase: 06-integration-testing
plan: "05"
type: fix
wave: 3
depends_on: []
gap_closure: true
files_modified:
  - tests/test_e2e_auto_rescue.py
  - .planning/phases/06-integration-testing/06-03-PLAN.md
  - .planning/phases/06-integration-testing/06-CONTEXT.md
autonomous: true

must_haves:
  truths:
    - "Gap: Plan says 1 test with @pytest.mark.unit, actual is 12 tests"
    - "Fix: Change marker to @pytest.mark.integration in test file and update plans"
    - "12 tests provide comprehensive pattern detection and edge case coverage"
  artifacts:
    - path: "tests/test_e2e_auto_rescue.py"
      change: "Change pytestmark from @pytest.mark.unit to @pytest.mark.integration"
      line_range: [31, 33]
    - path: ".planning/phases/06-integration-testing/06-03-PLAN.md"
      change: "Update test count from 1 to 12, marker from unit to integration"
    - path: ".planning/phases/06-integration-testing/06-CONTEXT.md"
      change: "Update test count references"
---

<objective>
Fix P6-03 marker/testcount mismatch in test_e2e_auto_rescue.py

Purpose: Align plan with implementation (12 tests, integration marker)
Output: Updated plan file, test file, and context
</objective>

<execution_context>
@/home/user/.claude/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@tests/test_e2e_auto_rescue.py (12 tests collected)
@.planning/phases/06-integration-testing/06-03-PLAN.md (plan specifies 1 test, unit marker)
@.planning/phases/06-integration-testing/06-UAT.md (gap diagnosis)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Change test marker from unit to integration</name>
  <files>tests/test_e2e_auto_rescue.py</files>
  <action>
In `tests/test_e2e_auto_rescue.py`, change line 31-33 from:

```python
pytestmark = pytest.mark.unit  # Mock-based, not real tmux integration
```

To:

```python
pytestmark = pytest.mark.integration  # Semi-black-box tests with mock tmux
```

These tests use mock-based tmux manager but test AutoRescuer with real pattern detection logic, which fits the integration test definition better than unit tests.
  </action>
  <verify>
Verify with: `pytest tests/test_e2e_auto_rescue.py -v --collect-only 2>&1 | grep -E "(integration|collected)"`
  </verify>
  <done>
Test marker changed to integration
  </done>
</task>

<task type="auto">
  <name>Task 2: Update 06-03-PLAN.md with correct test count and marker</name>
  <files>.planning/phases/06-integration-testing/06-03-PLAN.md</files>
  <action>
Update 06-03-PLAN.md:

1. Change test count from 1 to 12 in must_haves/artifacts
2. Change marker from @pytest.mark.unit to @pytest.mark.integration
3. Update success_criteria to reflect 12 tests
4. Update verification section

Specific changes:
- Line 23: `marks: ["@pytest.mark.unit"]` → `marks: ["@pytest.mark.integration"]`
- Line 189: "shows 1 test" → "shows 12 tests"
- Line 199: "1 semi-black-box test" → "12 semi-black-box tests"
- Update success_criteria line 198-199 accordingly
</action>
  <verify>
Verify plan still valid YAML and coherent
  </verify>
  <done>
06-03-PLAN.md updated with 12 tests and integration marker
  </done>
</task>

<task type="auto">
  <name>Task 3: Update 06-CONTEXT.md if needed</any>
  <files>.planning/phases/06-integration-testing/06-CONTEXT.md</files>
  <action>
Review 06-CONTEXT.md for any references to:
- Test count for auto_rescue tests
- @pytest.mark.unit usage

Update if necessary to reflect the 12 integration tests.
</action>
  <verify>
Verify context file consistency
  </verify>
  <done>
06-CONTEXT.md reviewed and updated if needed
  </done>
</task>

</tasks>

<verification>
After all tasks complete, verify:

1. **Test marker:** `pytest tests/test_e2e_auto_rescue.py -v --collect-only` shows @pytest.mark.integration
2. **Test count:** 12 tests collected (not 1)
3. **Test runs:** `pytest tests/test_e2e_auto_rescue.py -v -m integration` runs all 12 tests
4. **Plan consistency:** 06-03-PLAN.md reflects 12 tests and integration marker
</verification>

<success_criteria>
Gap P6-03 closed when:
- tests/test_e2e_auto_rescue.py uses @pytest.mark.integration
- 06-03-PLAN.md updated to reflect 12 tests
- All 12 tests can be collected and run with `-m integration`
- 06-CONTEXT.md reviewed and consistent
</success_criteria>

<output>
After completion, update .planning/phases/06-integration-testing/06-UAT.md to mark P6-03 as FIXED
</output>
