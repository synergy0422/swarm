---
id: 07-01
wave: 1
autonomous: true
must_haves:
  - swarm/tmux_collaboration.py
  - tests/test_tmux_collaboration.py
---

# Phase 7: 协作命令封装

**目标**: 新增 `tmux_collaboration.py`，封装批量窗口操作（使用 libtmux）

## 任务 1: 创建 `TmuxCollaboration` 类

**文件**: `swarm/tmux_collaboration.py`（新增）

**实现内容**:

```python
from typing import Dict, List, Optional
import libtmux


class TmuxCollaboration:
    """
    Tmux 协作命令封装 - 批量窗口操作

    封装参考文档中的协作模式：
    - for w in $(tmux list-windows -a)
    - tmux capture-pane -t "$w" -p -S -30
    - tmux send-keys -t "0:$w" "y" Enter
    """

    def __init__(self, server: Optional[libtmux.Server] = None):
        self.server = server or libtmux.Server()

    def list_windows(self, session_name: str) -> List[Dict]:
        """列出会话所有窗口"""
        session = self.server.find_where({"session_name": session_name})
        if not session:
            return []

        windows = []
        for w in session.windows:
            windows.append({
                "name": w.get("window_name"),
                "index": w.get("window_index"),
                "activity": w.get("window_activity", "unknown"),
            })
        return windows

    def capture_pane(self, session_name: str, window_index: str) -> str:
        """捕获指定窗口的 pane 内容"""
        session = self.server.find_where({"session_name": session_name})
        if not session:
            return ""

        window = session.find_where({"window_index": window_index})
        if not window:
            return ""

        result = window.active_pane.cmd("capture-pane", "-p", "-S", "-30")
        return "\n".join(result.stdout) if result.stdout else ""

    def capture_all_windows(self, session_name: str) -> Dict[str, str]:
        """批量捕获所有窗口内容（4 Window 可视化核心）"""
        windows = self.list_windows(session_name)
        outputs = {}

        for w in windows:
            index = w["index"]
            name = w["name"]
            content = self.capture_pane(session_name, index)
            outputs[name] = content

        return outputs

    def send_keys_to_window(
        self,
        session_name: str,
        window_index: str,
        keys: str,
        enter: bool = True
    ) -> None:
        """向指定窗口发送按键"""
        session = self.server.find_where({"session_name": session_name})
        if not session:
            return

        window = session.find_where({"window_index": window_index})
        if not window:
            return

        if enter:
            window.active_pane.send_keys(keys, enter=True)
        else:
            window.active_pane.send_keys(keys)
```

**验收标准**:
- [ ] `TmuxCollaboration` 类可导入并实例化
- [ ] `list_windows()` 返回包含 master + 3 workers 的列表
- [ ] `capture_all_windows()` 返回 Dict[window_name, content]
- [ ] `send_keys_to_window()` 正确发送按键

---

## 任务 2: 创建单元测试

**文件**: `tests/test_tmux_collaboration.py`（新增）

**测试要求**:

```python
import pytest
import shutil
import libtmux
from swarm.tmux_collaboration import TmuxCollaboration


# tmux 可用性检查
tmux_available = shutil.which("tmux") is not None
pytestmark = pytest.mark.skipif(
    not tmux_available,
    reason="tmux not installed"
)


@pytest.fixture
def collaboration():
    """创建 TmuxCollaboration 实例"""
    return TmuxCollaboration()


@pytest.fixture
def temp_session():
    """创建临时 tmux session，测试后清理"""
    server = libtmux.Server()
    session = server.new_session(
        session_name="test-swarm-collab",
        attach=False
    )
    yield session
    # 清理：测试结束后删除 session
    session.kill_session()


def test_list_windows(collaboration, temp_session):
    """列出窗口测试"""
    # 创建 3 个 worker 窗口
    for i in range(3):
        temp_session.new_window(window_name=f"worker-{i}")

    windows = collaboration.list_windows("test-swarm-collab")
    assert len(windows) >= 4  # master + 3 workers


def test_capture_pane(collaboration, temp_session):
    """捕获 pane 测试"""
    # 发送测试命令
    temp_session.active_window.active_pane.send_keys("echo hello", enter=True)
    output = collaboration.capture_pane("test-swarm-collab", "0")
    assert "hello" in output


def test_capture_all_windows(collaboration, temp_session):
    """批量捕获所有窗口测试"""
    for i in range(3):
        w = temp_session.new_window(window_name=f"worker-{i}")
        w.active_pane.send_keys(f"echo worker-{i}", enter=True)

    outputs = collaboration.capture_all_windows("test-swarm-collab")
    assert "master" in outputs
    assert "worker-0" in outputs
    assert "worker-1" in outputs
    assert "worker-2" in outputs


def test_send_keys_to_window(collaboration, temp_session):
    """发送按键测试"""
    collaboration.send_keys_to_window(
        "test-swarm-collab", "1", "echo sent"
    )
    output = collaboration.capture_pane("test-swarm-collab", "1")
    assert "sent" in output
```

**验收标准**:
- [ ] 测试包含 session 清理逻辑（`session.kill_session()`）
- [ ] tmux 不可用时测试跳过（`skipif` 标记）
- [ ] 单元测试覆盖率 > 80%

---

## 提交

- `feat(07-01): add TmuxCollaboration class`
- `feat(07-01): add tmux_collaboration tests`
