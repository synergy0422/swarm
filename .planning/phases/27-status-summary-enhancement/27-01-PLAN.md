---
phase: 27-status-summary-enhancement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - /home/user/projects/AAA/swarm/swarm/master.py
  - /home/user/projects/AAA/swarm/tests/test_status_summary.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Status summary table shows last_update timestamp for each window"
    - "Status summary table shows wait_for duration for WAIT states"
    - "Status summary table shows error_streak count for consecutive ERROR states"
    - "WAIT duration displayed while in WAIT state (wait_since_ts cleared on exit)"
    - "ERROR streak increments on consecutive ERROR states, resets on other states"
  artifacts:
    - path: /home/user/projects/AAA/swarm/swarm/master.py
      contains: "class PaneSummary"
      provides: "Enhanced PaneSummary with timestamp fields"
      min_lines: 50
    - path: /home/user/projects/AAA/swarm/swarm/master.py
      contains: "last_update_ts|wait_since_ts|error_streak"
      provides: "New fields for enhanced status tracking"
    - path: /home/user/projects/AAA/swarm/swarm/master.py
      contains: "_format_summary_table"
      provides: "Enhanced table formatting with new columns"
  key_links:
    - from: PaneSummary
      to: stdout
      via: _format_summary_table()
      pattern: "last_update.*wait_for.*error_streak"
---

<objective>
Enhance the status summary table with three new fields: last_update, wait_for, and error_streak. This improves the commander's situational awareness by showing how long panes have been waiting and how many consecutive errors have occurred.

Purpose: Provide better visibility into window states for human operator
Output: Modified master.py with enhanced PaneSummary and formatted output to stdout
</objective>

<execution_context>
@/home/user/.claude/get-shit-done/workflows/execute-plan.md
@/home/user/projects/AAA/swarm/swarm/master.py
</execution_context>

<context>
@/home/user/projects/AAA/swarm/.planning/ROADMAP.md

## Current PaneSummary Implementation

Located in `/home/user/projects/AAA/swarm/swarm/master.py` lines 200-217:

```python
class PaneSummary:
    """Tracks pane state for summary table output."""

    def __init__(self, window_name: str):
        self.window_name = window_name
        self.last_state = 'IDLE'
        self.last_action = ''
        self.task_id = '-'
        self.note = ''
```

## Current Table Format (lines 376-413)

Format: `window | state | task_id | note`

## State Priority

- ERROR(0) > WAIT(1) > RUNNING(2) > START(3) > DONE(4) > SKIP(5) > IDLE(99)

## Required Changes

1. Add fields to PaneSummary.__init__:
   - `last_update_ts`: float (Unix timestamp of last update)
   - `wait_since_ts`: float (Unix timestamp when entered WAIT state)
   - `error_streak`: int (consecutive ERROR count)

2. Update _handle_pane_wait_states() to maintain timestamps

3. Update _update_summary_from_workers() to maintain timestamps

4. Enhance _format_summary_table() to show:
   - `last_update`: "HH:MM:SS" format (absolute time)
   - `wait_for`: Duration in seconds/minutes for WAIT state
   - `error_streak`: Integer count for ERROR state

5. Implement helper methods:
   - `_format_timestamp(ts)`: Format timestamp as "HH:MM:SS" (absolute time)
   - `_format_duration(ts)`: Format duration as "30s", "2m", etc.
</context>

<tasks>

<task type="auto">
  <name>Enhance PaneSummary with timestamp fields</name>
  <files>/home/user/projects/AAA/swarm/swarm/master.py</files>
  <action>
Modify the `PaneSummary` class (lines 200-217) to add three new fields:

1. Add import for `time` module (already imported at line 15)

2. In `PaneSummary.__init__`, add:
   - `self.last_update_ts = time.time()`  # Unix timestamp of last update
   - `self.wait_since_ts = None`           # None when not in WAIT
   - `self.error_streak = 0`               # Consecutive ERROR count

3. Add helper methods to PaneSummary class:
   - `update_state(new_state: str, timestamp: float)` - Update state and maintain timestamps/streaks
   - `_format_timestamp(ts: float) -> str` - Format as "HH:MM:SS" (absolute time)
   - `_format_wait_duration(wait_ts: float) -> str` - Format as "30s", "2m", etc.

   The `update_state()` method behavior:
   ```python
   def update_state(self, new_state: str, timestamp: float):
       """Update state and maintain tracking fields.

       Args:
           new_state: The new state value
           timestamp: Current timestamp from time.time()

       Behavior:
       - last_update_ts: ALWAYS updates regardless of whether state changed
         (consecutive ERROR should update timestamp to show "still failing")
       - wait_since_ts:
         - On WAIT entry: set to timestamp (if not already set)
         - On other states: set to None (cleared on exit)
         - NOTE: Consecutive ERROR does NOT reset wait_since_ts
       - error_streak:
         - On ERROR: increment by 1
         - On other states: reset to 0
       """
   ```

4. Update `_handle_pane_wait_states()` method to:
   - Call `summary.update_state()` when state changes
   - Set `wait_since_ts` when entering WAIT state
   - Increment `error_streak` when entering ERROR state
   - Reset `error_streak` to 0 when entering non-ERROR state

5. Update `_update_summary_from_workers()` method to:
   - Call `summary.update_state()` when worker state changes
   - Maintain consistent timestamp behavior
</action>
  <verify>
Run the following to verify the changes:

```bash
# Check PaneSummary has new fields
grep -A 10 "class PaneSummary" swarm/master.py | grep -E "last_update_ts|wait_since_ts|error_streak"

# Check helper methods exist
grep -n "_format_timestamp\|_format_wait_duration\|update_state" swarm/master.py
```
</verify>
  <done>
PaneSummary class has last_update_ts, wait_since_ts, and error_streak fields with update_state() method that correctly manages timestamps and streaks</done>
</task>

<task type="auto">
  <name>Enhance summary table formatting with new columns</name>
  <files>/home/user/projects/AAA/swarm/swarm/master.py</files>
  <action>
Modify `_format_summary_table()` method (around line 376) to include new columns:

1. Update header line from:
   ```
   WINDOW         STATE    TASK_ID    NOTE
   ```
   To:
   ```
   WINDOW         STATE    TASK_ID    LAST_UPDATE       WAIT_FOR   ERR    NOTE
   ```

2. Update column widths:
   - window: 12 chars
   - state: 8 chars
   - task_id: 10 chars
   - last_update: 8 chars (HH:MM:SS)
   - wait_for: 10 chars (e.g., "30s", "2m", "-")
   - err: 4 chars (error_streak or "-")
   - note: remaining

3. For each summary, compute and display:
   - `last_update`: Format `self.last_update_ts` as "HH:MM:SS" (absolute time)
   - `wait_for`: Calculate `(now - self.wait_since_ts)` if in WAIT, else "-"
   - `err`: Show `self.error_streak` if > 0, else "-"

   Output format rules:
   ```python
   # - wait_for:
   #   - If state == WAIT: show duration (e.g., "30s", "2m")
   #   - Else: show "-"
   # - error_streak:
   #   - If state == ERROR: show count (e.g., "1", "3")
   #   - Else: show "-"
   #
   # Example output:
   # WINDOW     STATE    TASK_ID    LAST_UPDATE  WAIT_FOR  ERR  NOTE
   # master     WAIT     task-001   14:32:05    30s       -    "[y/n]"
   # worker-0   ERROR    task-002   14:32:10    -         3    "Conn refused"
   # worker-1   RUNNING  task-003   14:32:15    -         -    ""
   ```

4. Update print statement (line ~407) to include new columns

Example output format:
```
WINDOW         STATE    TASK_ID    LAST_UPDATE       WAIT_FOR   ERR  NOTE
------------------------------------------------------------------------
master         WAIT     task-001   14:32:05          30s        -    "[y/n]"
worker-0       ERROR    task-002   14:31:45          -          3    Connection refused
worker-1       RUNNING  task-003   14:32:10          -          -    -
```
</action>
  <verify>
Run the following to verify:

```bash
# Check enhanced header format
grep -A 5 "_format_summary_table" swarm/master.py | grep -E "LAST_UPDATE|WAIT_FOR|ERR"

# Check the table header and formatting
python3 -c "
import sys
sys.path.insert(0, 'swarm')
from master import PaneSummary, Master
import time

# Test PaneSummary has new fields
ps = PaneSummary('test')
assert hasattr(ps, 'last_update_ts'), 'Missing last_update_ts'
assert hasattr(ps, 'wait_since_ts'), 'Missing wait_since_ts'
assert hasattr(ps, 'error_streak'), 'Missing error_streak'
print('PaneSummary fields: OK')
"
```
</verify>
  <done>
Status summary table outputs to stdout with 7 columns: window, state, task_id, last_update, wait_for, err, and note</done>
</task>

<task type="auto">
  <name>Add unit tests for enhanced status summary</name>
  <files>/home/user/projects/AAA/swarm/tests/test_status_summary.py</files>
  <action>
Add tests for the enhanced PaneSummary functionality:

1. Create new test file tests/test_status_summary.py:

```python
import time
from swarm.master import PaneSummary

class TestPaneSummaryEnhancement:
    """Tests for enhanced PaneSummary with timestamp fields."""

    def test_pane_summary_new_fields_exist(self):
        """Verify PaneSummary has all new fields."""
        ps = PaneSummary('test-window')
        assert hasattr(ps, 'last_update_ts')
        assert hasattr(ps, 'wait_since_ts')
        assert hasattr(ps, 'error_streak')
        assert ps.error_streak == 0

    def test_error_streak_increments_on_consecutive_errors(self):
        """Verify error_streak increments on consecutive ERROR states."""
        ps = PaneSummary('test')
        ps.last_state = 'DONE'
        ps.error_streak = 0

        # First ERROR
        ps.update_state('ERROR')
        assert ps.error_streak == 1

        # Second consecutive ERROR
        ps.update_state('ERROR')
        assert ps.error_streak == 2

        # Third consecutive ERROR
        ps.update_state('ERROR')
        assert ps.error_streak == 3

    def test_error_streak_resets_on_non_error_state(self):
        """Verify error_streak resets when leaving ERROR state."""
        ps = PaneSummary('test')
        ps.error_streak = 3
        ps.update_state('RUNNING')
        assert ps.error_streak == 0

    def test_wait_since_ts_set_on_enter_wait(self):
        """Verify wait_since_ts is set when entering WAIT state."""
        ps = PaneSummary('test')
        ps.wait_since_ts = None
        before = time.time()
        ps.update_state('WAIT')
        after = time.time()
        assert ps.wait_since_ts is not None
        assert before <= ps.wait_since_ts <= after

    def test_wait_since_ts_cleared_on_leave_wait(self):
        """Verify wait_since_ts is cleared when leaving WAIT state."""
        ps = PaneSummary('test')
        ps.wait_since_ts = time.time()
        ps.update_state('RUNNING')
        assert ps.wait_since_ts is None

    def test_timestamp_updated_on_state_change(self):
        """Verify last_update_ts updates on state change."""
        ps = PaneSummary('test')
        old_ts = ps.last_update_ts
        time.sleep(0.01)
        ps.update_state('ERROR')
        assert ps.last_update_ts > old_ts
```

2. Run tests to verify:
```bash
python3 -m pytest tests/test_status_summary.py -v
```
</action>
  <verify>
Run the tests:

```bash
python3 -m pytest tests/test_status_summary.py -v -k "test_pane_summary_new_fields_exist or test_error_streak or test_wait_since"
```
</verify>
  <done>
Unit tests pass for enhanced PaneSummary with timestamp tracking, error_streak counting, and wait_since_ts management</done>
</task>

</tasks>

<verification>
## Phase Verification

Run these commands to verify the phase is complete:

```bash
# 1. Check PaneSummary has new fields
python3 -c "
import sys
sys.path.insert(0, 'swarm')
from swarm.master import PaneSummary
import time

ps = PaneSummary('test')
assert hasattr(ps, 'last_update_ts'), 'Missing last_update_ts'
assert hasattr(ps, 'wait_since_ts'), 'Missing wait_since_ts'
assert hasattr(ps, 'error_streak'), 'Missing error_streak'
print('PaneSummary fields: OK')

# Test error streak
ps.update_state('ERROR')
assert ps.error_streak == 1, 'error_streak should be 1'
ps.update_state('ERROR')
assert ps.error_streak == 2, 'error_streak should be 2'
ps.update_state('RUNNING')
assert ps.error_streak == 0, 'error_streak should reset to 0'
print('error_streak logic: OK')

# Test wait since
ps.update_state('WAIT')
assert ps.wait_since_ts is not None, 'wait_since_ts should be set'
ps.update_state('RUNNING')
assert ps.wait_since_ts is None, 'wait_since_ts should be cleared'
print('wait_since_ts logic: OK')
"

# 2. Check enhanced table format
grep -A 20 "_format_summary_table" swarm/master.py | head -25

# 3. Run all tests
python3 -m pytest tests/test_status_summary.py -v
```

Expected output for enhanced table:
```
WINDOW         STATE    TASK_ID    LAST_UPDATE       WAIT_FOR   ERR  NOTE
------------------------------------------------------------------------
master         WAIT     task-001   14:32:05          30s        -    "[y/n]"
worker-0       ERROR    task-002   14:31:45          -          3    Connection refused
```
</verification>

<success_criteria>
- [ ] PaneSummary class has `last_update_ts`, `wait_since_ts`, `error_streak` fields
- [ ] `update_state()` method correctly manages timestamps and streaks
- [ ] ERROR streak increments on consecutive ERROR states, resets on other states
- [ ] WAIT since timestamp set when entering WAIT, cleared when leaving
- [ ] Status summary table outputs 7 columns to stdout (window, state, task_id, last_update, wait_for, err, note)
- [ ] All unit tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/27-status-summary-enhancement/27-01-SUMMARY.md` documenting:
- Fields added to PaneSummary
- Changes to summary table format
- Test coverage added
</output>
