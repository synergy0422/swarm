---
phase: 04-master-implementation
plan: '02'
type: execute
wave: 1
depends_on: []
files_modified:
  - /home/user/AAA/swarm/swarm/auto_rescuer.py
  - /home/user/AAA/swarm/tests/test_auto_rescuer.py
autonomous: true
user_setup: []
must_haves:
  truths:
    - Master can detect [y/n], [Y/n], Press ENTER, confirm patterns in pane output
    - Detection only checks last 20 lines and recent 30 seconds
    - Auto-confirm disabled by default, only Press ENTER patterns qualify
    - Blacklist keywords (delete, rm -rf, sudo) block auto-confirm
  artifacts:
    - path: /home/user/AAA/swarm/swarm/auto_rescuer.py
      provides: WaitPatternDetector and AutoRescuer classes for WAIT detection
      min_lines: 120
    - path: /home/user/AAA/swarm/tests/test_auto_rescuer.py
      provides: Unit tests for pattern detection and auto-confirm logic
      min_lines: 100
  key_links:
    - from: auto_rescuer.py
      to: master_scanner.py
      via: receives pane output from scanner
    - from: auto_rescuer.py
      to: tmux_manager.py
      via: send_keys for auto-confirm (Enter only)
    - from: auto_rescuer.py
      to: status_broadcaster.py
      via: broadcasts HELP state when blocked
---

<objective>
**Goal:** Implement Auto Rescuer module for detecting WAIT patterns and conservatively auto-confirming.

**Purpose:** Detect when workers are stuck waiting for user input and handle appropriately (conservative - only Enter for safe patterns).

**Output:**
- `/home/user/AAA/swarm/swarm/auto_rescuer.py` - WaitPatternDetector and AutoRescuer classes
- `/home/user/AAA/swarm/tests/test_auto_rescuer.py` - Unit tests for pattern detection
</objective>

<context>
@/home/user/AAA/swarm/.planning/phases/04-master-implementation/04-CONTEXT.md
@/home/user/AAA/swarm/swarm/tmux_manager.py - send_keys method for auto-confirm

**Detection priorities:**
1. **Interactive confirm:** `[y/n]`, `[Y/n]`, `(y/n)`, `y or n`
2. **Press ENTER:** `Press ENTER`, `Press Return`, `hit enter`, `按回车`, `回车继续`, `Press any key to continue`
3. **Confirm prompts:** `confirm`, `are you sure`, `确认`, `确定吗`

**Detection rules:**
- Only check last 20 lines of output
- Pattern must appear within last 30 seconds
- Auto-confirm ONLY for "Press ENTER" type patterns (send Enter key)
- NEVER auto-confirm y/n patterns (blocked by default)

**Blacklist (always block auto-action):**
- `delete`, `remove`, `rm -rf`, `format`, `overwrite`
- `drop database`, `drop table`
- `kill`, `terminate`
- `sudo`, `password`, `token`, `ssh`, `key`
- `生产`, `prod`
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WaitPatternDetector class</name>
  <files>/home/user/AAA/swarm/swarm/auto_rescuer.py</files>
  <action>
Create `auto_rescuer.py` with:

1. **Constants** at module level:
   - `DETECTION_LINE_COUNT = 20` - check last 20 lines
   - `DETECTION_TIME_WINDOW = 30` - 30 seconds window
   - `BLACKLIST_KEYWORDS` - list of blocking keywords

2. **PatternCategory enum:**
   - `INTERACTIVE_CONFIRM` - y/n patterns (priority 1)
   - `PRESS_ENTER` - Enter to continue patterns (priority 2)
   - `CONFIRM_PROMPT` - confirm/are you sure (priority 3)
   - `NONE` - no pattern detected

3. **WaitPattern dataclass:**
   - `category: PatternCategory`
   - `matched_text: str`
   - `line_number: int`
   - `should_auto_confirm: bool` - True only for PRESS_ENTER

4. **WaitPatternDetector class:**
   - `__init__(self)` - initialize patterns
   - `detect(pane_output: str, recent_threshold: datetime) -> Optional[WaitPattern]`
   - `_check_interactive_confirm(lines: List[str]) -> Optional[WaitPattern]`
   - `_check_press_enter(lines: List[str]) -> Optional[WaitPattern]`
   - `_check_confirm_prompt(lines: List[str]) -> Optional[WaitPattern]`
   - `_is_blacklisted(text: str) -> bool`

Use regex for pattern matching where appropriate. All checks case-insensitive.
  </action>
  <verify>
`python -c "from swarm.auto_rescuer import WaitPatternDetector, WaitPattern, PatternCategory; print('AutoRescuer imports OK')"`
  </verify>
  <done>
WaitPatternDetector detects [y/n], Press ENTER, confirm patterns in pane output
</done>
</task>

<task type="auto">
  <name>Task 2: Create AutoRescuer class</name>
  <files>/home/user/AAA/swarm/swarm/auto_rescuer.py</files>
  <action>
Add to `auto_rescuer.py`:

1. **AutoRescuer class:**
   ```python
   class AutoRescuer:
       """Conservative auto-rescue for WAIT patterns."""

       def __init__(self, tmux_manager: TmuxSwarmManager):
           self.tmux_manager = tmux_manager
           self.detector = WaitPatternDetector()
           self._enabled = False  # Always disabled by default
   ```

2. **Key methods:**
   - `check_and_rescue(agent_id: str, pane_output: str) -> Optional[WaitPattern]`
     - Returns pattern if detected, None if safe
     - Blocks auto-confirm if blacklist keyword found
     - Only auto-confirms PRESS_ENTER patterns when enabled

   - `should_request_help(pattern: WaitPattern) -> bool`
     - Returns True if pattern is INTERACTIVE_CONFIRM or has blacklist match
     - This triggers HELP state broadcast

   - `send_enter(agent_id: str) -> bool`
     - Sends Enter key to agent pane
     - Only called for PRESS_ENTER patterns

3. **Auto-confirm policy (conservative):**
   - Default: disabled (`_enabled = False`)
   - Only `send_enter()` for PRESS_ENTER patterns
   - Never send `y`, `yes`, or other inputs
   - Always return pattern info for user to decide on y/n

4. **Import TmuxSwarmManager from swarm.tmux_manager**
  </action>
  <verify>
`python -c "from swarm.auto_rescuer import AutoRescuer; print('AutoRescuer class OK')"`
  </verify>
  <done>
AutoRescuer handles auto-confirm conservatively with blacklist support
</done>
</task>

<task type="auto">
  <name>Task 3: Write unit tests for AutoRescuer</name>
  <files>/home/user/AAA/swarm/tests/test_auto_rescuer.py</files>
  <action>
Create test file following test_status_broadcaster.py patterns:

1. **Test class:** `TestWaitPatternDetector(unittest.TestCase)`

2. **Test cases for detection:**
   - `test_detect_y_n_patterns` - detects `[y/n]`, `[Y/n]`, `(y/n)`
   - `test_detect_press_enter` - detects `Press ENTER to continue`
   - `test_detect_chinese_press_enter` - detects `按回车`, `回车继续`
   - `test_detect_confirm_prompt` - detects `confirm`, `are you sure`
   - `test_detect_none_returns_none` - no pattern returns None
   - `test_detect_only_last_20_lines` - ignores patterns in older lines
   - `test_blacklist_blocks_auto_confirm` - delete/rm -rf/sudo keywords
   - `test_case_insensitive_detection` - `[Y/N]` matches `[y/n]`

3. **Test AutoRescuer:**
   - `test_auto_confirm_disabled_by_default`
   - `test_should_request_help_for_interactive`
   - `test_should_not_auto_confirm_blacklisted`

4. **Use mock for tmux_manager** to avoid actual tmux dependency in tests.

5. **Imports:**
   ```python
   from swarm.auto_rescuer import (
       AutoRescuer, WaitPatternDetector, WaitPattern, PatternCategory
   )
   ```
  </action>
  <verify>
`python -m pytest tests/test_auto_rescuer.py -v --tb=short` - all tests pass
  </verify>
  <done>
All 10+ unit tests for AutoRescuer pass
</done>
</task>

</tasks>

<verification>
- WaitPatternDetector imports successfully
- All pattern types detected correctly ([y/n], Press ENTER, confirm)
- Blacklist keywords block auto-confirm
- Auto-confirm disabled by default
- 10+ unit tests pass
</verification>

<success_criteria>
1. WaitPatternDetector exists with all pattern checks
2. AutoRescuer only auto-confirms Press ENTER patterns
3. Blacklist keywords always block auto-action
4. HELP state is triggered for interactive confirm patterns
5. 10+ unit tests covering detection and auto-confirm logic
</success_criteria>

<output>
After completion, create `.planning/phases/04-master-implementation/04-02-SUMMARY.md`
</output>
