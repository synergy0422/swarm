---
phase: "14-集成验证"
plan: "01"
type: "execute"
wave: "1"
depends_on: []
files_modified: []
autonomous: true
---

# Phase 14: 集成验证执行计划

## Goal

Create E2E test script that verifies status.log and locks/ integration works correctly together.

## Success Criteria

1. `./scripts/swarm_e2e_test.sh` runs successfully (exit 0)
2. All individual tests show PASS
3. `git diff --name-only swarm/` shows no modified files

## Background

**Prior scripts to integrate:**
- `scripts/swarm_status_log.sh` (Phase 12) — append/tail/query status.log
- `scripts/swarm_lock.sh` (Phase 13) — acquire/release/check/list locks

**Test workflow:**
1. Acquire lock using swarm_lock.sh
2. Append START to status.log using swarm_status_log.sh
3. Append DONE to status.log using swarm_status_log.sh
4. Release lock using swarm_lock.sh
5. Verify status.log shows both START and DONE records
6. Verify lock was properly created and released

## Implementation Decisions

### Test Structure

- **Format:** Bash script with `set -euo pipefail` for error handling
- **State directory:** Uses `mktemp -d` for complete isolation (no pollution of real data)
- **Cleanup:** Temp directory removed on exit via trap
- **Output:** Human readable format with "Test N: [PASS|FAIL]" for each check

### Test Cases

| Test | Description | Verification |
|------|-------------|--------------|
| 1 | Acquire lock | Lock file created in locks/ |
| 2 | Append START | status.log contains START record |
| 3 | Append DONE | status.log contains DONE record |
| 4 | Release lock | Lock file deleted from locks/ |
| 5 | Verify status.log contents | Both START and DONE records present |
| 6 | Verify lock lifecycle | Lock created and released properly |

### Failure Handling

- **Fail fast:** Stop on first failure
- **Exit code:** Non-zero on any failure
- **Output:** Clear indication of which test failed

## Tasks

<task type="auto">
### Create E2E test script

**File:** `/home/user/projects/AAA/swarm/scripts/swarm_e2e_test.sh`

**Actions:**

1. Add shebang and error handling:
   ```bash
   #!/usr/bin/env bash
   set -euo pipefail
   ```

2. Define configuration variables:
   ```bash
   # Use temp directory for isolation (no pollution of real data)
   STATE_DIR="$(mktemp -d)"
   export SWARM_STATE_DIR="$STATE_DIR"
   STATUS_LOG="$STATE_DIR/status.log"
   LOCK_DIR="$STATE_DIR/locks"
   SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
   STATUS_SCRIPT="$SCRIPT_DIR/swarm_status_log.sh"
   LOCK_SCRIPT="$SCRIPT_DIR/swarm_lock.sh"
   ```

3. Check dependencies are executable:
   ```bash
   [ -x "$LOCK_SCRIPT" ] || { echo "ERROR: $LOCK_SCRIPT not found or not executable"; exit 1; }
   [ -x "$STATUS_SCRIPT" ] || { echo "ERROR: $STATUS_SCRIPT not found or not executable"; exit 1; }
   ```

4. Create cleanup function (cleans up temp directory):
   ```bash
   cleanup() {
       rm -rf "$STATE_DIR" 2>/dev/null || true
   }
   trap cleanup EXIT
   ```

4. Implement test assertions (safe - no eval):
   ```bash
   assert_pass() {
       local description="$1"
       shift
       echo "Test $TEST_NUM: $description"
       if "$@"; then
           echo "  PASS"
           ((TEST_NUM++))
       else
           echo "  FAIL"
           FAILED=1
           exit 1
       fi
   }
   ```

5. Run test sequence (using command array instead of eval):
   - **Test 1:** Acquire lock for unique task_id (e.g., "e2e-test-$(date +%s)")
   - **Test 2:** Verify lock file exists in locks/
   - **Test 3:** Append START record via swarm_status_log.sh
   - **Test 4:** Append DONE record via swarm_status_log.sh
   - **Test 5:** Release lock via swarm_lock.sh
   - **Test 6:** Verify lock file deleted from locks/
   - **Test 7:** Verify status.log contains START record
   - **Test 8:** Verify status.log contains DONE record

   Example call (no eval):
   ```bash
   assert_pass "Acquire lock" "$LOCK_SCRIPT" acquire "$TEST_TASK_ID" worker-e2e
   ```

6. Print summary:
   - Total tests run
   - Tests passed/failed
   - Exit code

**Acceptance:**
- Script is executable (chmod +x)
- All 8 tests pass
- Exit code 0 on success, non-zero on failure
- No swarm/*.py files modified
</task>

<task type="checkpoint:human-verify">
### Run and verify E2E test script

**Actions:**

```bash
# Make script executable
chmod +x /home/user/projects/AAA/swarm/scripts/swarm_e2e_test.sh

# Run the test
./scripts/swarm_e2e_test.sh

# Expected output format:
# Test 1: Acquire lock for e2e-test-...
#   PASS
# Test 2: Verify lock file exists
#   PASS
# ...
# =========================================
# E2E Test Summary: 8/8 tests passed
# =========================================
# Exit code: 0

# Verify no Python files modified
git diff --name-only swarm/

# Expected: (empty output - no modified files)
```

**Verification Criteria:**

- [ ] `./scripts/swarm_e2e_test.sh` executes without errors
- [ ] All tests show "PASS"
- [ ] Summary shows "8/8 tests passed" (or appropriate count)
- [ ] Exit code is 0
- [ ] `git diff --name-only swarm/` returns empty (no .py file modifications)
</task>

## must_haves

- [ ] E2E test script verifies status.log integration
- [ ] E2E test script verifies locks/ integration
- [ ] Test shows PASS/FAIL for each step
- [ ] Test fails fast on first failure
- [ ] No swarm/*.py files were modified

## key_links

```
swarm_e2e_test.sh ──────> scripts/swarm_status_log.sh (Tests append/tail/query)
swarm_e2e_test.sh ──────> scripts/swarm_lock.sh (Tests acquire/release)
swarm_e2e_test.sh ──────> /tmp/ai_swarm (via mktemp -d for isolation, verifies shared state between scripts)
```

## Dependencies

- `scripts/swarm_status_log.sh` (Phase 12) — must exist and work
- `scripts/swarm_lock.sh` (Phase 13) — must exist and work

## Notes

- Test uses mktemp -d for complete isolation (no conflict with real data)
- All test artifacts cleaned up automatically via trap on EXIT
- Tests can be run multiple times independently
- All assertions use `set -euo pipefail` for reliability
- assert_pass uses command array (not eval) for security
