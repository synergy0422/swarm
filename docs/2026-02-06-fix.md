# 2026-02-06 紧急修复记录

## 问题描述

WSL 环境下启动 `swarm_layout_5.sh` 时：
1. tmux 3.4 不识别 `-x 200 -y 60` 参数
2. codex 启动后等待用户交互确认目录权限
3. Worker 进程无法获取 `LLM_BASE_URL` 环境变量

## 修改的文件

### scripts/swarm_layout_5.sh

#### 修改 1：移除 tmux 尺寸参数（兼容性修复）

```diff
- CODEX_PANE=$(tmux new-session -d -P -F '#{pane_id}' -s "$SESSION" -n codex-master -x 200 -y 60)
+ CODEX_PANE=$(tmux new-session -d -P -F '#{pane_id}' -s "$SESSION" -n codex-master)
```

```diff
- WORKER0_PANE=$(tmux new-window -P -F '#{pane_id}' -t "$SESSION" -n workers -x 200 -y 60)
+ WORKER0_PANE=$(tmux new-window -P -F '#{pane_id}' -t "$SESSION" -n workers)
```

#### 修改 2：codex 启动命令（非交互模式）

```diff
- CODEX_CMD="${CODEX_CMD:-codex --yolo}"
+ CODEX_CMD="${CODEX_CMD:-codex --ask-for-approval never}"
```

#### 修改 3：WSL 环境变量传递（核心修复）

```diff
+ # Capture current LLM settings for tmux environment (WSL compatibility)
+ LLM_BASE_URL_VAL="${LLM_BASE_URL:-}"
+ ANTHROPIC_API_KEY_VAL="${ANTHROPIC_API_KEY:-}"
+
  if [[ -n "${AI_SWARM_INTERACTIVE:-}" ]]; then
      tmux set-environment -t "$SESSION" AI_SWARM_INTERACTIVE "$AI_SWARM_INTERACTIVE"
  fi
- if [[ -n "${LLM_BASE_URL:-}" ]]; then
-     tmux set-environment -t "$SESSION" LLM_BASE_URL "$LLM_BASE_URL"
- fi
- if [[ -n "${ANTHROPIC_API_KEY:-}" ]]; then
-     tmux set-environment -t "$SESSION" ANTHROPIC_API_KEY "$ANTHROPIC_API_KEY"
- fi
+ if [[ -n "$LLM_BASE_URL_VAL" ]]; then
+     tmux set-environment -t "$SESSION" LLM_BASE_URL "$LLM_BASE_URL_VAL"
+ fi
+ if [[ -n "$ANTHROPIC_API_KEY_VAL" ]]; then
+     tmux set-environment -t "$SESSION" ANTHROPIC_API_KEY "$ANTHROPIC_API_KEY_VAL"
+ fi
+
+ # Build environment export string for pane commands
+ PANE_ENV_EXPORT=""
+ [[ -n "$LLM_BASE_URL_VAL" ]] && PANE_ENV_EXPORT="${PANE_ENV_EXPORT}export LLM_BASE_URL=\"$LLM_BASE_URL_VAL\" && "
+ [[ -n "$ANTHROPIC_API_KEY_VAL" ]] && PANE_ENV_EXPORT="${PANE_ENV_EXPORT}export ANTHROPIC_API_KEY=\"$ANTHROPIC_API_KEY_VAL\" && "
```

#### 修改 4：启动命令中添加环境变量

```diff
- tmux send-keys -t "$CODEX_PANE" "cd \"$WORKDIR\" && export AI_SWARM_DIR=\"$AI_SWARM_DIR\"${AI_SWARM_INTERACTIVE:+ && export AI_SWARM_INTERACTIVE=\"$AI_SWARM_INTERACTIVE\"} && $CODEX_CMD" C-m
+ tmux send-keys -t "$CODEX_PANE" "${PANE_ENV_EXPORT}cd \"$WORKDIR\" && export AI_SWARM_DIR=\"$AI_SWARM_DIR\"${AI_SWARM_INTERACTIVE:+ && export AI_SWARM_INTERACTIVE=\"$AI_SWARM_INTERACTIVE\"} && $CODEX_CMD" C-m

- tmux send-keys -t "$MASTER_PANE" "cd \"$WORKDIR\" && export AI_SWARM_DIR=\"$AI_SWARM_DIR\"${AI_SWARM_INTERACTIVE:+ && export AI_SWARM_INTERACTIVE=\"$AI_SWARM_INTERACTIVE\"} && python3 -m swarm.cli --cluster-id $CLUSTER_ID master" Enter
+ tmux send-keys -t "$MASTER_PANE" "${PANE_ENV_EXPORT}cd \"$WORKDIR\" && export AI_SWARM_DIR=\"$AI_SWARM_DIR\"${AI_SWARM_INTERACTIVE:+ && export AI_SWARM_INTERACTIVE=\"$AI_SWARM_INTERACTIVE\"} && python3 -m swarm.cli --cluster-id $CLUSTER_ID master" Enter

- tmux send-keys -t "$WORKER0_PANE" "cd \"$WORKDIR\" && export AI_SWARM_DIR=\"$AI_SWARM_DIR\"${AI_SWARM_INTERACTIVE:+ && export AI_SWARM_INTERACTIVE=\"$AI_SWARM_INTERACTIVE\"} && python3 -m swarm.cli --cluster-id $CLUSTER_ID worker --id 0" Enter
+ tmux send-keys -t "$WORKER0_PANE" "${PANE_ENV_EXPORT}cd \"$WORKDIR\" && export AI_SWARM_DIR=\"$AI_SWARM_DIR\"${AI_SWARM_INTERACTIVE:+ && export AI_SWARM_INTERACTIVE=\"$AI_SWARM_INTERACTIVE\"} && python3 -m swarm.cli --cluster-id $CLUSTER_ID worker --id 0" Enter

- tmux send-keys -t "$WORKER1_PANE" "cd \"$WORKDIR\" && export AI_SWARM_DIR=\"$AI_SWARM_DIR\"${AI_SWARM_INTERACTIVE:+ && export AI_SWARM_INTERACTIVE=\"$AI_SWARM_INTERACTIVE\"} && python3 -m swarm.cli --cluster-id $CLUSTER_ID worker --id 1" Enter
+ tmux send-keys -t "$WORKER1_PANE" "${PANE_ENV_EXPORT}cd \"$WORKDIR\" && export AI_SWARM_DIR=\"$AI_SWARM_DIR\"${AI_SWARM_INTERACTIVE:+ && export AI_SWARM_INTERACTIVE=\"$AI_SWARM_INTERACTIVE\"} && python3 -m swarm.cli --cluster-id $CLUSTER_ID worker --id 1" Enter

- tmux send-keys -t "$WORKER2_PANE" "cd \"$WORKDIR\" && export AI_SWARM_DIR=\"$AI_SWARM_DIR\"${AI_SWARM_INTERACTIVE:+ && export AI_SWARM_INTERACTIVE=\"$AI_SWARM_INTERACTIVE\"} && python3 -m swarm.cli --cluster-id $CLUSTER_ID worker --id 2" Enter
+ tmux send-keys -t "$WORKER2_PANE" "${PANE_ENV_EXPORT}cd \"$WORKDIR\" && export AI_SWARM_DIR=\"$AI_SWARM_DIR\"${AI_SWARM_INTERACTIVE:+ && export AI_SWARM_INTERACTIVE=\"$AI_SWARM_INTERACTIVE\"} && python3 -m swarm.cli --cluster-id $CLUSTER_ID worker --id 2" Enter
```

## 测试验证

```bash
# E2E 测试
export LLM_BASE_URL="http://127.0.0.1:15721"
export ANTHROPIC_API_KEY="dummy"
python3 -m pytest tests/test_e2e_happy_path.py -v -m integration

# 结果：PASSED
```

## 启动命令

```bash
cd /home/user/projects/AAA/swarm
export LLM_BASE_URL="http://127.0.0.1:15721"
export ANTHROPIC_API_KEY="dummy"
./scripts/swarm_layout_5.sh --attach
```

## 相关文档更新

- CHANGELOG.md：添加 2026-02-06 修复记录
