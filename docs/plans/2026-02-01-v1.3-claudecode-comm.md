# v1.3 Claude Code 4 窗口通信协议

**Date:** 2026-02-01
**Version:** v1.3
**Status:** Planning (修正版)

---

## 一、发现现状

### 1.1 已完成的功能

| 功能 | 状态 | 说明 |
|------|------|------|
| tmux 4 窗口启动 | ✅ | master, worker-0, worker-1, worker-2 |
| Claude CLI 集成 | ✅ | 每个窗口运行 claude CLI |
| Master 扫描 | ✅ | MasterScanner 定期扫描 worker 输出 |
| 状态广播 | ✅ | JSON Lines 格式 (START/DONE/WAIT/ERROR/HELP/SKIP) |
| 自动救援 | ✅ | 检测 [y/n]、Error/Failed 并确认 |

### 1.2 当前架构

```
┌─────────────────────────────────────────────────────┐
│  run_claude_swarm.sh                                │
│  ├── tmux session: swarm-claude-default             │
│  ├── master window → runs: claude                   │
│  ├── worker-0 window → runs: claude                 │
│  ├── worker-1 window → runs: claude                 │
│  └── worker-2 window → runs: claude                 │
└─────────────────────────────────────────────────────┘
```

### 1.3 待解决的问题

1. **任务分发**：如何向 Claude CLI 窗口发送任务描述？
2. **状态回报**：如何从 Claude CLI 窗口获取任务状态？
3. **消息格式**：如何区分命令和 Claude 输出？

---

## 二、计划（约束修正版）

### 2.1 核心约束（v1.3 必须遵守）

| 约束 | 说明 |
|------|------|
| **仅用 tmux** | 只能用 send-keys / capture-pane |
| **不改 core** | 不修改 swarm/*.py |
| **外部脚本** | 只新增 bash 脚本工具 |
| **保持 4 窗口** | master + worker-0/1/2 运行 Claude CLI |

### 2.2 设计决策

| 维度 | 决策 | 理由 |
|------|------|------|
| 控制方式 | 外部脚本 | 不改 Master 进程 |
| 脚本语言 | bash | 最小依赖，直接调用 tmux |
| 消息格式 | Minimal 标记词 | 简单、视觉清晰 |
| 标记词 | [TASK], [DONE], [ERROR], [WAIT], [ACK] | 5 个核心状态词 |

---

## 三、通信协议

### 3.1 核心标记词

| 标记 | 方向 | 含义 |
|------|------|------|
| `[TASK]` | 命令前缀 | 任务开始标记 |
| `[ACK]` | Worker→Master | 任务已接收确认 |
| `[DONE]` | Worker→Master | 任务完成 |
| `[ERROR]` | Worker→Master | 任务执行出错 |
| `[WAIT]` | Worker→Master | 等待用户输入/确认 |
| `[HELP]` | Worker→Master | 需要人工干预 |

### 3.2 消息格式

#### 任务消息（发送格式）

```
[TASK] {task_id}
{任务描述内容}
```

#### 状态消息（预期返回）

```
[ACK] {task_id}
[DONE] {task_id}
[ERROR] {task_id} 错误描述
```

### 3.3 消息流程

```
外部脚本                          Worker-0 (Claude CLI)
   │                                   │
   │  [TASK] task-001                  │
   │  任务描述...                       │
   ├──────────────────────────────────>│ (tmux send-keys)
   │                                   │
   │                                   │ Claude 解析任务
   │                                   │ Claude 回复 [ACK] task-001
   │  [ACK] task-001                   │
   │<──────────────────────────────────┤ (tmux capture-pane)
   │                                   │
   │                                   │ Claude 执行任务
   │                                   │ Claude 回复 [DONE] task-001
   │  [DONE] task-001                  │
   │<──────────────────────────────────┤ (tmux capture-pane)
```

---

## 四、实施步骤

### Phase 11: 通信脚本实现

#### Step 1: 创建 `scripts/` 目录

```bash
mkdir -p /home/user/projects/AAA/swarm/scripts
```

#### Step 2: `scripts/claude_comm.sh`

```bash
#!/usr/bin/env bash
set -euo pipefail

# 用法:
#   claude_comm.sh send <window> <task_id> "<description>"
#   claude_comm.sh poll <window> [timeout] [task_id]
#   claude_comm.sh status <window>

SESSION="swarm-claude-default"

send() {
    local window="$1"
    local task_id="$2"
    local description="$3"

    # 发送标记行和任务描述
    tmux send-keys -t "$SESSION:$window" "[TASK] $task_id" Enter
    tmux send-keys -t "$SESSION:$window" "$description" Enter
}

poll() {
    local window="$1"
    local timeout="${2:-30}"
    local task_id="${3:-}"

    local start_time=$(date +%s)
    local deadline=$((start_time + timeout))

    while [[ $(date +%s) -lt $deadline ]]; do
        # 捕获最近 200 行，解析标记词
        output=$(tmux capture-pane -t "$SESSION:$window" -p 2>/dev/null | tail -200)

        if [[ -n "$task_id" ]]; then
            # 按 task_id 过滤，匹配 "[标记] *task_id" 格式
            result=$(echo "$output" | grep -E "\\[(ACK|DONE|ERROR|WAIT|HELP)\\] *$task_id")
        else
            # 任意状态标记
            result=$(echo "$output" | grep -E '\[(ACK|DONE|ERROR|WAIT|HELP)\]')
        fi

        if [[ -n "$result" ]]; then
            echo "$result"
            return 0
        fi

        sleep 1
    done

    echo "Timeout after ${timeout}s" >&2
    return 1
}

status() {
    local window="$1"
    tmux capture-pane -t "$SESSION:$window" -p | tail -20
}
```

#### Step 3: `scripts/claude_poll.sh`

```bash
#!/usr/bin/env bash
# 轮询所有 worker 窗口，输出状态变化（按 task_id 过滤）

SESSION="swarm-claude-default"
WINDOWS="worker-0 worker-1 worker-2"
POLL_INTERVAL=5

while true; do
    for w in $WINDOWS; do
        # 捕获最近 200 行，按 task_id 过滤 DONE/ERROR
        status=$(tmux capture-pane -t "$SESSION:$w" -p 2>/dev/null | tail -200 | grep -E '\[(DONE|ERROR)\]' | tail -1)
        if [[ -n "$status" ]]; then
            echo "[$(date +%H:%M:%S)] $w: $status"
        fi
    done
    sleep $POLL_INTERVAL
done
```

#### Step 4: `scripts/claude_status.sh`

```bash
#!/usr/bin/env bash
# 快速检查各窗口当前状态

SESSION="swarm-claude-default"

echo "=== Claude Swarm Status ==="
for w in master worker-0 worker-1 worker-2; do
    echo ""
    echo "--- $w ---"
    tmux capture-pane -t "$SESSION:$w" -p | tail -10
done
```

#### Step 5: Make scripts executable

```bash
chmod +x scripts/*.sh
```

---

## 五、验收标准

### 5.1 功能验收

| # | 标准 | 验证方式 |
|---|------|----------|
| 1 | `claude_comm.sh send worker-0 task-001 "hello"` 发送成功 | `capture-pane -p \| grep "\[TASK\] task-001"` |
| 2 | Worker 返回 `[ACK] task-001` | `claude_comm.sh poll worker-0 --task-id task-001` |
| 3 | Worker 返回 `[DONE] task-001` | `claude_comm.sh poll worker-0 --task-id task-001` |
| 4 | `claude_poll.sh` 持续输出状态 | 运行脚本观察 30 秒 |
| 5 | `claude_status.sh` 显示所有窗口 | 运行脚本查看输出 |

### 5.2 代码验收

| # | 标准 | 验证方式 |
|---|------|----------|
| 1 | 不修改任何 `swarm/*.py` | `git diff --name-only swarm/` |
| 2 | 脚本直接调用 tmux 命令 | 代码审查 |
| 3 | 脚本在 `/tmp/ai_swarm` 外运行 | 检查脚本内容 |

### 5.3 手动验收流程

```bash
# 1. 启动 4 窗口
./run_claude_swarm.sh

# 2. 在另一个终端，发送任务
./scripts/claude_comm.sh send worker-0 task-001 "创建文件 hello.py"

# 3. 检查 worker-0 是否回复 [ACK]（poll <window> <timeout> <task_id>）
./scripts/claude_comm.sh poll worker-0 10 task-001

# 4. 等待 Claude 完成，检查 [DONE]
./scripts/claude_comm.sh poll worker-0 60 task-001

# 5. 查看所有窗口状态
./scripts/claude_status.sh
```

---

## 六、文件变更

### 新增文件

| 文件 | 描述 |
|------|------|
| `scripts/claude_comm.sh` | 核心通信脚本 (send/poll/status) |
| `scripts/claude_poll.sh` | 轮询监控脚本 |
| `scripts/claude_status.sh` | 快速状态检查脚本 |
| `docs/plans/2026-02-01-v1.3-claudecode-comm.md` | 本计划文档 |

### 不变更

| 文件 | 说明 |
|------|------|
| `swarm/*.py` | 任何文件都不修改 |
| `run_claude_swarm.sh` | 不改核心行为 |

---

## 七、风险与缓解

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| Claude 改变输出格式 | 标记词解析失败 | 宽松正则匹配 |
| tmux 性能 | 轮询延迟 | 可配置间隔，默认 5 秒 |
| 窗口不存在 | 发送失败 | 窗口名验证 |

---

## 八、时间线

| 阶段 | 预计时间 |
|------|----------|
| Step 1: 创建 scripts/ 目录 | 2 分钟 |
| Step 2: claude_comm.sh | 30 分钟 |
| Step 3: claude_poll.sh | 15 分钟 |
| Step 4: claude_status.sh | 10 分钟 |
| Step 5: 手动验收 | 30 分钟 |
| **总计** | **~1.5 小时** |

---

*Plan created: 2026-02-01*
*Plan corrected: 2026-02-01 (约束修正版)*
