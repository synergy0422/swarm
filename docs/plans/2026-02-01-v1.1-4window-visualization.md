# AI Swarm v1.1 计划：4 Window 可视化协作系统

> **目标**：实现"4 个独立 tmux Window 可视化（master + 3 workers）"
> **版本**：v1.1
> **基于**：v1.0 已完成代码库 + 参考文档 `/home/user/projects/group/AI蜂群协作-tmux多Agent协作系统.md`

---

## 一、代码库现状分析

### 1.1 已实现功能（v1.0）

| 模块 | 文件 | 功能 |
|:-----|:-----|:-----|
| **CLI 命令** | `cli.py` | `swarm init/up/master/worker/status/down` |
| **Tmux 管理** | `tmux_manager.py` | `TmuxSwarmManager` - libtmux 封装 |
| **共享状态** | `status_broadcaster.py` | JSONL 格式状态广播 |
| **任务锁** | `task_lock.py` | `TaskLockManager` - 原子锁机制 |
| **任务队列** | `task_queue.py` | `TaskQueue` - FIFO 队列 |
| **Master 协调** | `master.py` | `Master` - 同步主循环（time.sleep） |
| **Master 派发** | `master_dispatcher.py` | `MasterDispatcher` - FIFO 任务分配 |
| **自动救援** | `auto_rescuer.py` | `AutoRescuer` - 模式检测 |
| **Worker** | `worker_smart.py` | `SmartWorker` - Anthropic API 集成 |

### 1.2 当前窗口结构（`cli.py:228-278`）

```
swarm-{cluster_id}
├── master      ← AI-Master 指挥官 (窗口索引 0)
├── worker-0    ← Worker 1    (窗口索引 1)
├── worker-1    ← Worker 2    (窗口索引 2)
└── worker-2    ← Worker 3    (窗口索引 3)
```

**窗口命名规范**：
| 窗口名称 | 角色 | tmux 索引 |
|:---------|:-----|:----------|
| `master` | 指挥官 | 0 |
| `worker-0` | 工作节点 1 | 1 |
| `worker-1` | 工作节点 2 | 2 |
| `worker-2` | 工作节点 3 | 3 |

### 1.3 技术栈统一策略

**决策**：新增 `TmuxCollaboration` 类统一使用 `libtmux`，仅用于本计划需要的 capture/send 操作

| 场景 | 当前实现 (`cli.py`) | 统一后 |
|:-----|:-------------------|:-------|
| tmux 会话创建 | subprocess | 保持现状 |
| tmux 窗口操作 | subprocess | **本计划新增 capture/send 用 libtmux** |
| pane 内容捕获 | subprocess | **本计划新增 capture 用 libtmux** |
| 会话查询 | libtmux (`get_session`) | 保持现状 |
| 会话销毁 | libtmux (优先) → tmux fallback | 保持现状 |

**说明**：
- `cmd_down` 已优先使用 libtmux (`get_session`)，仅在失败时回退到 subprocess
- 本计划仅新增本计划需要的 `capture_pane` 和 `send_keys_to_window` 操作
- 不回收/修改现有已稳定的逻辑

**理由**：
- `cli.py` 当前混用 subprocess 和 libtmux（会话查询用 libtmux，销毁有 fallback）
- 新增 `TmuxCollaboration` 封装本计划需要的 capture/send 操作
- 最小改动原则：仅新增本次功能需要的操作

### 1.4 测试文件统计

- **测试文件数**：17 个（含 conftest.py）
- **现有测试**：全部通过（以实际运行结果为准）
- **计划说明**：本计划以实际测试数量为准，不写"预期失败"测试

---

## 二、v1.1 目标范围

### 2.1 核心目标

1. **4 Window 可视化** - Master 实时捕获所有 worker pane 内容
2. **协作命令封装** - 使用 libtmux 封装 `list-windows`、`capture-pane`、`send-keys`
3. **Master 自动救援** - 检测到模式后在 Master loop 中执行 send-keys（扩展 WaitDetector）
4. **CLI 状态增强** - `swarm status --panes` 显示窗口快照

### 2.2 CLI 参数变更点

| 命令 | 新增参数 | 说明 | 状态 |
|:-----|:---------|:-----|:-----|
| `swarm status` | `--panes, -p` | 显示 4 窗口内容快照 | **实现** |
| `swarm status` | `--json` | JSON 格式输出 | **不做** |

**不做 `--json` 的原因**：
- MVP 阶段保持简单，文本输出足够
- 避免与现有 JSONL status.log 混淆
- 如需可后续版本实现

### 2.3 边界控制（Out of Scope）

- **状态格式变更** - 保持 JSONL 格式，不做破坏性变更
- **Web 监控面板** - 纯 CLI，暂不引入 Flask
- **SSH 跨机扩展** - 预留接口，不实现
- **命令白名单** - 暂不实现
- **Pipeline/P2P 模式** - 后续版本

---

## 三、详细实现计划

### Phase 7: 协作命令封装

**目标**：新增 `tmux_collaboration.py`，封装批量窗口操作（使用 libtmux）

#### 步骤 7.1: 新增 `tmux_collaboration.py`

**文件**：`swarm/tmux_collaboration.py`（新增）

**原因**：
- 封装 `tmux list-windows`、`capture-pane`、`send-keys` 协作命令
- 使用 libtmux（与现有 `cli.py` 和 `tmux_manager.py` 保持一致）
- 参考文档第 3.2 节"批量读取所有窗口"模式

**内容**：

```python
# swarm/tmux_collaboration.py

from typing import Dict, List, Optional
import libtmux


class TmuxCollaboration:
    """
    Tmux 协作命令封装 - 批量窗口操作

    封装参考文档中的协作模式：
    - for w in $(tmux list-windows -a)
    - tmux capture-pane -t "$w" -p -S -30
    - tmux send-keys -t "0:$w" "y" Enter
    """

    def __init__(self, server: Optional[libtmux.Server] = None):
        self.server = server or libtmux.Server()

    def list_windows(self, session_name: str) -> List[Dict]:
        """列出会话所有窗口"""
        session = self.server.find_where({"session_name": session_name})
        if not session:
            return []

        windows = []
        for w in session.windows:
            windows.append({
                "name": w.get("window_name"),
                "index": w.get("window_index"),
                "activity": w.get("window_activity", "unknown"),
            })
        return windows

    def capture_pane(self, session_name: str, window_index: str) -> str:
        """捕获指定窗口的 pane 内容"""
        session = self.server.find_where({"session_name": session_name})
        if not session:
            return ""

        window = session.find_where({"window_index": window_index})
        if not window:
            return ""

        result = window.active_pane.cmd("capture-pane", "-p", "-S", "-30")
        return "\n".join(result.stdout) if result.stdout else ""

    def capture_all_windows(self, session_name: str) -> Dict[str, str]:
        """批量捕获所有窗口内容（4 Window 可视化核心）"""
        windows = self.list_windows(session_name)
        outputs = {}

        for w in windows:
            index = w["index"]
            name = w["name"]
            content = self.capture_pane(session_name, index)
            outputs[name] = content

        return outputs

    def send_keys_to_window(
        self,
        session_name: str,
        window_index: str,
        keys: str,
        enter: bool = True
    ) -> None:
        """向指定窗口发送按键"""
        session = self.server.find_where({"session_name": session_name})
        if not session:
            return

        window = session.find_where({"window_index": window_index})
        if not window:
            return

        if enter:
            window.active_pane.send_keys(keys, enter=True)
        else:
            window.active_pane.send_keys(keys)
```

#### 步骤 7.2: 新增 `tmux_collaboration.py` 单元测试

**文件**：`tests/test_tmux_collaboration.py`（新增）

**测试要求**：

```python
import pytest
import shutil
import libtmux
from swarm.tmux_collaboration import TmuxCollaboration


# tmux 可用性检查
tmux_available = shutil.which("tmux") is not None
pytestmark = pytest.mark.skipif(
    not tmux_available,
    reason="tmux not installed"
)


@pytest.fixture
def collaboration():
    """创建 TmuxCollaboration 实例"""
    return TmuxCollaboration()


@pytest.fixture
def temp_session():
    """创建临时 tmux session，测试后清理"""
    server = libtmux.Server()
    session = server.new_session(
        session_name="test-swarm-collab",
        attach=False
    )
    yield session
    # 清理：测试结束后删除 session
    session.kill_session()


def test_list_windows(collaboration, temp_session):
    """列出窗口测试"""
    # 创建 3 个 worker 窗口
    for i in range(3):
        temp_session.new_window(window_name=f"worker-{i}")

    windows = collaboration.list_windows("test-swarm-collab")
    assert len(windows) >= 4  # master + 3 workers


def test_capture_pane(collaboration, temp_session):
    """捕获 pane 测试"""
    # 发送测试命令
    temp_session.active_window.active_pane.send_keys("echo hello", enter=True)
    output = collaboration.capture_pane("test-swarm-collab", "0")
    assert "hello" in output


def test_capture_all_windows(collaboration, temp_session):
    """批量捕获所有窗口测试"""
    for i in range(3):
        w = temp_session.new_window(window_name=f"worker-{i}")
        w.active_pane.send_keys(f"echo worker-{i}", enter=True)

    outputs = collaboration.capture_all_windows("test-swarm-collab")
    assert "master" in outputs
    assert "worker-0" in outputs
    assert "worker-1" in outputs
    assert "worker-2" in outputs


def test_send_keys_to_window(collaboration, temp_session):
    """发送按键测试"""
    collaboration.send_keys_to_window(
        "test-swarm-collab", "1", "echo sent"
    )
    output = collaboration.capture_pane("test-swarm-collab", "1")
    assert "sent" in output
```

#### 验收标准

1. [ ] `TmuxCollaboration` 类可导入并实例化
2. [ ] `list_windows()` 返回包含 master + 3 workers 的列表
3. [ ] `capture_all_windows()` 返回 Dict[window_name, content]
4. [ ] `send_keys_to_window()` 正确发送按键
5. [ ] 测试包含 session 清理逻辑（`session.kill_session()`）
6. [ ] tmux 不可用时测试跳过（`skipif` 标记）
7. [ ] 单元测试覆盖率 > 80%

**预计提交数**：2 个提交
- `feat(07): add TmuxCollaboration class and tests`

---

### Phase 8: Master 集成 tmux 实时扫描

**目标**：Master 主循环使用 `capture-pane` 实时扫描 worker

**架构决策**：
- **扩展现有 WaitDetector**：在 `master.py` 的 WaitDetector 中新增 `detect_in_pane()` 方法
- **AutoRescuer 不参与 v1.1**：`auto_rescuer.py` 保持原样（仅用于独立模式检测）
- **Master loop 直接调用**：在主循环中调用 WaitDetector 检测 pane 输出并执行 auto-enter
- **tmux 不可用时降级**：捕获异常后静默跳过 pane 扫描，不报错（保持现有 status.log 扫描）

**注意**：当前 `master.py` 使用同步主循环（`while self.running:` + `time.sleep()`），本计划保持同步风格。

#### 步骤 8.1: 修改 `master.py` 扩展 WaitDetector

**文件**：`swarm/master.py`（修改）

**原因**：
- 扩展现有 WaitDetector 类，添加 pane 输出检测能力
- 在 Master 主循环中调用

**修改点**：

```python
from swarm.tmux_collaboration import TmuxCollaboration


class WaitDetector:
    """扩展 WaitDetector：支持 status.log 和 pane 输出检测"""

    def __init__(self, tmux_collaboration: Optional[TmuxCollaboration] = None):
        self._ai_swarm_dir = get_ai_swarm_dir()
        self.tmux_collaboration = tmux_collaboration or TmuxCollaboration()

    def detect_in_pane(self, pane_output: str) -> List[str]:
        """
        在 pane 输出中检测等待模式

        Args:
            pane_output: capture-pane 捕获的内容

        Returns:
            List of detected patterns: ["enter"]
        """
        patterns = []
        pane_lower = pane_output.lower()

        # 检测 Press Enter 模式（安全，可自动确认）
        enter_patterns = [
            "press enter",
            "press return",
            "hit enter",
            "回车继续",
            "按回车",
        ]
        for p in enter_patterns:
            if p in pane_lower:
                patterns.append("enter")
                break

        return patterns


class Master:
    def __init__(self, poll_interval: Optional[float] = None, cluster_id: str = 'default'):
        # ... 现有初始化 ...
        self.tmux_collaboration = TmuxCollaboration()
        self.wait_detector = WaitDetector(self.tmux_collaboration)
        self.session_name = f"swarm-{cluster_id}"

        # 窗口名到索引映射
        self._window_index_map = {
            "master": "0",
            "worker-0": "1",
            "worker-1": "2",
            "worker-2": "3",
        }

    def _auto_enter(self, window_name: str) -> None:
        """自动发送 Enter（仅对安全模式）"""
        window_index = self._window_index_map.get(window_name)
        if window_index:
            self.tmux_collaboration.send_keys_to_window(
                self.session_name, window_index, "", enter=True
            )
            print(f"[Master] Auto-ENTER for {window_name}")

    def run(self) -> None:
        """同步主循环"""
        print(f"[Master] Starting Master loop (poll_interval={self.poll_interval}s)")

        while self.running:
            try:
                # 1. 扫描 status.log（现有）
                workers_dict = self.scanner.scan_workers()
                # ... 转换 WorkerStatus ...

                # 2. 扫描所有窗口 pane 内容（新增）
                # tmux 不可用时跳过，不报错
                pane_outputs = {}
                try:
                    pane_outputs = self.tmux_collaboration.capture_all_windows(self.session_name)
                except Exception as e:
                    # tmux 不可用或 libtmux 连接失败，静默跳过
                    pass

                # 3. 检测 pane 中的等待模式（新增）
                for window_name, output in pane_outputs.items():
                    if output:
                        patterns = self.wait_detector.detect_in_pane(output)
                        if patterns and "enter" in patterns:
                            self._auto_enter(window_name)

                # 4. 处理任务派发（现有）
                results = self.dispatcher.dispatch_all(worker_statuses)
                # ...

                # 5. Sleep
                time.sleep(self.poll_interval)

            except Exception as e:
                print(f"[Master] Error in main loop: {e}")
                time.sleep(self.poll_interval)
```

#### 步骤 8.2: 修改 `cli.py` 注入依赖

**文件**：`swarm/cli.py`（修改）

**原因**：Master 需要 TmuxCollaboration 实例

```python
from swarm.tmux_collaboration import TmuxCollaboration

# cmd_master 函数中
tmux_collaboration = TmuxCollaboration()
master = Master(poll_interval=args.poll_interval, cluster_id=cluster_id)
master.tmux_collaboration = tmux_collaboration
master.wait_detector.tmux_collaboration = tmux_collaboration
```

#### 步骤 8.3: 新增集成测试

**文件**：`tests/test_master_tmux_scan.py`（新增）

**测试要求**：必须包含 `skipif` 和 session 清理

```python
import pytest
import shutil

tmux_available = shutil.which("tmux") is not None
pytestmark = pytest.mark.skipif(
    not tmux_available,
    reason="tmux not installed"
)


def test_master_scans_all_panes(temp_swarm_session):
    """验证 Master 扫描所有 pane"""
    # 测试 Master 主循环调用 capture_all_windows


def test_wait_detector_detects_in_pane(temp_swarm_session):
    """验证 WaitDetector.detect_in_pane() 检测模式"""
    # 发送包含 "Press Enter" 的内容
    # 验证 detect_in_pane 返回 ["enter"]
```

#### 验收标准

1. [ ] WaitDetector 新增 `detect_in_pane()` 方法
2. [ ] Master 主循环调用 `capture_all_windows()`
3. [ ] 检测到 Press Enter 模式时自动发送 Enter
4. [ ] 黑名单命令仍需人工确认（WaitDetector.should_auto_confirm 保持原有逻辑）
5. [ ] tmux 不可用时相关功能静默跳过（不报错）
6. [ ] 保持同步主循环风格（无 async/await）

**预计提交数**：3 个提交
- `feat(08-01): extend WaitDetector with detect_in_pane method`
- `feat(08-02): integrate pane scanning in Master main loop`
- `test(08): add master-tmux integration tests`

---

### Phase 9: CLI 状态命令增强

**目标**：增强 `swarm status` 显示 4 窗口可视化

#### 步骤 9.1: 修改 `cli.py` status 命令

**文件**：`swarm/cli.py`（修改）

**原因**：当前 `swarm status` 只显示文本状态，需新增 `--panes` 参数

**修改点**：

```python
import shutil
from swarm.tmux_collaboration import TmuxCollaboration


def cmd_status(args):
    session_name = f"swarm-{args.cluster_id}"

    # ... 现有状态读取 ...

    # 新增：4 窗口可视化输出
    if args.panes:
        if not shutil.which("tmux"):
            print("[WARNING] tmux not installed, skipping pane display")
            return 0

        try:
            tmux_collaboration = TmuxCollaboration()
            pane_outputs = tmux_collaboration.capture_all_windows(session_name)
        except Exception as e:
            print(f"[WARNING] Failed to capture panes: {e}")
            return 0

        print("\n" + "=" * 60)
        print(" 4 WINDOW VISUALIZATION ".center(60))
        print("=" * 60)

        for window_name in ["master", "worker-0", "worker-1", "worker-2"]:
            output = pane_outputs.get(window_name, "")
            lines = output.strip().split("\n")[-20:]
            content = "\n".join(lines)

            # 状态图标
            if "Error" in output or "Failed" in output:
                icon = "[ERROR]"
            elif "DONE" in output or "Complete" in output:
                icon = "[DONE]"
            else:
                icon = "[ ]"

            print(f"\n{icon} Window: {window_name}")
            print("-" * 40)
            print(content if content else "(no output)")

    return 0


# 在 main() 函数中，保存 status_parser 引用以便追加参数
def main():
    # ... 现有代码 ...

    # status command - 保存 parser 引用并追加参数
    status_parser = subparsers.add_parser('status', parents=[parent_parser], help='View swarm status')
    status_parser.add_argument('--panes', '-p', action='store_true',
                              help='Show 4 window pane content snapshot')

    # ... 其余代码 ...
```

#### 验收标准

1. [ ] `swarm status` 显示任务状态（现有行为保持）
2. [ ] `swarm status --panes` 显示 4 窗口内容快照
3. [ ] 窗口无输出时显示 `(no output)`
4. [ ] tmux 不可用时跳过 pane 显示，显示 warning
5. [ ] 异常情况优雅处理，不崩溃

**预计提交数**：2 个提交
- `feat(09): enhance status command with --panes flag`
- `test(09): add status --panes test`

---

### Phase 10: 验收测试

**目标**：完整的 E2E 测试验证

#### 步骤 10.1: 新增 `test_e2e_4window.py`

**文件**：`tests/test_e2e_4window.py`（新增）

**测试要求**：

```python
import pytest
import subprocess
import shutil

tmux_available = shutil.which("tmux") is not None
pytestmark = pytest.mark.skipif(
    not tmux_available,
    reason="tmux not installed"
)

# 前置条件：确保 swarm 包已安装（pip install -e .）
# 运行方式：pytest tests/test_e2e_4window.py


@pytest.fixture(scope="module")
def swarm_session():
    """启动 swarm 会话，测试后清理"""
    # 使用 python -m 运行，兼容未安装 console_scripts 的情况
    result = subprocess.run(
        ["python", "-m", "swarm.cli", "up", "--workers", "3"],
        capture_output=True,
        timeout=30
    )
    assert result.returncode == 0, f"Failed to start swarm: {result.stderr}"

    yield

    # 清理
    subprocess.run(["python", "-m", "swarm.cli", "down"], capture_output=True)


def test_swarm_up_creates_4_windows(swarm_session):
    """验证 swarm up 创建 4 个窗口"""
    result = subprocess.run(
        ["python", "-m", "swarm.cli", "status"],
        capture_output=True,
        text=True
    )
    assert result.returncode == 0
    # 验证输出包含 4 个窗口信息


def test_status_panes_shows_window_content(swarm_session):
    """验证 status --panes 显示窗口内容"""
    result = subprocess.run(
        ["python", "-m", "swarm.cli", "status", "--panes"],
        capture_output=True,
        text=True
    )
    output = result.stdout

    assert "master" in output
    assert "worker-0" in output
    assert "worker-1" in output
    assert "worker-2" in output


def test_swarm_down_cleans_up(swarm_session):
    """验证 swarm down 清理资源"""
    result = subprocess.run(
        ["tmux", "list-sessions"],
        capture_output=True,
        text=True
    )
    assert "swarm-" not in result.stdout
```

#### 验收标准

1. [ ] 所有现有测试通过
2. [ ] 新增 E2E 测试验证完整 4 窗口流程
3. [ ] `swarm status --panes` 正确显示内容
4. [ ] `swarm down` 正确清理 tmux session
5. [ ] tmux 不可用时测试跳过（不失败）
6. [ ] 测试覆盖率保持 > 80%

**预计提交数**：1 个提交
- `test(10): add 4-window E2E tests`

---

## 四、文件变更清单

### 4.1 新增文件

| 文件路径 | 原因 |
|:---------|:-----|
| `swarm/tmux_collaboration.py` | 协作命令封装，批量窗口操作（libtmux） |
| `tests/test_tmux_collaboration.py` | tmux_collaboration.py 的单元测试（含 skipif） |
| `tests/test_master_tmux_scan.py` | Master 扫描 pane 的集成测试（含 skipif） |
| `tests/test_e2e_4window.py` | 完整 4 窗口 E2E 测试（含 skipif） |

### 4.2 修改文件

| 文件路径 | 修改原因 |
|:---------|:---------|
| `swarm/master.py` | 扩展 WaitDetector，新增 pane 扫描（同步风格） |
| `swarm/cli.py` | status 命令新增 `--panes` 参数 |

### 4.3 不修改文件

| 文件 | 原因 |
|:-----|:-----|
| `swarm/tmux_manager.py` | 已有功能可复用 |
| `swarm/task_lock.py` | 锁机制已完善 |
| `swarm/task_queue.py` | 队列已完善 |
| `swarm/worker_smart.py` | Worker 行为无需改变 |
| `swarm/status_broadcaster.py` | 保持 JSONL 格式，不做变更 |
| `swarm/auto_rescuer.py` | AutoRescuer 保持独立，仅用于模式检测 |
| `swarm/master_dispatcher.py` | 派发机制已完善 |

---

## 五、阶段总结

| Phase | 名称 | 提交数 |
|:-----:|:-----|:------:|
| 7 | 协作命令封装 | 2 |
| 8 | Master 集成扫描 | 3 |
| 9 | CLI 状态增强 | 2 |
| 10 | 验收测试 | 1 |

**总计**：预计 **8** 个提交

---

## 六、验收标准总览

### 6.1 功能验收

1. [ ] `TmuxCollaboration` 类封装 `capture-pane` 和 `send-keys`（libtmux）
2. [ ] 4 个独立 tmux Window（master + worker-0/1/2）
3. [ ] `swarm status --panes` 显示窗口内容快照
4. [ ] Master 主动 `capture-pane` 扫描所有窗口
5. [ ] WaitDetector 扩展 `detect_in_pane()` 检测模式
6. [ ] 黑名单命令仍需人工确认（保持原有逻辑）

### 6.2 质量验收

7. [ ] 测试覆盖率 > 80%
8. [ ] 所有现有测试通过
9. [ ] 无"预期失败"的测试
10. [ ] tmux 不可用时测试跳过（不失败）

### 6.3 兼容性验收

11. [ ] `swarm down` 正确清理 tmux session
12. [ ] `swarm status` 仍显示任务状态
13. [ ] 任务锁机制正常工作
14. [ ] status.log 保持 JSONL 格式（无破坏性变更）

---

## 七、测试规范

### 7.1 tmux 依赖测试模板

所有涉及 tmux 的测试必须满足以下模板：

```python
import pytest
import shutil
import libtmux

# 1. 检查 tmux 可用性
tmux_available = shutil.which("tmux") is not None
pytestmark = pytest.mark.skipif(
    not tmux_available,
    reason="tmux not installed"
)

# 2. fixture 中清理 session
@pytest.fixture
def temp_session():
    server = libtmux.Server()
    session = server.new_session(session_name="test-xxx", attach=False)
    yield session
    session.kill_session()  # 必须清理
```

### 7.2 不包含的测试

- 不包含需要真实 tmux session 但无法清理的测试
- 不包含"预期失败"的测试
- 不包含依赖外部服务（如 SSH）的测试
- **不包含 `--json` 参数测试**（本计划不实现该功能）

---

## 八、风险与缓解

| 风险 | 严重性 | 缓解措施 |
|:-----|:------:|:---------|
| capture-pane 性能问题 | 中 | 使用 `-S -30` 限制行数 |
| tmux 不可用 | 低 | 功能静默跳过，显示 warning |
| 窗口不存在 | 低 | 添加异常处理，返回空字符串 |
| libtmux 连接失败 | 低 | 异常捕获，返回空结果 |

---

*文档版本: v1.1-20260201-rev3*
*基于：AI Swarm v1.0 + 参考文档 v1.0*
*测试文件数：17 个*
