# v1.2 Claude Code CLI 多窗口计划

**Date:** 2026-02-01
**Goal:** 在 TMUX 中看到 4 个 Claude Code CLI 交互窗口（1 Master + 3 Worker）

---

## 发现现状

### 已有的基础设施（v1.0/v1.1）

| 组件 | 状态 | 说明 |
|------|------|------|
| tmux 集成层 | ✅ | TmuxSwarmManager 支持窗口/窗格管理 |
| 共享状态目录 | ✅ | /tmp/ai_swarm/ 目录结构 |
| Master 协调 | ✅ | MasterScanner, AutoRescuer, MasterDispatcher |
| CLI 工具 | ✅ | swarm init/up/master/worker/status/down |
| --panes 状态查看 | ✅ | 可查看 tmux 窗口快照 |

### 需要新增的部分

| 缺失项 | 说明 |
|--------|------|
| 4 窗口启动脚本 | 一键创建 master + 3 worker 窗口 |
| Claude CLI 启动 | 每个窗口启动 claude command |
| 简单通信协议 | send-keys / capture-pane 交互 |

---

## 实施步骤

### Step 1: 创建 4 窗口启动脚本

```bash
# run_claude_swarm.sh
#!/bin/bash

# 检查 claude CLI 是否可用
command -v claude >/dev/null 2>&1 || {
    echo "Error: claude CLI not found. Please install Claude Code first."
    exit 1
}

SESSION_NAME="swarm-claude-$(date +%s)"

# 创建 tmux 会话（使用 -n master 让第 0 个窗口命名为 master）
tmux new-session -d -s "$SESSION_NAME" -x 120 -y 40 -n master

# 只创建 3 个 worker 窗口（master 窗口已由 new-session 创建）
tmux new-window -t "$SESSION_NAME" -n "worker-0"
tmux new-window -t "$SESSION_NAME" -n "worker-1"
tmux new-window -t "$SESSION_NAME" -n "worker-2"

# 启动 Master（第 0 个窗口）
tmux send-keys -t "$SESSION_NAME:master" "cd /home/user/projects/AAA/swarm" C-m
# [可选] 若使用虚拟环境: tmux send-keys -t "$SESSION_NAME:master" "source .venv/bin/activate" C-m
tmux send-keys -t "$SESSION_NAME:master" "claude" C-m

# 启动 Worker 0
tmux send-keys -t "$SESSION_NAME:worker-0" "cd /home/user/projects/AAA/swarm" C-m
# [可选] 若使用虚拟环境: tmux send-keys -t "$SESSION_NAME:worker-0" "source .venv/bin/activate" C-m
tmux send-keys -t "$SESSION_NAME:worker-0" "claude" C-m

# 启动 Worker 1
tmux send-keys -t "$SESSION_NAME:worker-1" "cd /home/user/projects/AAA/swarm" C-m
# [可选] 若使用虚拟环境: tmux send-keys -t "$SESSION_NAME:worker-1" "source .venv/bin/activate" C-m
tmux send-keys -t "$SESSION_NAME:worker-1" "claude" C-m

# 启动 Worker 2
tmux send-keys -t "$SESSION_NAME:worker-2" "cd /home/user/projects/AAA/swarm" C-m
# [可选] 若使用虚拟环境: tmux send-keys -t "$SESSION_NAME:worker-2" "source .venv/bin/activate" C-m
tmux send-keys -t "$SESSION_NAME:worker-2" "claude" C-m

# 切换到 master 窗口
tmux select-window -t "$SESSION_NAME:master"

# 附加会话
echo "Session $SESSION_NAME created. Attaching..."
tmux attach-session -t "$SESSION_NAME"
```

### Step 2: 简单通信协议定义

**消息格式：**
```
[TYPE] [PAYLOAD]
```

**Master → Worker 消息类型：**
- `TASK <任务ID> <描述>` — 发送任务到 Worker
- `PING` — 心跳检测

**Worker → Master 消息类型：**
- `START <任务ID>` — 开始执行任务
- `DONE <任务ID>` — 任务完成
- `ERROR <任务ID> <错误信息>` — 执行出错
- `WAIT` — 需要等待/人工确认
- `HELP <问题描述>` — 请求帮助

**状态识别关键词：**
- `[DONE]` 或 `DONE` 或 `✓` → 完成
- `[ERROR]` 或 `ERROR` 或 `✗` → 错误
- `[WAIT]` 或 `WAIT` 或 `?` → 等待

### Step 3: 修改 run_claude_swarm.sh 适配实际环境

需要根据实际环境调整：
1. claude CLI 路径（可能需要 `which claude`）
2. Python 虚拟环境路径
3. 项目目录路径

### Step 4: 验证脚本

```bash
# 测试步骤
chmod +x run_claude_swarm.sh
./run_claude_swarm.sh

# 在另一个终端检查
tmux list-windows -t swarm-claude-*
# 应该看到：
# 0: master  (1 pane)
# 1: worker-0 (1 pane)
# 2: worker-1 (1 pane)
# 3: worker-2 (1 pane)
```

---

## 通信方式

**严格限制：只用 tmux send-keys / capture-pane**

| 操作 | 方法 |
|------|------|
| 发送指令到 Worker | `tmux send-keys -t session:window "message" C-m` |
| 读取 Worker 输出 | `tmux capture-pane -t session:window -p` |
| 发送指令到 Master | `tmux send-keys -t session:master "message" C-m` |
| 读取 Master 输出 | `tmux capture-pane -t session:master -p` |

---

## 验收标准

### 必须通过（Must Have）

| 标准 | 验证方法 |
|------|----------|
| 1. tmux 会话包含 4 个窗口 | `tmux list-windows -t swarm-claude-*` |
| 2. master 窗口运行 claude CLI | 进入 tmux 查看进程 |
| 3. worker-0/1/2 窗口都运行 claude CLI | 进入 tmux 查看进程 |
| 4. 4 个窗口都可以交互 | 在每个窗口按 Enter 有响应 |
| 5. 脚本可重复执行 | 多次运行不报错 |

### 锦上添花（Nice to Have）

| 标准 | 说明 |
|------|------|
| 窗口名称正确显示 | tmux 状态栏显示 master/worker-0/worker-1/worker-2 |
| 布局美观 | 4 个窗口均匀分布 |
| 有启动提示 | 启动完成时显示状态概览 |

---

## 风险与注意事项

| 风险 | 缓解措施 |
|------|----------|
| claude CLI 未安装 | 脚本启动前检查 `which claude` |
| 窗口数量错误 | 脚本中添加窗口数量验证 |
| 启动顺序问题 | 使用 sleep 简单延迟确保顺序 |
| 权限问题 | 使用当前用户运行，不使用 sudo |

---

## 不做的事情（严格约束）

- ❌ Pipeline 模式
- ❌ P2P 对等模式
- ❌ Web 状态面板
- ❌ SSH 跨机扩展
- ❌ 危险命令自动执行
- ❌ 破坏现有 v1.1 Python 后台模式

---

## 下一步

1. 执行 `run_claude_swarm.sh` 脚本
2. 验证 4 个窗口正确启动
3. 如有问题，调整脚本适配环境
4. 确认验收标准全部通过

---

*Plan created: 2026-02-01*
*Based on: /home/user/group/AI蜂群协作-tmux多Agent协作系统.md*
